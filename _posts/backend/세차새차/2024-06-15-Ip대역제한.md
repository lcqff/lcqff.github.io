---
layout: post
title: νΉμ • APIμ IP λ€μ—­ μ ν•(AOP, μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…, XFF)
author: pam
categories: μ„Έμ°¨μƒμ°¨
tags: Spring Backend μ„Έμ°¨μƒμ°¨
sidebar:
---
![μ΄μ](https://github.com/lcqff/lcqff.github.io/assets/71930280/48dd5ed0-2a07-42a1-97eb-607611c37976)

## 0. κ°μ”

μ €λ² [RabbitMQ κ²μ‹κΈ€](https://lcqff.github.io/%EC%84%B8%EC%B0%A8%EC%83%88%EC%B0%A8/2024/06/10/rabbitmq1.html)μ λΉ„μ¦μ½ κΈ°λ¥κ³Ό κ΄€λ ¨λ μ΄μμ΄λ‹¤.

μ†λ‹μ΄ λΉ„μ¦μ½μ„ ν†µν•΄ λ§¤μ¥μ— μ „ν™”λ¥Ό ν•λ©΄ λΉ„μ¦μ½μ€ μ„λ²„μ— CDR μ •λ³΄λ¥Ό μ „λ‹¬ν•΄μ£Όλ©° CDR APIλ¥Ό μ‹¤ν–‰μ‹ν‚¨λ‹¤.

μ„Έμ°¨μƒμ°¨μ—μ„λ” μ΄ CDR APIλ¥Ό ν†µν•΄ λ§¤μ¥μ ν…λΈ”λ«μ— κ³ κ°μ μ •λ³΄κ°€ ν¬ν•¨λ νμ—…μ°½μ΄ μλ™μΌλ΅ μƒμ„±λλ„λ΅ μ²λ¦¬ν•κ³  μλ‹¤. 

κ·Έλ¬λ‚ λΉ„μ¦μ½μ—μ„  ν•΄λ‹Ή CDR APIμ— λ€ν• λ³„λ„μ μΈμ¦ μ μ°¨λ¥Ό μ κ³µν•΄μ£Όμ§€ μ•μ•„ μ„λ²„μ—μ„ μ§μ ‘ λΉ„μ¦μ½ κ΄€λ ¨ APIμ— λ€ν• μ ‘κ·Όμ„ μ ν•ν•κΈ°λ΅ ν–λ‹¤. 

μ”κµ¬μ‚¬ν•­μ€ μ•„λμ™€ κ°™λ‹¤.

- **λΉ„μ¦μ½ IP λ€μ—­μ— ν¬ν•¨λλ” IPλ¥Ό κ°€μ§„ ν΄λΌμ΄μ–ΈνΈλ§** BixCallDcrController ν•μ„μ λ¨λ“  μ—”νΈν¬μΈνΈμ— μ ‘κ·Όν•  μ μλ„λ΅ ν•λ‹¤.
- μ„λ²„μ— λ“¤μ–΄μ¤λ” λ¨λ“  μ”μ²­μ΄ μ•„λ‹λΌ νΉμ • APIμ—μ„λ§ μΈμ¦μ μ°¨λ¥Ό κ±°μΉλ„λ΅ ν•λ‹¤.
- λΉ„μ¦μ½ κ΄€λ ¨ APIμ—λ§ μ‚¬μ©λλ”κ²ƒμ΄ μ•„λ‹λΌ λ²”μ©μ μΌλ΅ μ‚¬μ© κ°€λ¥ν•λ„λ΅ **μ–΄λ…Έν…μ΄μ… ν•νƒ**λ΅ κ°λ°ν•λ‹¤.


## 1. κ³ λ ¤ν• λ°©λ²•λ“¤

μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•λ” κ±΄ μ΄λ―Έ κ²°μ •λ μ‚¬ν•­μ΄κ³ , μ–΄λ–¤ λ°©μ‹μ„ μ‚¬μ©ν•΄ μΈμ¦ μ μ°¨λ¥Ό κ±°μΉ μ§€μ— λ€ν•΄ κ³ λ―Όν•΄λ΄μ•Ό ν–λ‹¤.

κ³ λ ¤ν• λ°©μ‹μΌλ΅λ” μ•„λ μ„Έκ°€μ§€κ°€ μλ‹¤.

- ν•„ν„°λ§ μ‚¬μ©
- μΈν„°μ…‰ν„° μ‚¬μ©
- AOP μ‚¬μ©

IP ν•„ν„°λ§μ— λ€ν•΄ κµ¬κΈ€λ§μ„ ν•΄λ³΄μ•μ„λ• κ°€μ¥ λ§μ΄ λ³΄μΈ λ°©μ‹μ΄ ν•„ν„°λ§μ΄μ—λκ±° κ°™λ‹¤.

### ν•„ν„°λ§

```java
@WebFilter(urlPatterns = "/targetUri/*") //λΉ„μ¦μ½ api κ²½λ΅
public class IPFilter implements Filter {	
	...
	
	@Override
	protected void doFilter(HttpServletRequest request, 
	HttpServletResponse response, FilterChain filterChain) 
		throws ServletException, IOException {
			//ν—μ©λμ§€ μ•λ” IPμΈμ§€ κ²€μ¦
		}

	...
}
```

κ·Έλ¬λ‚ ν•„ν„°λ§μ€ **μ „μ—­μ μΈ μ”μ²­**μ— λ€ν•΄ μ‚¬μ©λλ” μΈμ¦μΌλ΅, μ”κµ¬μ‚¬ν•­μ²λΌ νΉμ • μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•κ³  μλ” μ—”λ“ν¬μΈνΈμ—λ§ κ²€μ¦μ„ ν•λ„λ΅ ν•κΈ° λ¶νΈν•λ‹¤. λ³΄κΈ°μ—λ„ μμμ§€ μ•λ‹¤.

url ν¨ν„΄μ„ ν†µν•΄ ν•„ν„°λ§μ„ κ±°λ” κ²ƒμ΄ μ•„λ‹λΌ `handlerMethod`κ°€ νΉμ • μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…μ„ κ°€μ§€κ³  μλ”μ§€ ν™•μΈν•λ” λ°©μ‹μΌλ΅ μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•  μ μκ² μΌλ‚ μ΄λ° λ°©μ‹μ„ μ‚¬μ©ν•λ©΄ μ„λ²„μ— λ“¤μ–΄μ¤λ” λ¨λ“  μ”μ²­μ΄ μ΄λ¬ν• κ²€μ¦μ„ κ±°μΉκ² λλ‹¤.

> λ¬Έμ μ 
> - μ–΄λ…Έν…μ΄μ…κ³Ό ν•¨κ» μ‚¬μ©ν•κΈ° κΉλ‹¤λ΅­λ‹¤.
> - μ”κµ¬μ‚¬ν•­μ΄ μΌλ¶€ κΈ°λ¥μ— λ€ν• μΈμ¦μ μ°¨ μ¶”κ°€μΈ κ²ƒμ— λΉ„ν•΄ ν•„ν„°λ§μ€ Spring λ²”μ„ μ΄μƒμΌλ΅ μ „μ—­μ μ΄λ‹¤.

### μΈν„°μ…‰ν„°

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Autowired
    private IPFilter ipFilter;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(ipFilter)
	        //.addPathPatterns("/targetUri/*"); 
    }
}
```

```java
@Component
public class IPFilter implements HandlerInterceptor {
	@Override
	public void preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
		throws Exception {
		String clientIP = request.getRemoteAddr();
		String requestURI = request.getRequestURI();
		String controllerClassName = requestURI.split("/")[1];
		
		Class<?> controllerClass = Class.forName("com.example.controllers." + controllerClassName);
		IpBandLimiter annotation = controllerClass.getAnnotation(IpBandLimiter.class);
		// ν΄λμ¤μ μ–΄λ…Έν…μ΄μ… ν™•μΈ

		// HandlerMethod handlerMethod = (HandlerMethod) handler;
		// IpBandLimiter annotation = handlerMethod.getMethodAnnotation(IpBandLimiter.class); 
		// λ©”μ„λ“μ μ–΄λ…Έν…μ΄μ… ν™•μΈ
		
		if (annotation != null) {
			String[] allowedIPs = annotation.allowedIps();
			// IP κ²€μ¦
		}
	}

```

ν•„ν„°λ§ λ‹¤μμΌλ΅λ” μΈν„°μ…‰ν„°λ¥Ό μƒκ°ν–λ‹¤. λ‹¤λ¥Έ ν”„λ΅μ νΈμ—μ„λ” νΉμ • uri ν•μ„μ μ—”λ“ν¬μΈνΈμ— μ ‘μ†ν•λ” κ²½μ° μ‚¬μ©μμ μ¶μ„ μ •λ³΄λ¥Ό μ—…λ°μ΄νΈ ν•κΈ° μ„ν•΄ μΈν„°μ…‰ν„°λ¥Ό μ‚¬μ©ν–μ—λ‹¤. 

> λ¬Έμ μ 
> - λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•λ©΄ ν΄λμ¤λ‚ λ©”μ„λ“μ— νΉμ • μ–΄λ…Έν…μ΄μ…μ΄ λ¶™μ–΄μλ”μ§€ ν™•μΈν•κΈ°λ” μ–΄λ µμ§€ μ•λ‹¤.
> - νΈμ¶ν• λ©”μ„λ“μ— νΉμ • μ–΄λ…Έν…μ΄μ…μ΄ ν¬ν•¨λΌμλ”μ§€ ν™•μΈν•λ” κ²ƒλ„ μ–΄λ µμ§€ μ•λ‹¤.
> - κ·Έλ¬λ‚ μ–΄λ–¤ μ—”λ“ν¬μΈνΈκ°€ μ–΄λ ν΄λμ¤μ— ν¬ν•¨λΌμλ”μ§€ ν™•μΈν•κΈ°λ” μ–΄λ µλ‹¤.

λ¬Όλ΅  ν•΄λ‹Ή μΈν„°μ…‰ν„°κ°€ ν•„μ”ν• λ¨λ“  λ©”μ„λ“μ— μΌμΌμ΄ μ–΄λ…Έν…μ΄μ…μ„ λ¶™μΈλ‹¤λ©΄ μ„ λ¬Έμ λ¥Ό ν•΄κ²°ν•  μλ” μμΌλ‚ λ‚λ” **ν΄λμ¤μ— λ¶™μ€ μ–΄λ…Έν…μ΄μ…μ΄ ν΄λμ¤ ν•μ„μ λ¨λ“  λ©”μ„λ“μ— μ μ©λκΈΈ μ›ν–λ‹¤**.

### ν•„ν„° vs μΈν„°μ…‰ν„°

![ν•„ν„°μΈν„°μ…‰ν„°](https://github.com/lcqff/lcqff.github.io/assets/71930280/cc4e4452-e263-476e-be40-b07ed9d0eac7)
ν•„ν„°

- Spring μ»¨ν…μ¤νΈ μ™Έλ¶€μ— μλ” web μ»¨ν…μ¤νΈμ—μ„ λ™μ‘
- Springλ³΄λ‹¤ ν° λ²”μ„μ μ”μ²­(κ³µν†µμ μΈ λ³΄μ•, λ΅κΉ…, μ”μ²­ μΈμ½”λ”© μ„¤μ • λ“±)μ— λ€ν•΄ μ²λ¦¬

μΈν„°μ…‰ν„°

- Spring μ»¨ν…μ¤νΈμ—μ„ λ™μ‘
- Springκ³Ό κ΄€λ ¨λ μ”μ²­(μ»¨νΈλ΅¤λ¬ νΈμ¶ μ „ν›„μ λ΅μ§ μ²λ¦¬ λ“±)μ— λ€ν•΄ μ²λ¦¬


### AOP

μµμΆ…μ μΌλ΅λ” **AOP**λ¥Ό μ‚¬μ©ν•λ” κ²ƒμΌλ΅ κ²°μ •ν–λ‹¤. λ¬΄μ—‡λ³΄λ‹¤ μ£Όμ–΄μ§„ μ”κµ¬μ‚¬ν•­μ— λ”°λΌ κ°λ°ν•κΈ°μ— μ μ ν–κΈ° λ•λ¬Έμ΄λ‹¤.

μ”κµ¬μ‚¬ν•­μ€ BizCallController ν•μ„μ λ¨λ“  μ—”λ“ν¬μΈνΈλ¥Ό νƒ€κ²μΌλ΅ ν•κΈ°μ— λ‚λ” κ° λ©”μ„λ“λ§λ‹¤ μ–΄λ…Έν…μ΄μ…μ„ λ¶™μ΄κΈ° λ³΄λ‹¤λ” <blue>μ»¨νΈλ΅¤λ¬μ— λ¶™μ€ μ–΄λ…Έν…μ΄μ…μ΄ ν•μ„ λ©”μ„λ“μ— λ¨λ‘ μ μ©λκΈΈ λ°”λ¬λ‹¤.</blue> 

μΈν„°μ…‰ν„°λ¥Ό μ‚¬μ©ν•λ©΄ λ©”μ„λ“ μμ²΄μ— λ¶™μ–΄μλ” μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…μ μ΅΄μ¬ μ—¬λ¶€λ” ν™•μΈν•  μ μμΌλ‚ ν•΄λ‹Ή μ—”λ“ν¬μΈνΈκ°€ μ–΄λ–¤ ν΄λμ¤μ μ—”λ“ν¬μΈνΈμΈμ§€ μ• μ μ—†μ–΄ ν΄λμ¤μ—λ§ μ–΄λ…Έν…μ΄μ…μ„ λ¶™μ΄λ” μ‹μΌλ΅ μ‚¬μ©μ€ λ¶κ°€λ¥ν–λ‹¤.


κ·Έλ¬λ‚ AOPμ μ–΄λ“λ°”μ΄μ¤λ¥Ό μ‚¬μ©ν•λ©΄ μ„ λ¬Έμ λ¥Ό κΉ”λ”ν•κ² ν•΄κ²°ν•  μ μμ—λ‹¤.

<div class="callout">
  <div>π“</div>
  <div>
    <strong>AOP(Aspect Oriented Programming, κ΄€μ  μ§€ν–¥ ν”„λ΅κ·Έλλ°)</strong><br/>
    κ΄€μ‹¬μ‚¬λ΅λ¶€ν„° ν΅λ‹¨(κ³µν†µ) κ΄€μ‹¬μ‚¬λ¥Ό λ¶„λ¦¬ν•μ—¬ κ΄€μ‹¬μ‚¬λ¥Ό λ¨λ“ν™”ν•λ” μ†ν”„νΈμ›¨μ–΄ κ°λ° ν¨λ¬λ‹¤μ„
  </div>
</div>

AOPλ” μ•„λμ™€ κ°™μ€ κ°λ…μ„ μ‚¬μ©ν•λ‹¤.

- **κ΄€μ‹¬μ‚¬(Concern)**: ν”„λ΅κ·Έλ¨μ κΈ°λ¥μ  λλ” λΉ„κΈ°λ¥μ (λ΅κΉ…, λ³΄μ•, νΈλμ­μ… κ΄€λ¦¬ λ“±) μ”κµ¬μ‚¬ν•­
- **ν΅λ‹¨ κ΄€μ‹¬μ‚¬(Cross-Cutting Concern)**: μ—¬λ¬ λ¨λ“μ—μ„ κ³µν†µμΌλ΅ μ‚¬μ©λλ” κ΄€μ‹¬μ‚¬(λ΅κΉ…, μΈμ¦ λ“±)
- **μ• μ¤ν™νΈ(Aspect)**: ν΅λ‹¨ κ΄€μ‹¬μ‚¬λ¥Ό λ¨λ“ν™”ν• κ²ƒ. ν¬μΈνΈμ»·(Pointcut)κ³Ό μ–΄λ“λ°”μ΄μ¤(Advice)λ΅ κµ¬μ„±λ¨

    - **μ΅°μΈ ν¬μΈνΈ(Join Point)**: ν”„λ΅κ·Έλ¨ μ‹¤ν–‰ μ¤‘μ νΉμ • μ‹μ  (λ©”μ„λ“ νΈμ¶, μμ™Έ λ°μƒ λ“±)
    - **ν¬μΈνΈμ»·(Pointcut)**: νΉμ • κ·μΉ™μ΄λ‚ ν‘ν„μ‹μ„ μ‚¬μ©ν•μ—¬ μ΅°μΈ ν¬μΈνΈλ¥Ό κ²°μ •
        - `@Pointcut("execution(...)")`
    - [**μ–΄λ“λ°”μ΄μ¤(Advice)**](https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/advice.html): ν¬μΈνΈμ»·μ— μν•΄ μ„ νƒλ μ΅°μΈ ν¬μΈνΈμ—μ„ μ‹¤ν–‰λλ” μ½”λ“
        - `Before`, `After`, `Around` λ“±
    - [**PointCut Designator (PCD)**](https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/pointcuts.html#aop-pointcuts-designators): ν΅λ‹¨ κ΄€μ‹¬μ‚¬κ°€ μ μ©λ  μ§€μ μ„ μ§€μ •ν•κΈ° μ„ν• ν‘ν„μ‹
        - `within`, `target`, `annotation,` `@within`, `@target`, `@annotation` λ“±

---

## 2. κ°λ°

### μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ… μΈν„°νμ΄μ¤

μ‚¬μ©μκ°€ μ§μ ‘ μ •μν• Annotationμ„ **`Custom Annotation`**μ΄λΌ ν•λ‹¤.

λ°λ€λ΅ @Overrie, @Deprecated, @SuppressWarnings λ“± SDKμ— λ‚΄μ¥λμ–΄ μλ” κΈ°λ³Έ Annotationμ€ **`Built-in Annotation`**μ΄λΌ λ¶€λ¥Έλ‹¤. 

<br>

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface IpBandLimiter {
	String[] allowedIps();
}
```

- `ElementType.TYPE`: ν΄λμ¤, μΈν„°νμ΄μ¤, μ—΄κ±°ν•(enum), μ• λ…Έν…μ΄μ… νƒ€μ…μ— μ μ©ν•  μ μλ‹¤.
- `ElementType.METHOD`: λ©”μ†λ“μ— μ μ©ν•  μ μλ‹¤.
- `RetentionPolicy.RUNTIME`: μ–΄λ…Έν…μ΄μ…μ μλ…μ΄ λ°νƒ€μ„κΉμ§€ μ μ§€λλ‹¤.
- `allowedIps` μ†μ„±μ„ ν†µν•΄ String νƒ€μ…μ IPλ¥Ό λ¬Έμμ—΄ λ°°μ—΄λ΅ μ…λ ¥λ°›λ”λ‹¤.

### AOP

*β€μ ‘κ·Ό κ°€λ¥ν• IP μΈμ¦β€™*μ΄λΌλ” ν΅λ‹¨ κ΄€μ‹¬μ‚¬λ¥Ό λ¨λ“ν™”ν•μ—¬ ν•λ‚μ Aspectλ΅ λ§λ“λ ¤κ³  ν•λ‹¤.

μ΄λ• μ–΄λ“λ°”μ΄μ¤λ” `Before`, PCDλ” `annotation`μΌλ΅ ν•μ—¬ **νΉμ • μ–΄λ…Έν…μ΄μ…μ΄ μ‹¤ν–‰λκΈ° μ „μ— μ—μ¤ν™νΈκ°€ μ‹¤ν–‰λ  μ μλ„λ΅** κµ¬μƒν–λ‹¤.

```java
@Slf4j
@Aspect
@Component
public class IpLimiter {

	@Before("@annotation(ipBandLimiter)")
	public void ipBandLimiter(IpBandLimiter ipBandLimiter) throws RuntimeException {
		HttpServletRequest request = ((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest();
		String clientIp = requset.getRemoteAddr(); //ν΄λΌμ΄μ–ΈνΈ IP μ¶”μ¶
		String[] allowedIPs = ipBandLimiter.allowedIps(); //μ–΄λ…Έν…μ΄μ…μ— μ •μλ μ ‘κ·Ό κ°€λ¥ IP λ©λ΅
		
		if (!isAllowedIp(clientIp, allowedIPs)) {
			log.warn("Not allowed IP (client ip = " + clientIp + ")");
			throw new ApplicationException(NOT_ALLOWED_IP_ACCESS); //ν—μ©λμ§€ μ•μ€ IPλΌλ©΄ μμ™Έλ¥Ό λ°μƒμ‹ν‚¨λ‹¤.
		}
		log.info("Allowed IP (client ip = " + clientIp + ")");
	}

	private boolean isAllowedIp(String clientIP, String[] allowedIPs) {
		return Arrays.stream(allowedIPs).anyMatch(clientIP::startsWith);
	}
}
```
<cap>IpLimiter Aspect</cap><br>

```java
@RestController
@RequestMapping("/v2/external/bizcall")
@RequiredArgsConstructor
@IpBandLimiter(allowedIps = { ... })
public class BizCallCdrController { ... }
```
<cap>μ‹¤μ  IpBandLimiter μ–΄λ…Έν…μ΄μ… μ μ©</cap><br>

#### λ¬Έμ  λ°μƒ

κ·Έλ¬λ‚ IpBandLimiter μ–΄λ…Έν…μ΄μ…μ΄ λ¶™μ€ ν΄λμ¤μ λ©”μ„λ“λ¥Ό μ‹¤ν–‰μ‹μΌλ„ IpLimiterκ°€ μ‹¤ν–‰λμ§€ μ•μ•λ‹¤β€¦ ν›„ν›„ <br>

AspectJ λ¬Έμ„λ¥Ό μ½μ–΄λ³΄λ‹ [μ•„λμ™€ κ°™μ€ μ„¤λ…](https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/pointcuts.html#aop-pointcuts-designators)μ„ λ°κ²¬ν•  μ μμ—λ‹¤. 

<br>

> `@annotation`: Limits matching to **join points** where the subject of the join point (**the method** being run in Spring AOP) has the given annotation.

<br>

λ³΄μ•„ν•λ‹ `@annotation`μ€ **λ©”μ„λ“ μμ¤€μ μ–΄λ…Έν…μ΄μ…μ—μ„λ§ μ μ©**λλ” κ²ƒ κ°™μ•λ‹¤. 

μ„ μ½”λ“μ—μ„ λ‚λ” `@ipBandLimiter`λ¥Ό λ©”μ„λ“κ°€ μ•„λ‹ ν΄λμ¤μ— μ μ©ν–μΌλ‹ <red> ν΄λμ¤ μμ¤€μ μ–΄λ…Έν…μ΄μ…μ„ μ½μ§€ λ»ν•κ³  λ©”μ„λ“μ— μ–΄λ…Έν…μ΄μ…μ΄ μ΅΄μ¬ν•μ§€ μ•λ” κ²ƒμΌλ΅ νλ‹¨ν• κ²ƒ</red>μ΄λ‹¤.

μ‹¤μ λ΅ μ–΄λ…Έν…μ΄μ…μ„ λ©”μ„λ“ μμ¤€μΌλ΅ μ®κ²Όλ”λ‹ μ μ‘λ™λμ—λ‹¤β€¦

<br>

κ·Έλ¬λ‚ λ‚λ” **ν΄λμ¤μ— μ„ μ–Έλ μ–΄λ…Έν…μ΄μ…μ΄ ν•μ„ λ©”μ„λ“μ—λ„ μ μ©λκΈΈ μ›ν•λ‹¤!** AspectJ λ¬Έμ„μ—λ” μ•„λμ™€ κ°™μ€ PCD λν• μ„¤λ…ν•κ³  μλ‹¤.

> `@within`: Limits matching to join points within types that have the given annotation (the execution of methods declared in **types with the given annotation** when using Spring AOP).

<br>

`@within`μ€ μ–΄λ…Έν…μ΄μ…μ΄ μ£Όμ–΄μ§„ μ–΄λ–¤ νƒ€μ…(ν΄λμ¤) ν•μ„μ λ©”μ„λ“μ— λ€ν•΄ μ΅°μΈ ν¬μΈνΈλ¥Ό μ ν•ν•λ‹¤. μ΄λ¥Ό μ‚¬μ©ν•λ©΄ ν΄λμ¤ ν•μ„μ λ©”μ„λ“μ—λ„ ν•΄λ‹Ή ν΄λμ¤μ— μ μ©λ μ—μ¤ν™νΈκ°€ μ‹¤ν–‰λ  κ²ƒμ΄λΌ μƒκ°ν–λ‹¤.

```java

	@Before("@within(ipBandLimiter)")
	public void ipBandLimiter(IpBandLimiter ipBandLimiter) {
		...
	}
```
<cap>PCD μμ • 1</cap><br>

μ½”λ“λ¥Ό μ„μ™€ κ°™μ΄ μμ •ν–λ”λ‹ BixCallDcrController ν•μ„μ λ©”μ„λ“λ¥Ό μ‹¤ν–‰ν•΄λ„ ipBandLimiter()κ°€ μ‹¤ν–‰λμ—λ‹¤. 

κ·Έλ¬λ‚ μ„ μ½”λ“λ” μ΄μ  *λ©”μ„λ“ μμ¤€μ μ–΄λ…Έν…μ΄μ…μ„ μ½μ§€ λ»ν•  κ²ƒ*μ΄λ‹¤(ν΄λμ¤μ—λ” μ–΄λ…Έν…μ΄μ…μ΄ μ„ μ–Έλμ§€ μ•μ•μ§€λ§, λ©”μ„λ“μ—λ” μ„ μ–Έλ κ²½μ° μ‹¤ν–‰λμ§€ μ•μ„ κ²ƒ)

λ”°λΌμ„ <red>λ©”μ„λ“μ™€ ν΄λμ¤ μμ¤€ μ–΄λ””μ— μ–΄λ…Έν…μ΄μ…μ΄ μ μ©λμ–΄λ„ μ—μ¤ν™νΈκ°€ μ‹¤ν–‰λ  μ μλ„λ΅</red> μ½”λ“λ¥Ό μ•„λμ™€ κ°™μ΄ μμ •ν–λ‹¤. 

```java
	@Before("@within(ipBandLimiter) || @annotation(ipBandLimiter)")
	public void ipBandLimiter(IpBandLimiter ipBandLimiter) {...}
```
<cap>PCD μμ • 2</cap><br>

### ν΄λΌμ΄μ–ΈνΈ Ip μ¶”μ¶

μ΄μ  μ–΄λ…Έν…μ΄μ…μ„ ν†µν• IP μ ν• μμ²΄λ” κ°€λ¥ν•΄μ΅μΌλ‚ λ¬Έμ κ°€ μλ‹¤. μ•„λμ μ„Έμ°¨μƒμ°¨ μΈν”„λΌ μΌλ¶€λ¥Ό ν™•μΈν•΄λ³΄μ.

![μΈν”„λΌ](https://github.com/lcqff/lcqff.github.io/assets/71930280/a6452f5f-e2f2-40ac-a4f9-3d7697b6d9c4)
ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ€ **ALB**λ¥Ό νƒ€κ³  μ„Έμ°¨μƒμ°¨ μ„λ²„λ΅ λ“¤μ–΄μ¤κ² λλ‹¤. 

μ΄λ ‡κ² λλ©΄ ν΄λΌμ΄μ–ΈνΈ IPλ¥Ό μ¶”μ¶ν•λ”λ° λ¬Έμ κ°€ μƒκΈ΄λ‹¤β€¦

#### X-Forwarded-For

<div class="callout">
  <div>π“</div>
  <div>
    <strong>X-Forwarded-For(XFF)</strong><br/>
    HTTP ν”„λ΅μ‹λ‚ λ΅λ“ λ°Έλ°μ„λ¥Ό ν†µν•΄ μ›Ή μ„λ²„μ— μ ‘μ†ν•λ” ν΄λΌμ΄μ–ΈνΈμ μ› IP μ£Όμ†λ¥Ό μ‹λ³„ν•λ” μ‚¬μ‹¤μƒμ ν‘μ¤€ ν—¤λ”
  </div>
</div>

μΌλ°μ μΌλ΅ ν΄λΌμ΄μ–ΈνΈμ IPκ°’μ€ `request.getRemoteAddr()`λ¥Ό ν†µν•΄ κ°€μ Έμ¬ μ μκ² μ§€λ§ μ¤‘κ°„μ— ν”„λ΅μ‹λ‚ λ΅λ“ λ°Έλ°μ„λ¥Ό κ±°μΉλ” κ²½μ°λ” λ‹¤λ¥΄λ‹¤.

ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ μ¤‘κ°„μ—μ„ νΈλν”½μ΄ ν”„λ΅μ‹λ‚ λ΅λ“ λ°Έλ°μ„λ¥Ό κ±°μΉλ” κ²½μ° μ„λ²„ μ ‘κ·Ό λ΅κ·Έμ—λ” ν΄λΌμ΄μ–ΈνΈμ IPκ°€ μ•„λ‹λΌ μ§μ „μ— κ±°μ³μ¨ νΈλν”½μ΄λ‚ λ΅λ“ λ°Έλ°μ„μ μ£Όμ†κ°€ λ‚¨κΈ° λ•λ¬Έμ΄λ‹¤.

λ”°λΌμ„ ν΄λΌμ΄μ–ΈνΈμ μ›λ IPλ¥Ό ν™•μΈν•κΈ° μ„ν•΄μ„λ” [X-Forwarded-For ν—¤λ”](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/X-Forwarded-For)λ¥Ό ν™•μΈν•΄μ•Όν•λ‹¤.

<br>

```java
X-Forwarded-For: <client>, <proxy1>, <proxy2>
```

ν΄λΌμ΄μ–ΈνΈμ μ”μ²­μ΄ λ΅λ“ λ²¨λ°μ„ Aλ¥Ό μ§€λ‚ ν›„ **X-Forwarded-Forμ κ°€μ¥ μ²«λ²μ§Έ κ°’μ€ Client Ipκ°€ λλ‹¤.**

μ΄ν›„ λ‹¤λ¥Έ ν”„λ΅μ‹λ‚ λ΅λ“ λ°Έλ°μ„ Bλ¥Ό μ§€λ‚κ² λλ‹¤λ©΄ λ΅λ“ λ²¨λ°μ„ Bμ ipκ°’μ΄ XFF ν—¤λ” λ’¤μ— μ¶”κ°€λ  κ²ƒμ΄λ‹¤.

#### μ½”λ“

```java
	@Before("@within(ipBandLimiter) || @annotation(ipBandLimiter)")
	public void ipBandLimiter(IpBandLimiter ipBandLimiter) throws RuntimeException {
		HttpServletRequest request = ((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest();
		String clientIp = extractClientIp(request);
		...
	}

	private String extractClientIp(HttpServletRequest request) {
		String xffIps = request.getHeader("X-Forwarded-For");
		if (xffIps != null) {
			return xffIps.split(",")[0];
		}
		throw new ApplicationException(NOT_ALLOWED_IP_ACCESS);
	}
```

XFF ν—¤λ”μ κ°€μ¥ μ²«λ²μ§Έ κ°’(clientIp) κ°€μ Έμ¤λ„λ΅ μ½”λ“λ¥Ό μ‘μ„±ν–λ‹¤. λ§μΌ XFFν—¤λ”κ°€ μ΅΄μ¬ν•μ§€ μ•λ”λ‹¤λ©΄ λ΅λ“ λ²¨λ°μ„λ¥Ό κ±°μ³μ¨ μ”μ²­μ΄ μ•„λ‹λ―€λ΅, μ •μƒμ μΈ μ”μ²­μΌλ΅ νλ‹¨ν•μ§€ μ•μ•„ μμ™Έλ¥Ό λ°μƒμ‹ν‚¨λ‹¤.

### ν…μ¤νΈ μ½”λ“

```java
@SpringBootTest
@Transactional
public class IpLimiterTest {

	@Autowired
	private BizCallCdrController bizCallCDrController;
	@Autowired
	private StoreRepository storeRepository;
	@Autowired
	private MemberRepository memberRepository;
	@Autowired
	private StoreTestHelper storeTestHelper;

	@Test
	@DisplayName("ν—μ©λμ§€ μ•μ€ ipλ” νƒ€κ²μ— μ ‘κ·Όν•  μ μ—†λ‹¤.")
	public void ν—μ©λμ§€_μ•μ€_ipλ”_νƒ€κ²μ—_μ ‘κ·Όν• _μ_μ—†λ‹¤() throws Exception {
		//given
		MockHttpServletRequest request = new MockHttpServletRequest();
		String notAllowedIp = "197.2.72.178";
		request.addHeader("X-Forwarded-For", notAllowedIp);
		RequestContextHolder.setRequestAttributes(new ServletRequestAttributes(request));
		Store store = storeTestHelper.makeStaticRunningStore();
		memberRepository.save(store.getOwner());
		storeRepository.save(store);

		// when & then
		assertThrows(ApplicationException.class,
			() -> bizCallCDrController.cdrCallInboundInit("01", "20200202020202", "000-0000-0000", store.getTel(),
				"111-1111-1111", "memo", "memo2"));
	}

	@Test
	@DisplayName("ν—μ©λ ipλ” νƒ€κ²μ— μ ‘κ·Όν•  μ μλ‹¤.")
	public void ν—μ©λ_ipλ”_νƒ€κ²μ—_μ ‘κ·Όν• _μ_μλ‹¤() throws Exception {
		//given
		MockHttpServletRequest request = new MockHttpServletRequest();
		String allowedIp = "210.109.108.133";
		request.addHeader("X-Forwarded-For", allowedIp);
		RequestContextHolder.setRequestAttributes(new ServletRequestAttributes(request));
		Store store = storeTestHelper.makeStaticRunningStore();
		memberRepository.save(store.getOwner());
		storeRepository.save(store);

		//when & then
		assertDoesNotThrow(
			() -> bizCallCDrController.cdrCallInboundInit("01", "20200202020202", "000-0000-0000", store.getTel(),
				"111-1111-1111", "memo", "memo2"));
	}
}
```

κ°„λ‹¨ν• ν…μ¤νΈ μ½”λ“λ¥Ό μ‘μ„±ν–λ‹¤.

## 3. μ¶”κ°€ κ³ λ ¤ μ‚¬ν•­

### XFF ν—¤λ” μ΅°μ‘

![λ¦¬λ·°](https://github.com/lcqff/lcqff.github.io/assets/71930280/4ddc01d7-d904-4fae-a0e4-f0ae89c10dec)

ν”„λ΅ νΈ+λ°±μ—”λ“ μ‘μ—…μ„ ν•μ‹λ” μ‘μ—…μλ¶„μ—κ² μ„μ™€ κ°™μ€ λ¦¬λ·°κ°€ λ‹¬λ Έλ‹¤.

μ΄λ΄μκ°€.. μ½”λ“λ¥Ό μ‘μ„±ν• λ•λ” μƒκ°ν•΄λ³Έμ  μ—†λ λ¬Έμ μ€λ‹¤. μ‹¤λ¬΄ κ°λ°μλ“¤μ€ λ‹¤μ–‘ν• κ°€λ¥μ„±μ„ λ– μ¬λ¦΄μ μκµ¬λ‚ μ‹¶μ—λ‹¤.

λ¦¬λ·°κ°€ λ‹¬λ¦° ν›„ ν΄λΌμ΄μ–ΈνΈμ XFF ν—¤λ” μ΅°μ‘ κ°€λ¥μ„±μ— λ€ν•΄ μ•μ•„λ΄¤λ‹¤.

#### Append

AWS λ¬Έμ„μ—μ„ ALB μ„¤μ •μ— κ΄€ν• λ¬Έμ„λ¥Ό μ°Ύμ„ μ μμ—λ‹¤.


![image](https://github.com/lcqff/lcqff.github.io/assets/71930280/3b16436d-6b05-4c64-86c4-5ddf10466743)
<cap>https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/application-load-balancers.html</cap><br>

λ΅λ“ λ²¨λ°μ„μ `xff_header_processing.mode`λ” κΈ°λ³Έμ μΌλ΅ `Append`λ΅ μ„¤μ •λμ–΄ μλ‹¤. 

λ§μΌ ν΄λΌμ΄μ–ΈνΈκ°€ μ”μ²­μ„ μ΅°μ‘ν•μ—¬ μ”μ²­μ— μ΅°μ‘λ IPλ¥Ό κ°€μ§€λ” XFFν—¤λ”λ¥Ό μ¶”κ°€ν•΄ μ „μ†΅ν•λ‹¤λ©΄ λ΅λ“ λ²¨λ°μ„λ” <red>μ΅°μ‘λ IPλ¥Ό μ μ§€ν• μ±„ XFF ν—¤λ” λ§μ§€λ§‰μ— client Ipλ¥Ό λ§λ¶™μ΄κ² λ  κ²ƒ</red>μ΄λ‹¤.

`Preserve`λ” μ”μ²­μ— λ‹΄κΈ΄ XFFν—¤λ”μ— κ°’μ„ μ¶”κ°€ν•μ§€ μ•κ³  κ·Έλ€λ΅ μ μ§€ν•λ” μ„¤μ •μ΄κ³  `Remove`λ” μ•„μ μ”μ²­μ—μ„ XFFν—¤λ”λ¥Ό  μ κ±°ν•΄λ²„λ¦¬λ” μ„¤μ •μ΄λ‹¤. XFFν—¤λ”μ κ°’μ„ μ•„μ κµμ²΄ν•λ” μ„¤μ •μ€ μ΅΄μ¬ν•μ§€ μ•λ” λ“― ν•λ‹¤.

μ΄λ ‡κ² λλ©΄ λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤. μ‚¬μ©μκ°€ XFFν—¤λ”μ— κ°’μ„ μ¶”κ°€ν•΄μ„ μ „μ†΅ν•λ©΄ μ„λ²„λ” **μ§„μ§ Client Ipκ°€  XFF ν—¤λ”μ μ–΄λ μ„μΉμ— μ΅΄μ¬ν•λ”μ§€ μ• μ μ—†λ‹¤**λ” μ μ΄λ‹¤.

 

#### **set_real_ip_from**

μ„ λ¬Έμ λ” [nginx μ„¤μ •](https://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from)μ„ ν†µν•΄ ν•΄κ²°ν•  μ μλ‹¤.

> set_real_ip_from
>  - Defines trusted addresses that are known to send correct replacement addresses
>  - μ¬λ°”λ¥Έ μ£Όμ†λ¥Ό λ³΄λ‚΄λ” κ²ƒμΌλ΅ μ•λ ¤μ§„ μ‹ λΆ° κ°€λ¥ν• μ£Όμ†λ¥Ό μ •μν•λ‹¤. <br>

>real_ip_recursive
>  - If recursive search is enabled, the original client address that matches one of the trusted addresses is replaced by the last non-trusted address sent in the request header field.
>  - λ§μ•½ μ„¤μ •μ΄ μΌμ Έμλ‹¤λ©΄, μ‹ λΆ°κ°€λ¥ν• μ£Όμ†μ™€ μΌμΉν•λ” μ›λ³Έ ν΄λΌμ΄μ–ΈνΈ μ£Όμ†λ” μ”μ²­ ν—¤λ”μ— μ „μ†΅λ κ°€μ¥ λ§μ§€λ§‰μ λΉ„μ‹ λΆ° μ£Όμ†λ΅ κµμ²΄λλ‹¤.

μ†”μ§ν λ¬Έμ„λ§ λ΄μ„λ” μ΄ν•΄κ°€ μ–΄λ ¤μ› λ‹¤. [ν•΄λ‹Ή λΈ”λ΅κ·Έ κΈ€](https://letsmakemyselfprogrammer.tistory.com/99)μ΄ λ§μ€ λ„μ›€μ΄ λμ—λ‹¤.

<br>

λ¬Έμ μƒν™©μ„ κ°€μ •ν•μ—¬ μ„ μ„¤μ •μ— λ€ν•΄ μ„¤λ…μ„ ν•΄λ³΄λ ¤ ν•λ‹¤. ν΄λΌμ΄μ–ΈνΈκ°€ μ„Έμ°¨μƒμ°¨ μ„λ²„μ— μ•„λμ™€ κ°™μ€ *μ΅°μ‘λ μ”μ²­μ„ λ³΄λ‚΄λ” μƒν™©*μ„ κ°€μ •ν•λ‹¤.

```yaml
X-Forwarded-For: <λΉ„μ¦μ½ IP>
```

κ·Έλ ‡λ‹¤λ©΄ λ΅λ“ λ²¨λ°μ„λ¥Ό κ±°μ³ nginxμ— λ„λ‹¬ν• μ”μ²­μ€ Append μ„¤μ •μ— μν•΄ μ•„λμ™€ κ°™μ΄ λ°”λ€” κ²ƒμ΄λ‹¤.

```yaml
X-Forwarded-For: <λΉ„μ¦μ½ IP> <μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IP> <μ‚¬μ©ν• λ΅λ“ λ²¨λ°μ„ IP>
```

nginx μ„¤μ •μ΄ λμ–΄μμ§€ μ•λ” κ²½μ° μ„λ²„λ” XFF ν—¤λ”μ κ°€μ¥ μ²«λ²μ§Έ κ°’μΈ **\<λΉ„μ¦μ½ IP>λ¥Ό ν΄λΌμ΄μ–ΈνΈ IPλ΅ μΈμ‹**ν•κ³ , ν•΄λ‹Ή μ”μ²­μ΄ λΉ„μ¦μ½μ—μ„ μ¨ κ²ƒμ΄λΌ νλ‹¨ν•λ©° μ„λ²„μ— μ ‘κ·Όμ‹ν‚¬ κ²ƒμ΄λ‹¤. 

<br>

μ„μ™€ λ™μΌν• μƒν™©μ—μ„, μ΄λ²μ—λ” μ•„λμ™€ κ°™μ΄ nginxκ°€ μ„¤μ •λμ–΄μλ‹¤ κ°€μ •ν•μ.

```yaml
set_real_ip_from <μ‚¬μ©ν•λ” λ΅λ“ λ²¨λ°μ„ IP>
set_real_ip_from <μ‚¬μ©ν•λ” ν”„λ΅μ‹ IP>
real_ip_recursive on;
```
<cap>nginx μ„¤μ •</cap><br>

λ΅λ“ λ²¨λ°μ„λ¥Ό κ±°μ³ nginxμ— λ„λ‹¬ν• ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ€ μ΄μ „ μƒν™©κ³Ό λ™μΌν•λ‹¤.

```yaml
X-Forwarded-For: <λΉ„μ¦μ½ IP> <μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IP> <μ‚¬μ©ν• λ΅λ“ λ²¨λ°μ„ IP>
```

nginxμ— λ”°λ΅ μ„¤μ •μ΄ λμ–΄μμ§€ μ•μ„ λ•λ” κ°€μ¥ μ•μ— μλ” \<λΉ„μ¦μ½ IP>λ¥Ό ν΄λΌμ΄μ–ΈνΈ IPλ΅ μΈμ‹ν–μ§€λ§ μ΄λ²μ—λ” λ‹¤λ¥΄λ‹¤. 

\<μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IP>λ” `set_real_ip_from`μ— μ •μλ μ‹ λΆ° κ°€λ¥ν• μ£Όμ†κ°€ μ•„λ‹λ‹¤.

λ”°λΌμ„ `real_ip_recursive` μ— μν•΄ μ‹ λΆ° κ°€λ¥ν• μ£Όμ†λ΅ μ •μλ **\<μ‚¬μ©ν• λ΅λ“ λ²¨λ°μ„ IP> μ•μ— μλ”  \<μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IP>λ¥Ό μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IPλ΅ μΈμ‹**ν•λ‹¤.

<br>

κ·Έλ¬λ‚ μ„ μ„¤μ •μ„ μ•„μ§ μ μ©μ‹ν‚¤μ§„ μ•μ•λ‹¤ ^^;

λΉ„μ¦μ½ IP μ„μ΅° μμ²΄κ°€ μΉλ…μ μΈ λ³΄μ• λ¬Έμ λ¥Ό λ°μƒμ‹ν‚¤κΈ° λ³΄λ‹¤λ” μ‚¬μ¥λ‹μ΄ μΆ€ μ§μ¦λ‚λ” μ •λ„κ°€ μ „λ¶€μ΄κΈ° λ•λ¬Έμ— μ—¬κΈ°μ— μ‹κ°„μ„ μ“°κΈ° λ³΄λ‹¤λ” λ” κΈ‰ν• μ„λΉ„μ¤ κ°λ°μ„ λ¨Όμ € ν•κΈ°λ΅ ν–λ‹¤. 

### Slient fail?

μ¶”κ°€μ μΌλ΅ κ³ λ ¤ν•΄λ³Ό μ‚¬ν•­μ΄ ν•λ‚ λ” μλ‹¤.

μ§€κΈμ€ ν—μ©λμ§€ μ•μ€ IPμ—μ„ μ ‘κ·Όν•  μ‹ `NOT_ALLOWED_IP_ACCESS` μμ™Έλ¥Ό λ°ν™ν•λ”λ°, μ΄λ ‡κ² ν•΄μ»¤μ—κ² μ§μ ‘μ μΌλ΅ μμ™Έ λ°μƒ μ—¬λ¶€λ¥Ό λ³΄μ—¬μ£Όλ” κ±΄ μΆ‹μ§€ μ•λ‹¤κ³  ν•λ‹¤.

λ”°λΌμ„ ν•΄μ»¤μ μ”μ²­μ„ κ±°λ¶€ν•  μ‹μ—λ” μ‹¤μ λ΅λ” μ”μ²­μ„ κ±°λ¶€ν•λ ν΄λΌμ΄μ–ΈνΈ μƒμ—μ„λ” μ”μ²­μ΄ ν—μ©λ κ²ƒμ²λΌ λ„κ²¨μ£Όμ–΄μ•Ό ν•λ‹¤λ”λ° μ΄κ²ƒμ— λ€ν• μ •ν™•ν• λ…μΉ­μ„ λ¨λ¥΄κ² λ‹¤ (κ²€μƒ‰ν•΄λ³΄μ•μ„λ• κ°€μ¥ μ μ‚¬ν•΄λ³΄μ΄λ”λ° slient failμ΄μ—λ‹¤.)

<br>

---

> λ°°μ΄ μ : AOPλ” μ•„μ§ μ•μ•„μ•Ό ν•  λ¶€λ¶„μ΄ λ§μ€ κ²ƒ κ°™λ‹¤. ν† λΉ„μ μ¤ν”„λ§μ—μ„ AOPμ— λ€ν• λ¶€λ¶„μ„ μƒλ‹Ήν λ‘κ»κ² λ‹¤λ£¨λλ°(β€¦) κ·Έκ±Έ μ½μ–΄λ³΄λ©° κ³µλ¶€ν•κ³  ν•λ² μ •λ¦¬ν•λ” κ²ƒλ„ κ΄μ°®μ„ κ²ƒ κ°™λ‹¤.