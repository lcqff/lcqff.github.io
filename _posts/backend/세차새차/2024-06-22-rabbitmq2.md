---
layout: post
title: ì„¸ì°¨ìƒˆì°¨ ë¹„ì¦ˆì½œ ì„œë¹„ìŠ¤ ê°œë°œ (2) -RabbitMQ TTL, DLX, Retry ì ìš©
author: pam
categories: ì„¸ì°¨ìƒˆì°¨
tags: Spring Backend ì„¸ì°¨ìƒˆì°¨ aws
sidebar:
---

## 0. ê°œìš”

### ê³¼ê±° ë©”ì„¸ì§€ë¥¼ í•¨ê»˜ Consumeí•´ì˜¤ëŠ” ì˜¤ë¥˜

![image](https://github.com/lcqff/lcqff.github.io/assets/71930280/37289ba7-5693-4a78-b089-c6306602d2ef)

ì§€ë‚œë²ˆ RabbitMQ PRì„ ì˜¬ë¦° í›„ ìœ„ì™€ ê°™ì€ ë¬¸ì œê°€ ì œì˜ë˜ì—ˆë‹¤.

ìœ„ ë¬¸ì œ ìì²´ì•¼ ê°„ë‹¨í•œ ì„¤ì • ë¬¸ì œì˜€ë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ë¬¸ì œê°€ ì•„ë‹ˆë¼ë„ Queueì— ë©”ì„¸ì§€ê°€ ìŒ“ì´ëŠ” ê²ƒê³¼ ê´€ë ¨í•˜ì—¬ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆëŠ” ë¶€ë¶„ì´ ëª‡ê°€ì§€ ë³´ì˜€ë‹¤.

ë”°ë¼ì„œ RabbitMQì— `TTL`, `DLX`, `retry` ì„¤ì •ì„ ì¶”ê°€ í•˜ê¸°ë¡œ í–ˆë‹¤.

---

## 1. acknowledge-mode ì„¤ì •

ìš°ì„ ì ìœ¼ë¡œ ê°œìš”ì—ì„œ ì„¤ëª…í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ì. <br>

ìœ„ ë¬¸ì œëŠ” `acknowledge-mode` ì˜ ì„¤ì •ê³¼ ê´€ë ¨ëœ ë¬¸ì œì˜€ë‹¤.

> [listener.simple.acknowledge-mode](https://docs.spring.io/spring-amqp/api/org/springframework/amqp/core/AcknowledgeMode.html)
> 
> - `none` : ê¸°ë³¸ê°’. ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ë©”ì„¸ì§€ì— ëŒ€í•´ ackë¥¼ ì „ì†¡í•œë‹¤.
> - `auto` : ë¦¬ìŠ¤ë„ˆê°€ ì •ìƒê°’ì„ ë°˜í™˜í•˜ë©´ ackë¥¼ ì „ì†¡í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ nackë¥¼ ì „ì†¡í•œë‹¤.
> - `manual` : ë¦¬ìŠ¤ë„ˆì˜ ë°˜í™˜ê°’ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì§ì ‘ ack, nack, rejectë¥¼ ì „ì†¡í•œë‹¤.

<br>

ìœ„ ì´ìŠˆì—ì„œëŠ” `acknowledge-mode` ê°€ `manual`ë¡œ ì„¤ì •ë˜ì–´ìˆì—ˆê³ , ackë‚˜ nackë¥¼ ì „ì†¡í•˜ëŠ” ì½”ë“œê°€ ë”°ë¡œ ì‘ì„±ë˜ì–´ìˆì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— **ëª¨ë“  ë©”ì„¸ì§€ê°€ íì— ready ìƒíƒœë¡œ ë‚¨ì•„ìˆì—ˆë‹¤**. ê·¸ë˜ì„œ ì´ì „ì— ì „ì†¡ë˜ì—ˆë˜ ë©”ì„¸ì§€ê°€ ì‚¬ë¼ì§€ì§€ ì•Šê³  í•¨ê»˜ ì „ì†¡ëœ ê²ƒì´ë‹¤.

<br>

[ê°€ëŠ¥í•œ queue ë©”ì„¸ì§€ Statue](https://www.rabbitmq.com/docs/queues#message-states)ëŠ” ì´ë˜ ë‘ê°€ì§€ì´ë‹¤.

- Ready for delivery (Ready ìƒíƒœ)
- Delivered but not yetÂ [acknowledged by consumer](https://www.rabbitmq.com/docs/confirms) (ì „ì†¡ì€ ëìœ¼ë‚˜ ì•„ì§ Consumerì˜ Arkë¥¼ ë°›ì§€ ëª»í•¨)

<br>

ì •ë¦¬í•˜ìë©´

> ì•„ì§ consumeë˜ì§€ ëª»í•œ ë©”ì„¸ì§€: `Ready` ìƒíƒœë¡œ íì— ì¡´ì¬í•œë‹¤. <br>
>
> consumeë˜ê³  Ackë¥¼ ë°›ì€ ë©”ì„¸ì§€: íì—ì„œ ì œê±°ëœë‹¤. <br>
>
> consumeë˜ê³  Ackë¥¼ ë°›ì§€ ëª»í•œ ë©”ì„¸ì§€: `unack` ìƒíƒœë¡œ íì— ì¡´ì¬í•œë‹¤. <br>
>
> consumeë˜ê³  Nack(negative-ack)ë¥¼ ë°›ì€ ë©”ì„¸ì§€: ì˜µì…˜ì— ë”°ë¼ íì—ì„œ ì œê±°ë˜ê±°ë‚˜ ë‹¤ì‹œ requeueëœë‹¤.

<br>

ìœ„ ë¬¸ì œëŠ” `acknowledge-mode` ë¥¼ `none`ìœ¼ë¡œ ë°”ê¾¸ëŠ” ê²ƒìœ¼ë¡œ í•´ê²°í–ˆë‹¤.

---

## 2. TTL ì„¤ì •

[Time-To-Live and Expiration](https://www.rabbitmq.com/docs/ttl)

<div class="callout">
  <div>ğŸ“</div>
  <div>
    <strong>ğŸ’¡ TTL(Time-To-Live)</strong><br/>
    ë©”ì‹œì§€ë¥¼ íì— ë³´ê´€í•  ìˆ˜ ìˆëŠ” ê¸°ê°„
  </div>
</div>

TTL ì„¤ì •ì„ ì¶”ê°€í•˜ê¸°ë¡œ í–ˆë‹¤. TTLì´ ì„¤ì •ëœ ë©”ì„¸ì§€ëŠ” **íì— Ready ìƒíƒœë¡œ TTL ì‹œê°„ ì´ìƒ ë¨¸ë¬¼ê²Œ ë˜ë©´ ìë™ìœ¼ë¡œ ì‚­ì œ**ëœë‹¤. 

TTLì€ ë©”ì„¸ì§€ì— TTLì„ ì„¤ì •í•˜ëŠ” [Per-Message TTL](https://www.rabbitmq.com/docs/ttl#per-message-ttl-in-publishers)ê³¼ íì— TTLì„ ì„¤ì •í•˜ëŠ” [Per-Queue TTL](https://www.rabbitmq.com/docs/ttl#per-queue-message-ttl)ì´ ì¡´ì¬í•˜ëŠ”ë° ë‚˜ëŠ” Per-Message TTLì„ ì‚¬ìš©í–ˆë‹¤. íì— TTLì„ ì„¤ì •í•˜ëŠ” ê²ƒë³´ë‹¤ ë©”ì„¸ì§€ì— TTLì„ ì„¤ì •í•˜ëŠ”ê²Œ ë” ì§ê´€ì ì´ê³ , ìœ ì—°í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥í•  ê²ƒì´ë¼ ìƒê°í–ˆê¸° ë•Œë¬¸ì´ë‹¤.

<br>

í˜„ì¬ ì‘ì„±ëœ ì½”ë“œëŠ” `@RabbitListener`ë¥¼ í†µí•´ listení•˜ê³  ìˆëŠ” íì— ë©”ì„¸ì§€ê°€ ë“¤ì–´ì˜¤ëŠ” ê²½ìš° ë°”ë¡œ Consumeí•˜ë„ë¡ ì‘ì„±ë˜ ìˆì–´ ì‚¬ì‹¤ ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ëŒì•„ê°€ëŠ” ê²½ìš° íì— ë©”ì„¸ì§€ê°€ Ready ìƒíƒœë¡œ ë‚¨ì•„ìˆëŠ” ê²½ìš°ê°€ ì—†ì„ ê±°ë¼ ìƒê°ëœë‹¤.

ê·¸ëŸ¼ì—ë„ TTLì„ ì„¤ì •í•˜ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìƒí™©ì„ ê°€ì •í•œë‹¤:

- íŠ¹ì • ì¸ìŠ¤í„´ìŠ¤ê°€ ì£½ì–´ë„, RabbitMQëŠ” ì‚´ì•„ìˆê¸° ë•Œë¬¸ì— RabbitMQëŠ” ê³„ì† Queueë¡œ ë©”ì„¸ì§€ë¥¼ ì „ë‹¬í•˜ê²Œ ëœë‹¤. ë§Œì¼ ì–´ë–¤ Queueì— ë©”ì„¸ì§€ê°€ 1000ê°œ ìŒ“ì—¬ìˆëŠ” ìƒíƒœì—ì„œ ì¸ìŠ¤í„´ìŠ¤ê°€ ë˜ì‚´ì•„ ë‚œë‹¤ë©´ **íì— ìŒ“ì—¬ìˆëŠ” ë©”ì„¸ì§€ë“¤ì´ í•œë²ˆì— Consumeë˜ë©°  ë¬¸ì œê°€ ë°œìƒ**í•  ìˆ˜ ìˆë‹¤. 
- í˜„ì¬ëŠ” consumerì™€ rabbitMQê°€ ë¬¶ì—¬ìˆì§€ë§Œ, ì´í›„ **ì„œë¹„ìŠ¤ë¥¼ í™•ì¥í•˜ì—¬ ì»¨ìŠˆë¨¸ì™€ rabbitmqê°€ ë¶„ë¦¬ëì„ ë•Œ** TTLì´ í•„ìš”í•´ì§€ê²Œ ë˜ê¸°ì— ë¯¸ë¦¬ ì ìš©í•˜ëŠ” ê²ƒì´ë‹¤.
{: .box-yello}

### ì‹¤ì œ ì ìš©

```java
//ê¸°ì¡´ ì½”ë“œ
	public void sendMessage(CdrMessageDto messageDto) {
		try {
			**rabbitTemplate.convertAndSend(exchangeName, "", messageDto);**
		}  catch (Exception exception) {
			throw new ApplicationException(ApplicationError.RABBITMQ_CONNECTION_ERROR);
		}
	} 

// ë³€ê²½ëœ TTL ì„¤ì • ì½”ë“œ
	public void sendMessage(CdrMessageDto messageDto) {
		try {
			**rabbitTemplate.convertAndSend(exchangeName, "", messageDto, message -> {
				message.getMessageProperties().setExpiration(ttl); //í™˜ê²½ë³€ìˆ˜ë¡œ 30ì´ˆ ì„¤ì •
				return message; 
			});**
		} catch (Exception exception) {
			throw new ApplicationException(ApplicationError.RABBITMQ_CONNECTION_ERROR);
		}
	}
```

![image](https://github.com/lcqff/lcqff.github.io/assets/71930280/e4c4766b-ebcc-4c5d-88d9-da2a0afd4aa0)


(í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ `@RabbitListener` ì—°ê²°ì„ ëŠì–´ ë©”ì„¸ì§€ê°€ íì— Ready ìƒíƒœë¡œ ë‚¨ì•„ìˆê²Œ í–ˆë‹¤.)

ì‹¤ì œë¡œ expirationì„ 30ì´ˆë¡œ ì„¤ì •í•œ ë©”ì„¸ì§€ê°€ Ready ìƒíƒœë¡œ queueì— 30ì´ˆ ì´ìƒ ë¨¸ë¬¼ì **expired** ë˜ì–´ ì‚¬ë¼ì§„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

## 3. DLX ì„¤ì •

TTLì„ ì‚¬ìš©í•´ ì¼ì • ì‹œê°„ Ack ë˜ì§€ ì•Šê³  íì—ì„œ ë¨¸ë¬¸ ë©”ì„¸ì§€ëŠ” íì—ì„œ ì‚­ì œë˜ë„ë¡ í•˜ì˜€ë‹¤. 

ê·¸ëŸ¬ë‚˜ ì´ë ‡ê²Œ ë©”ì„¸ì§€ë¥¼ ì‚­ì œí•´ë²„ë¦¬ëŠ” ê²ƒì´ ë§ˆìŒì— ê±¸ë ¸ë‹¤. ë­”ê°€â€¦ ë³´ê´€ì„ í•´ì•¼ ì•ˆì‹¬ì´ ë ê±°ê°™ì€ ëŠë‚Œì´â€¦â€¦

ë”°ë¼ì„œ DLX(Dead Letter Exchager)ì™€ DLQ(Dead Letter Queue)ë¥¼ ìƒì„±í•˜ê¸°ë¡œ í–ˆë‹¤.

### Dead Lettering

ëŒ€ê¸°ì—´ì˜ ë©”ì‹œì§€ëŠ” [ë°ë“œ ë ˆí„°ë§](https://www.rabbitmq.com/docs/dlx)ë  ìˆ˜ ìˆë‹¤. ì¦‰, ë‹¤ìŒ ë„¤ ê°€ì§€ ì´ë²¤íŠ¸ ì¤‘ í•˜ë‚˜ê°€ ë°œìƒí•  ë•Œ **ë©”ì‹œì§€ê°€ exchangeì— republished ëœë‹¤.** 

> 1. `requeue` ë§¤ê°œë³€ìˆ˜ê°€ `false`ë¡œÂ ì„¤ì •ëœÂ `basic.reject` ë˜ëŠ” `basic.nack`ë¥¼Â ì‚¬ìš©í•˜ì—¬ ì†Œë¹„ìê°€Â ë©”ì‹œì§€ë¥¼ [negatively acknowledged](https://www.rabbitmq.com/docs/confirms) í–ˆë‹¤. 
> 2. [Per-message TTL](https://www.rabbitmq.com/docs/ttl)ë¡œ ì¸í•´ ë©”ì‹œì§€ê°€ ë§Œë£Œëë‹¤.
> 3. íì˜ [í¬ê¸° ì œí•œ](https://www.rabbitmq.com/docs/maxlength)ì„ ì´ˆê³¼í•˜ì—¬ ë©”ì‹œì§€ê°€ ì‚­ì œëë‹¤.
> 4. ë©”ì‹œì§€ê°€ [delivery-limit](https://www.rabbitmq.com/docs/quorum-queues#poison-message-handling)ë³´ë‹¤ ë” ë§ì´ ì¿¼ëŸ¼ ëŒ€ê¸°ì—´ë¡œ ë°˜í™˜ëë‹¤.

ìœ„ 4ê°€ì§€ ê²½ìš°ì— ì†í•˜ëŠ” ë©”ì„¸ì§€ë“¤ì€ **DLXì— publishë˜ì–´ DLQì— ì €ì¥**ë˜ê²Œ ëœë‹¤.

### ì‹¤ì œ ì ìš©

```java
@RequiredArgsConstructor
@Configuration
public class RabbitMqConfiguration {

	@Value("${rabbitmq.queue.name}")
	private String queueName;

	@Value("${rabbitmq.queue.dead}")
	private String deadLetterQueue;

	@Value("${rabbitmq.exchange.name}")
	private String exchangeName;

	@Value("${rabbitmq.exchange.dead}")
	private String deadLetterExchange;

	@Bean
	public Queue queue() {
		return new Queue(queueName) {{
			addArgument("x-dead-letter-exchange", deadLetterExchange);
		}}; // íì— DLXë¥¼ ì—°ê²°í•´ì¤€ë‹¤.
	}

	@Bean
	public Queue deadLetterQueue() {
		return new Queue(deadLetterQueue);
	} //DLQ

	@Bean
	public FanoutExchange fanoutExchange() {
		return new FanoutExchange(exchangeName);
	}

	@Bean
	public FanoutExchange deadLetterExchange() {
		return new FanoutExchange(deadLetterExchange);
	} //DLX

	@Bean
	public Binding binding(Queue queue, FanoutExchange fanoutExchange) {
		return BindingBuilder.bind(queue).to(fanoutExchange);
	}

	@Bean
	public Binding deadLetterbinding(Queue deadLetterQueue, FanoutExchange deadLetterExchange) {
		return BindingBuilder.bind(deadLetterQueue).to(deadLetterExchange);
	}

	@Bean
	public MessageConverter jackson2JsonMessageConverter() {
		return new Jackson2JsonMessageConverter();
	}
}
```

#### Expiredë¡œ ì¸í•œ DLQ ì´ë™

![image](https://github.com/lcqff/lcqff.github.io/assets/71930280/e4c4766b-ebcc-4c5d-88d9-da2a0afd4aa0)

TTLì´ 30ì´ˆë¡œ ì„¤ì •ëœ ë©”ì„¸ì§€ì´ë‹¤. TTLì´ ëë‚ ë™ì•ˆ Consumeë˜ì§€ ì•Šì expiredëë‹¤.

<br>

![image](https://github.com/lcqff/lcqff.github.io/assets/71930280/f6d8ecf3-4e37-4c83-86d8-f795401b2f3a)

dead queueë¥¼ í™•ì¸í•˜ì expiredëœ ë©”ì„¸ì§€ë“¤ì´ ëª¨ë‘ ì €ì¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

<br>

![image](https://github.com/lcqff/lcqff.github.io/assets/71930280/9cf988a3-99ac-4d3f-847e-102b1f897ba4)

get messageë¥¼ í†µí•´ dead queueì— ìŒ“ì¸ ë©”ì„¸ì§€ë¥¼ êº¼ë‚´ í™•ì¸í•´ë³´ì•˜ë‹¤.  expirationì´ 30ì´ˆë¡œ ì„¤ì •ëœ ë©”ì„¸ì§€ê°€ **expired ë˜ì–´ dead queueë¡œ ë“¤ì–´ì™”ìŒ**ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

#### rejectedë¡œ ì¸í•œ DLQ ì´ë™


![image](https://github.com/lcqff/lcqff.github.io/assets/71930280/12f92cc1-1e45-477d-a1db-29f2d5b53082)

ì´ë²ˆì—” consume ë˜ì—ˆìœ¼ë‚˜ Errorê°€ ë°œìƒí•˜ì—¬ dead queueë¡œ ì˜®ê²¨ì§„ ê²½ìš°ë¥¼ í…ŒìŠ¤íŠ¸ í•´ë³´ì•˜ë‹¤.

ì‚¬ì§„ì—ì„œëŠ” íì— ì•„ë¬´ ë©”ì„¸ì§€ë„ ìŒ“ì´ì§€ ì•Šì•˜ë˜ ê²ƒì²˜ëŸ¼ ë³´ì´ëŠ”ë° queueì— ë¨¸ë¬¸ ì‹œê°„ì´ ë„ˆë¬´ ì§§ì•„ì„œ ë³´ì´ì§€ ì•ŠëŠ” ê²ƒ ê°™ë‹¤. 


![image](https://github.com/lcqff/lcqff.github.io/assets/71930280/952dabf6-a9e7-4012-9b9c-abc6f3403e36)
ì´ë²ˆì—ë„ ë™ì¼í•˜ê²Œ dead queueì—ì„œ get messageë¥¼ í†µí•´ ë©”ì„¸ì§€ë¥¼ í™•ì¸í•´ë³´ë©´ **rejectedëœ ë©”ì„¸ì§€**ë€ ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## 4. Retry ì„¤ì •

ë§ˆìŒì— ë˜ ê±¸ë¦¬ëŠ” ë¶€ë¶„ì´ ìƒê²¼ë‹¤. ê±°ì˜ ëŒ€ë¶€ë¶„ì˜ ìƒí™©ì—ì„œ consumerëŠ” ì „ë‹¬ë°›ì€ ë©”ì„¸ì§€ë¥¼ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë  ê²ƒì´ë‹¤. 

ê·¸ëŸ¬ë‹ˆ ì²«ë²ˆì§¸ ì‹œë„ë§Œì— ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤ê³  ë°”ë¡œ ë©”ì„¸ì§€ë¥¼ DLXë¡œ ë³´ë‚´ê¸° ë³´ë‹¤ëŠ” **ìµœì†Œ 2~3ë²ˆ ì •ë„ëŠ” ì¬ì‹œë„**í•˜ê¸¸ ì›í–ˆë‹¤.

í•´ë‹¹ ì„¤ì •ì€ ê°„ë‹¨í•˜ë‹¤. retry ì„¤ì •ì„ trueë¡œ ì²˜ë¦¬í•˜ë©´ ëœë‹¤.

```yaml
rabbitmq:
	listener:
		simple:
		  retry:
			  enabled: true
			  initial-interval: 2s
			  max-attempts: 2
```

**`retry`**: ì†Œë¹„ìê°€ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë„ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ë©”ì‹œì§€ë¥¼ ìë™ìœ¼ë¡œ ì¬ì‹œë„í•œë‹¤. 

- `initial-interval`: retry ì‚¬ì´ì— ì£¼ì–´ì§€ëŠ” í…€
- `max-attempts`: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ (ê¸°ë³¸ê°’ 3)

<br>

![image](https://github.com/lcqff/lcqff.github.io/assets/71930280/0d9ccf5f-2a1d-4fa8-9f32-6e8cca695b45)

ìœ„ ì„¤ì •ì„ ì ìš©í•˜ê³  ì¼ë¶€ëŸ¬ ì˜ˆì™¸ë¥¼ í„°ëœ¨ë ¸ì„ ë•Œ, ë™ì¼í•œ ì˜ˆì™¸ê°€ 2ë²ˆ í„°ì§€ëŠ” ê²ƒìœ¼ë¡œ **2ë²ˆì”© ì¬ì‹œë„**ë˜ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. 

<br>

---

> ìœ„ì™€ ê°™ì´ ì‘ì—…í•˜ê¸´ í–ˆìœ¼ë‚˜ ê²°ê³¼ì ìœ¼ë¡œ DLX, DLQëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê¸°ë¡œ í–ˆë‹¤.
ë¹„ì¦ˆì½œ ë©”ì„¸ì§€ëŠ” ì˜ì›íˆ ì—†ì–´ì§€ë“  ë§ë“  ë³„ë¡œ ìƒê´€ì—†ëŠ” (ì•ˆì¤‘ìš”í•œ) ë©”ì„¸ì§€ê¸° ë•Œë¬¸ì—â€¦
> 
> 
> ê·¸ë˜ë„ ì´ë²ˆ ê¸°íšŒì— DLXë¥¼ ì‘ì—…í•˜ê³  ê³µë¶€í•  ìˆ˜ ìˆì–´ì„œ ê´œíˆ ì‘ì—…í–ˆë‹¤ëŠ” ìƒê°ì€ ì•ˆí•œë‹¤ ^-^ rabbitMQ ê³µë¶€í• ë•Œ DLXë¥¼ ì•ˆí•˜ë©´ ì•„ì‰¬ì› ì„ ê±° ê°™ë‹¤.
>