---
layout: post
title: "N+1 ë¬¸ì œ í•´ê²°"
author: pam
categories: [SOFO]
categories: [SOFO]
tags: [] 
image: https://github.com/user-attachments/assets/ca8e69c3-169f-4298-bf40-235dd08c4c56
description: "393ê°œ ì¿¼ë¦¬ë¥¼ 21ê°œë¡œ ì¤„ì´ê¸°"
featured: true
toc: true
summary: "FetchJoinê³¼ BatchSizeë¥¼ ì‚¬ìš©í•˜ì—¬ n+1 ë¬¸ì œë¥¼ ê°œì„ í–ˆë‹¤. 393ê°œì˜ ì¿¼ë¦¬ë¥¼ 21ê°œë¡œ ì¤„ì´ê³  1.5sì˜ sqltimeì„ 183msë¡œ ê°œì„ í–ˆë‹¤."


---

<br>

# N+1 ë°œìƒ

## íšŒì› ì¡°íšŒ

```json
{
  "uuid": "d48ec5cd-95aa-49f9-80ec-c74c66dfd7f2",
  "name": "íŒœ",
  "description": "",
  "following": 2,
  "follower": 0,
  "role": "ROLE_USER",
  "email": "yeonnu82g@gmail.com",
  "artistImage": "https://..."
}
```

í˜„ì¬ íšŒì› ì¡°íšŒ ì‹œ ë°˜í™˜ë˜ëŠ” ë°ì´í„°ëŠ” ìœ„ì™€ ê°™ë‹¤. í•´ë‹¹ íšŒì›ì„ Aë¼ê³  í•´ë³´ì. 

ì£¼ëª©í•´ì•¼í•˜ëŠ” ë¶€ë¶„ì€ **following**ì™€ **follower**ì´ë‹¤. íŒ”ë¡œì›Œ/íŒ”ë¡œì‰ ê¸°ëŠ¥ì€ ì´ë²ˆì— ìƒˆë¡œ ê°œë°œí•˜ê²Œ ëœ ê¸°ëŠ¥ìœ¼ë¡œ, í•´ë‹¹ í•„ë“œëŠ” Aê°€ íŒ”ë¡œìš°í•˜ëŠ” íšŒì›ê³¼ Aë¥¼ íŒ”ë¡œì‰í•˜ëŠ” íšŒì›ì˜ ìˆ˜ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤.

<br>

```java
    public static ArtistResponseDto from(Artist artist) {
        return ArtistResponseDto.builder()
                .uuid(artist.getUuid())
                .follower(artist.getFollowers().size())
                .following(artist.getFollowings().size())
                ...
                .build();
    }
```

ê°ì²´ë¥¼ DTOë¡œ ë³€í™˜í•˜ëŠ” ì •ì  íŒ©í„°ë¦¬ ë©”ì„œë“œëŠ” ìœ„ì™€ ê°™ë‹¤. 
`getFollowers()`, `getFollowings()`ì„ í†µí•´ Aì˜ íŒ”ë¡œì›Œì™€ íŒ”ë¡œì‰ì„ ì¡°íšŒí•œ í›„ ê·¸ ì½œë ‰ì…˜ ì‚¬ì´ì¦ˆë¥¼ ë°˜í™˜í•˜ëŠ” ë¡œì§ì„ ì§€ë‹Œë‹¤. (ì´ë•Œ Artistì™€ FollowëŠ” ì¼ëŒ€ë‹¤ ê´€ê³„ì´ë‹¤.)

<br>

```sql
 start transaction 
    - [driving thread] http-nio-8080-exec-3
    - param: d48ec5cd-95aa-49f9-80ec-c74c66dfd7f2
    - OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection) [2ms] -- OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection)
    - setAutoCommit(false) [0ms] -- setAutoCommit(false)
    - PRE> select a1_0.id,a1_0.uuid, .....
			     from artist a1_0 
			     where (a1_0.is_deleted = @{1}) and a1_0.uuid=? [0,'d48ec5cd-95aa-49f9-8'] 2 ms
    - RESULT-SET-FETCH #1 1 ms
    - PRE> select f1_0.follower_id,f1_0.id,f1_0.created_at,f1_0.following_id,f1_0.updated_at 
				   from follow f1_0 
				   where f1_0.follower_id=? [2] 5 ms
    - RESULT-SET-FETCH #2 0 ms
    - PRE> select f1_0.following_id,f1_0.id,f1_0.created_at,f1_0.follower_id,f1_0.updated_at 
				   from follow f1_0 
				   where f1_0.following_id=? [2] 1 ms
    - COMMIT [1ms] -- COMMIT
    - setAutoCommit(true) [0ms] -- setAutoCommit(true)
    - CLOSE [0ms] -- CLOSE
end of transaction
```

íŠ¹ì • íšŒì› Aë¥¼ ì¡°íšŒí–ˆì„ ë•Œ ë°˜í™˜ë˜ëŠ” SQLì€ ìœ„ì™€ ê°™ë‹¤. ì´ 3ê°œì˜ SQLì„ í™•ì¸í• ìˆ˜ ìˆë‹¤. 

{: .box-yello}
1. íšŒì› Aì˜ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” SQL
2. íšŒì› Aê°€ ê°€ì§„ ëª¨ë“  Follow(Following) ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” SQL
3. íšŒì› Aê°€ ê°€ì§„ ëª¨ë“  Follow(Follower) ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” SQL

<br>

```sql
start transaction 
[driving thread] http-nio-8080-exec-3
OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection) [1ms] -- OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection)
setAutoCommit(false) [0ms] -- setAutoCommit(false)
PRE> select a1_0.id,a1_0.uuid,.... 
		 from artist a1_0 
		 where (a1_0.is_deleted = @{1}) order by a1_0.created_at desc limit ?,? [0,0,10] 7 ms
RESULT-SET-FETCH #5 3 ms
PRE> select f1_0.following_id,f1_0.id,f1_0.created_at,f1_0.follower_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.following_id=? [5] 1 ms
PRE> select f1_0.follower_id,f1_0.id,f1_0.created_at,f1_0.following_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.follower_id=? [5] 1 ms
PRE> select f1_0.following_id,f1_0.id,f1_0.created_at,f1_0.follower_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.following_id=? [4] 0 ms
RESULT-SET-FETCH #1 2 ms
PRE> select f1_0.follower_id,f1_0.id,f1_0.created_at,f1_0.following_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.follower_id=? [4] 4 ms
PRE> select f1_0.following_id,f1_0.id,f1_0.created_at,f1_0.follower_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.following_id=? [3] 3 ms
RESULT-SET-FETCH #1 0 ms
PRE> select f1_0.follower_id,f1_0.id,f1_0.created_at,f1_0.following_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.follower_id=? [3] 2 ms
PRE> select f1_0.following_id,f1_0.id,f1_0.created_at,f1_0.follower_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.following_id=? [2] 0 ms
PRE> select f1_0.follower_id,f1_0.id,f1_0.created_at,f1_0.following_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.follower_id=? [2] 1 ms
RESULT-SET-FETCH #2 3 ms
PRE> select f1_0.following_id,f1_0.id,f1_0.created_at,f1_0.follower_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.following_id=? [1] 1 ms
PRE> select f1_0.follower_id,f1_0.id,f1_0.created_at,f1_0.following_id,f1_0.updated_at 
		 from follow f1_0 
		 where f1_0.follower_id=? [1] 2 ms
COMMIT [2ms] -- COMMIT
setAutoCommit(true) [0ms] -- setAutoCommit(true)
CLOSE [0ms] -- CLOSE
end of transaction 
```

ì´ë²ˆì—” íŠ¹ì • íšŒì›ì„ ì¡°íšŒí•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, **ì „ì²´ íšŒì›ì„ ì¡°íšŒí•˜ëŠ” API**ë¥¼ ì‹¤í–‰ì‹œì¼œë³´ì•˜ë‹¤. 
í˜„ì¬ ì €ì¥ëœ íšŒì›ì€ 5ëª… ë¿ì¸ë° ì´ 11ê°œì˜ SQLì´ ì‹¤í–‰ë˜ì—ˆë‹¤.

{: .box-yello}
1. ì „ì²´ íšŒì› ì¡°íšŒ SQL
2. 1ë²ˆ íšŒì›ì˜ Follower & Followingì„ ì¡°íšŒí•˜ëŠ” SQL 2ê°œ
3. 2ë²ˆ íšŒì›ì˜ Follower & Followingì„ ì¡°íšŒí•˜ëŠ” SQL 2ê°œ
4. â€¦

ìœ„ì™€ ê°™ì€ ì‹ìœ¼ë¡œ ì´ <red>N*2+1 = 11</red>ì˜ ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœ ê²ƒì´ë‹¤. 
íšŒì›ì˜ ìˆ˜ê°€ ë§ì•„ì§€ë©´ ë§ì•„ì§ˆ ìˆ˜ë¡ ë°œìƒí•˜ëŠ” ì¶”ê°€ ì¿¼ë¦¬ì˜ ì–‘ ë˜í•œ ì‹¬ê°í•´ì§„ë‹¤. 

<br>

## ì•¨ë²” ì¡°íšŒ

ì´ë³´ë‹¤ ë” ì‹¬ê°í•œ ê²½ìš°ë¥¼ ì°¾ì•„ ì´ë²ˆì—” ì•¨ë²” ëª©ë¡ ì¡°íšŒë¥¼ ì‹¤í–‰í•´ë³´ì•˜ë‹¤.
ì•„ë˜ëŠ” ì•¨ë²” ëª©ë¡ ì¡°íšŒì— ë”°ë¥¸ ê²°ê³¼ì´ë‹¤. 

```json
{
  "albumResponseDto": {
    "uuid": "5b10264b-1edf-4113-be25-502b3f05ba4f",
    "title": "tipsy",
    "description": "sbz",
    "artImage": "https://...s3.ap-northeast-2.amazonaws.com/resources/images/597959c4-bb19-4c98-bba3-1c27afd61714_tipsy.webp",
    "releaseDate": "2025-02-16"
  },
  "trackResponseDtos": [
    {
      "uuid": "1427e153-b6f0-4c34-881d-ca93a69f18bb",
      "title": "a bar song",
      "lyric": "",
      "trackUrl": "https://...s3.ap-northeast-2.amazonaws.com/resources/musics/5dd0de41-dfdf-41d8-a35a-20ab75096e73_a%20bar%20song.mp3",
      "duration": 173,
      "artUrl": "https://...s3.ap-northeast-2.amazonaws.com/resources/images/597959c4-bb19-4c98-bba3-1c27afd61714_tipsy.webp"
    }
  ],
  "artistResponseDto": {
    "uuid": "64c18fa8-f15d-4861-af55-f6d44391a639",
    "name": "ipcgrdn",
    "description": "ğŸ¦‹",
    "link1": "https://www.instagram.com/ipcgrdn",
    "link2": "",
    "following": 0,
    "follower": 0,
    "role": "ROLE_USER",
    "email": "asdf@gmail.com",
    "artistImage": "https://...s3.ap-northeast-2.amazonaws.com/resources/images/3a69b482-ae2d-4857-b8a1-dd826b32ed94_profile_pic_1.webp"
  }
}
```

ì•¨ë²” ì¡°íšŒì˜ ê²½ìš°ì—ëŠ” ì•¨ë²”ê³¼ **ì¼ëŒ€ë‹¤ ê´€ê³„ì¸ íŠ¸ë™**, ì•¨ë²”ê³¼ **ë‹¤ëŒ€ì¼ ê´€ê³„ì¸ ì•„í‹°ìŠ¤íŠ¸** ì •ë³´ê°€ í¬í•¨ëœ ë°ì´í„°ë¥¼ ë°˜í™˜í•œë‹¤.

<br>

```sql
start transaction
-    [driving thread] http-nio-8080-exec-1
-    param: 5b10264b-1edf-4113-be25-502b3f05ba4f
-    param: 0
-    param: 10
-    OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection) [0ms] -- OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection)
-    setAutoCommit(false) [0ms] -- setAutoCommit(false)
-    PRE> select a1_0.id,a1_0.uuid,... from album a1_0 
					where (a1_0.is_deleted = @{1}) and a1_0.uuid=?[0,'5b10264b-1edf-4113-b'] 9 ms
-    RESULT-SET-FETCH #1 1 ms
-    PRE> select t1_0.id,t1_0.uuid,... from track t1_0 
					where t1_0.album_id=? order by t1_0.created_at desc limit ?[8,10] 1 ms
-    RESULT-SET-FETCH #1 0 ms
-    PRE> select a1_0.id,a1_0.uuid,... from artist a1_0 
					where a1_0.id=? and (a1_0.is_deleted = @{1})[0,1] 0 ms
-    RESULT-SET-FETCH #1 0 ms
-    PRE> select f1_0.following_id,f1_0.id,f1_0.created_at,f1_0.follower_id,f1_0.updated_at 
					from follow f1_0 
					where f1_0.following_id=?[1] 0 ms
-    PRE> select f1_0.follower_id,f1_0.id,f1_0.created_at,f1_0.following_id,f1_0.updated_at 
					from follow f1_0 
					where f1_0.follower_id=?[1] 0 ms
-    COMMIT [1ms] -- COMMIT
-    setAutoCommit(true) [0ms] -- setAutoCommit(true)
-    CLOSE [0ms] -- CLOSE
end of transaction 
```

ë”°ë¼ì„œ ì•¨ë²” ì¡°íšŒ ì‹œ ë°œìƒí•˜ëŠ” SQLì€ ì´ **5ê°œ**ì´ë‹¤: ì•¨ë²” ì¡°íšŒ + (íŠ¸ë™ ì¡°íšŒ + íšŒì› ì¡°íšŒ + (íŒ”ë¡œì‰ ì¡°íšŒ + íŒ”ë¡œì›Œ ì¡°íšŒ))

ì•¨ë²” ì¡°íšŒì—ì„œ <red>íŠ¸ë™ê³¼ íšŒì›ì— ëŒ€í•œ N+1</red>ì´, íšŒì›ì—ì„œ <red>íŒ”ë¡œì‰ íŒ”ë¡œì›Œì— ëŒ€í•œ N+1</red>ì´ ë°œìƒí–ˆë‹¤.

<br>

# ì„±ëŠ¥ ì¸¡ì •(ê°œì„  ì „)

ì‹¤ë¬´ì™€ ìœ ì‚¬í•œ í™˜ê²½ êµ¬ì„±ì„ ìœ„í•´ DBì— ì´ 10ë§Œê°œì˜ ë°ì´í„°ë¥¼ ì¶”ê°€í•œ í›„ ì„±ëŠ¥ì„ ì¸¡ì •í–ˆë‹¤.  
ì„±ëŠ¥ ì¸¡ì •ê³¼ ë¶€í•˜ í…ŒìŠ¤íŠ¸ íˆ´ë¡œëŠ” ê°ê° Scouterì™€ JMeterë¥¼ ì‚¬ìš©í–ˆë‹¤.

ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒ ê²Œì‹œê¸€ì„ ì²¨ê³ í•˜ì: [DBì— ëŒ€ëŸ‰ ë°ì´í„° ì‚½ì…í•˜ê¸°](https://lcqff.github.io/massive-data/)

```sql
â–º txid    = x2upjd8qduric
â–º objName = /088efa1456d7/tomcat1
â–º thread  = http-nio-8080-exec-91
â–º endtime = 20250408 18:12:29.815
â–º elapsed = 336 ms
â–º service = /albums<GET>
â–º ipaddr=172.18.0.4, userid=-8854012464114361035
â–º cpu=0 ms, kbytes=0
â–º sqlCount=393, sqlTime=230 ms
â–º userAgent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36
â–º referer=https://soundforest.kro.kr/v1/swagger-ui/index.html
â–º group= / **
â–º profileCount=723
â–º profileSize=16446
------------------------------------------------------------------------------------------
    p#      #    	  TIME         T-GAP   CPU          CONTENTS
------------------------------------------------------------------------------------------
         [******] 18:12:29.479        0      0  start transaction 
    -    [000000] 18:12:29.479        0      0  [driving thread] http-nio-8080-exec-91
    -    [000001] 18:12:29.485        6      0  param: 0
    -    [000002] 18:12:29.485        0      0  param: 100
    -    [000003] 18:12:29.485        0      0  OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection) [0ms] -- OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection)
    -    [000004] 18:12:29.486        1      0  setAutoCommit(false) [0ms] -- setAutoCommit(false)
    -    [000005] 18:12:29.488        2      0  PRE> select a1_0.id,a1_0.art_image,a1_0.artist_id,a1_0.created_at,a1_0.description,a1_0.is_deleted,a1_0.release_date,a1_0.title,a1_0.updated_at,a1_0.uuid from album a1_0 where (a1_0.is_deleted = @{1}) order by a1_0.created_at desc limit ?,?
                                                [0,0,100] 14 ms
    -    [000006] 18:12:29.502       14      0  RESULT-SET-FETCH #100 0 ms
    -    [000007] 18:12:29.503        1      0  PRE> select count(a1_0.id) from album a1_0 where (a1_0.is_deleted = @{1})
                                                [0] 5 ms
                                                
                                                .....
```

ìœ„ëŠ” <u>ë‹¨ì¼ ì‚¬ìš©ìê°€ 100ê°œì˜ ì•¨ë²”</u>ì„ ì¡°íšŒí•˜ëŠ” ê²½ìš° ë°œìƒí•œ ì¿¼ë¦¬ì´ë‹¤.  
ì´ **393ê°œ**ì˜ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ê³ , **230ms**ì˜ sqlTimeì´ ì†Œìš”ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

<br>

```sql
â–º txid    = x4hv54q38pqbal
â–º objName = /088efa1456d7/tomcat1
â–º thread  = http-nio-8080-exec-257
â–º endtime = 20250408 18:20:30.123
â–º elapsed = 2,071 ms
â–º service = /albums<GET>
â–º ipaddr=172.18.0.4, userid=0
â–º cpu=0 ms, kbytes=0
â–º sqlCount=393, sqlTime=1,565 ms
â–º userAgent=Apache-HttpClient/4.5.14 (Java/21.0.5)
â–º group=/ **
â–º profileCount=723
â–º profileSize=16988
------------------------------------------------------------------------------------------
    p#      #    	  TIME         T-GAP   CPU          CONTENTS
------------------------------------------------------------------------------------------
         [******] 18:20:28.052        0      0  start transaction 
    -    [000000] 18:20:28.052        0      0  [driving thread] http-nio-8080-exec-257
    -    [000001] 18:20:28.082       30      0  param: 0
    -    [000002] 18:20:28.082        0      0  param: 100
    -    [000003] 18:20:28.088        6      0  OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection) [5ms] -- OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection)
    -    [000004] 18:20:28.094        6      0  setAutoCommit(false) [0ms] -- setAutoCommit(false)
    -    [000005] 18:20:28.095        1      0  PRE> select a1_0.id,a1_0.art_image,a1_0.artist_id,a1_0.created_at,a1_0.description,a1_0.is_deleted,a1_0.release_date,a1_0.title,a1_0.updated_at,a1_0.uuid from album a1_0 where (a1_0.is_deleted = @{1}) order by a1_0.created_at desc limit ?,?
                                                [0,0,100] 159 ms
    -    [000006] 18:20:28.255      160      0  RESULT-SET-FETCH #100 1 ms
    -    [000007] 18:20:28.255        0      0  PRE> select count(a1_0.id) from album a1_0 where (a1_0.is_deleted = @{1})
                                                [0] 63 ms
    -    [000008] 18:20:28.318       63      0  RESULT-SET-FETCH #1 0 ms
    -    [000009] 18:20:28.318        0      0  PRE> select t1_0.id,t1_0.album_id,t1_0.created_at,t1_0.duration,t1_0.is_deleted,t1_0.lyric,t1_0.title,t1_0.track_url,t1_0.updated_at,t1_0.uuid from track t1_0 where t1_0.album_id=? order by t1_0.created_at desc limit ?
                                                [8,10] 1 ms
                                                
                                                ......
```

ì´ë²ˆì—” <u>10ëª…ì˜ ì‚¬ìš©ìê°€ ë™ì‹œ ì ‘ì†í•œ í›„ 100ê°œì˜ ì•¨ë²”</u>ì„ ì¡°íšŒí•˜ëŠ” ê²½ìš°ë¥¼ í…ŒìŠ¤íŠ¸í–ˆë‹¤.  
**SqlTimeì´ 1.5ì´ˆ** ê°€ëŸ‰ìœ¼ë¡œ ìƒìŠ¹í–ˆë‹¤.

<br>

# ê°œì„  ë°©ë²•

## Fetch Join

```java
    @Query("SELECT a FROM Album a "
            + "JOIN FETCH a.tracks t ")
    Page<Album> findAll(Pageable pageable);
```

n+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì¥ ì˜ ì•Œë ¤ì§„ ë°©ë²•ìœ¼ë¡œëŠ” **Fetch Join**ì´ ìˆë‹¤.  
Fetch Joinì„ ì‚¬ìš©í•˜ë©´ ì¶”ê°€ì ì¸ ì¿¼ë¦¬ ì—†ì´, í•˜ë‚˜ì˜ ì¿¼ë¦¬ë§Œìœ¼ë¡œ Joiní•œ í…Œì´ë¸”ì˜ ë°ì´í„°ê¹Œì§€ ëª¨ë‘ ì¡°íšŒê°€ëŠ¥í•˜ë‹¤.


{: .box-note}
**Join vs Fetch Join**  
**Join**: ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ë‹¨ìˆœíˆ ê²°í•©í•  ë¿ ì—°ê´€ëœ ê°ì²´ë¥¼ ì¦‰ì‹œ ë¡œë”©í•˜ì§€ ì•ŠìŒ (ë”°ë¼ì„œ ì´í›„ ì—°ê´¸ ê°ì²´ ì¡°íšŒì‹œ ì¶”ê°€ ì¿¼ë¦¬ ë°œìƒ)  
**Fetch Join**: ì—°ê´€ëœ ê°ì²´ë¥¼ í•œë²ˆì˜ ì¿¼ë¦¬ë¡œ ì¦‰ì‹œ ë¡œë”©


<br>

```sql
Hibernate: 
    select
        a1_0.id,
        ...
        a1_0.uuid 
    from
        album a1_0 
    where
        (
            a1_0.is_deleted = 0
        ) 
    order by
        a1_0.created_at desc 
    limit
        ?, ?
Hibernate: 
    select
        t1_0.id,
        ...
        t1_0.uuid 
    from
        track t1_0 
    where
        t1_0.album_id=? 
    order by
        t1_0.created_at desc 
    limit
        ?
```

ê¸°ì¡´ì—ëŠ” Album ì¡°íšŒì‹œ n+1ì— ì˜í•´ Track ì¡°íšŒ ì¿¼ë¦¬ê°€ ì¶”ê°€ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆë‹¤.  
(í¸ì˜ë¥¼ ìœ„í•´ artistì™€ follow ì¿¼ë¦¬ëŠ” ì œê±°í–ˆë‹¤.)

```sql
2025-04-18T16:56:43.351+09:00  WARN 71337 --- [nio-8080-exec-1] org.hibernate.orm.query                  : HHH90003004: firstResult/maxResults specified with collection fetch; applying in memory
Hibernate: 
    selec
        a1_0.id,
        ...
        a1_0.uuid,
        t1_0.id,
        ...
        t1_0.uuid
    from
        album a1_0 
    join
        track t1_0 
            on a1_0.id=t1_0.album_id 
    where
        (
            a1_0.is_deleted = 0
        ) 
    order by
        a1_0.created_at desc
```

ê·¸ëŸ¬ë‚˜ Albumì—ì„œ Trackì„ Fetch Joiní•œ ê²½ìš° ìœ„ì™€ ê°™ì´ **í•˜ë‚˜ì˜ ì¿¼ë¦¬**ë§Œìœ¼ë¡œ Albumê³¼ Trackì˜ ì •ë³´ë¥¼ í•œêº¼ë²ˆì— ì¡°íšŒí•œë‹¤.

<br>

### Fetch Joinê³¼ í˜ì´ì§€ë„¤ì´ì…˜

ê·¸ëŸ¬ë‚˜ Fetch Joinì—ëŠ” ë¬¸ì œê°€ ìˆë‹¤. ìœ„ì—ì„œ ë³¸ ë‘ ì¿¼ë¦¬ ì¤‘ ì•¨ë²” ì¡°íšŒ ì¿¼ë¦¬ì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ì„ ë¹„êµí•´ë³´ì.

```sql
....
    order by
        a1_0.created_at desc 
    limit
        ?, ?
```

```sql
....   
    order by
        a1_0.created_at desc
```

í˜ì´ì§•ì„ í†µí•´ ì•¨ë²”ì„ ì¡°íšŒí•˜ê³  ìˆì—ˆëŠ”ë°, Fetch Joinì„ ì‚¬ìš©í•˜ë‹ˆ <red>í˜ì´ì§•ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤!</red>

ì •í™•íˆëŠ” **`OneToMany`ê´€ê³„ì—ì„œ Fetch Joinì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°** í˜ì´ì§€ë„¤ì´ì…˜ì€ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.

![Image](https://github.com/user-attachments/assets/ec069bad-d84e-4fcb-9141-0dccaffca6d0)

ì•¨ë²” ì¡°íšŒì‹œ í˜ì´ì§€ë„¤ì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ í•œ í˜ì´ì§€ë‹¹ 2ê°œì˜ ì•¨ë²”ì„ ì§€ë‹Œë‹¤ê³  ê°€ì •í•´ë³´ì.

ì•¨ë²”ì€ íŠ¸ë™ê³¼ `OneToMany` ê´€ê³„ì´ë‹¤. ì¼ë°˜ Joinì„ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•œë‹¤ë©´ ì•¨ë²” ì¡°íšŒ ì¿¼ë¦¬ì™€ í•¨ê»˜ nê°œì˜ íŠ¸ë™ ì¡°íšŒ ì¿¼ë¦¬ê°€ ìƒì„±ë  ê²ƒì´ë‹¤.

![Image](https://github.com/user-attachments/assets/03d96d0a-d758-4176-a9d7-c5ac14c06018)

ê·¸ëŸ¬ë‚˜ Fetch Joinì„ ì‚¬ìš©í•  ê²½ìš° Album ì¡°íšŒ ì¿¼ë¦¬ì™€ í•¨ê»˜ Track ë°ì´í„°ê°€ ì¡°íšŒëœë‹¤.

JPAëŠ” ì•¨ë²” ì¡°íšŒì‹œ 2ê°œì˜ ë°ì´í„°ë¥¼ í•œ í˜ì´ì§€ë¡œ ì •ì˜í•˜ê¸°ë¡œ í–ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì •í•´ì§„ ë°ì´í„°ë³´ë‹¤ í›¨ì”¬ ë§ì€ ë°ì´í„°ê°€ ë“¤ì–´ì™”ìœ¼ë¯€ë¡œ <red>ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ í˜ì´ì§•í•´ì•¼í• ì§€ ì•Œ ìˆ˜ ì—†ë‹¤.</red>

![Image](https://github.com/user-attachments/assets/1979e53c-3749-4aa7-be31-d38c1cfd6e79)

ì´ë²ˆì—” íŠ¸ë™ì„ í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ì¡°íšŒì‹œ í•œ í˜ì´ì§€ë‹¹ 3ê°œì˜ íŠ¸ë™ì„ ì§€ë‹Œë‹¤ê³  ê°€ì •í•´ë³´ì. 

íŠ¸ë™ê³¼ ì•¨ë²”ì˜ ê´€ê³„ëŠ” `ManyToOne`ì´ë‹¤. `ManyToOne`ì˜ ê²½ìš°ì—ëŠ” **Fetch Joinì„ ì‚¬ìš©í•´ë„ í˜ì´ì§•ì´ ê°€ëŠ¥**í•˜ë‹¤.

íŠ¸ë™ì—ì„œ ì•¨ë²”ì„ Fetch Joiní•œ ê²½ìš°, ì–´ì°¨í”¼ í•˜ë‚˜ì˜ íŠ¸ë™ë‹¹ í•œ ê°œì˜ ì•¨ë²”ì„ ê°€ì§€ê²Œ ë˜ë¯€ë¡œ í˜ì´ì§•ì˜ ê¸°ì¤€ì´ ëª…í™•í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

<br>
ê·¸ë ‡ë‹¤ë©´ `OneToMany` ê´€ê³„ì—ì„œ í˜ì´ì§€ë„¤ì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ì„œ, n+1 ë¬¸ì œë„ í•´ê²°í•˜ê¸° ìœ„í•´ì„  ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?

<br>

## BatchSize()

`OneToMany` ê´€ê³„ì—ì„œ í˜ì´ì§€ë„¤ì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ì„œë„ ì¶”ê°€ ì¿¼ë¦¬ë¥¼ ì¤„ì´ê³  ì‹¶ë‹¤ë©´ **BatchSize()**ë¥¼ ì‚¬ìš©í•˜ì.

```java
    @BatchSize(size = 2)
    @OneToMany(mappedBy = "album", orphanRemoval = true)
    private List<Track> tracks;
```

Album í´ë˜ìŠ¤ì˜ Track í•„ë“œì— BatchSizeë¥¼ 2ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì—ˆë‹¤. (í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì‚¬ì´ì¦ˆë¥¼ ì‘ê²Œ ì„¤ì •í–ˆë‹¤.)

```sql
Hibernate: 
    select
        a1_0.id,
        ...
        a1_0.uuid 
    from
        album a1_0 
    order by
        a1_0.created_at desc 
    limit
        ?
Hibernate: 
    select
        t1_0.album_id,
        ...
        t1_0.uuid 
    from
        track t1_0 
    where
        t1_0.album_id in (?, ?)
Hibernate: 
    select
        t1_0.album_id,
        ...
        t1_0.uuid 
    from
        track t1_0 
    where
        t1_0.album_id in (?, ?)
Hibernate: 
    select
        t1_0.album_id,
				...
        t1_0.uuid 
    from
        track t1_0 
    where
        t1_0.album_id=?
```

DBì— ì €ì¥ëœ Albumì˜ ê°œìˆ˜ê°€ 5ê°œë¼ í• ë•Œ, ì‹¤í–‰ëœ ì¿¼ë¦¬ëŠ” ì´ **4ê°œ**ì´ë‹¤: ì•¨ë²” ì¡°íšŒ + íŠ¸ë™ì¡°íšŒ + íŠ¸ë™ì¡°íšŒ + íŠ¸ë™ì¡°íšŒ

ì›ë˜ë¼ë©´ n+1ì— ì˜í•´ **n(=5)ê°œì˜ ì¶”ê°€ ì¿¼ë¦¬**ê°€ ë°œìƒí•´ì•¼í–ˆìœ¼ë‚˜, 3ê°œë°–ì— ë°œìƒí•˜ì§€ ì•Šì€ ê²ƒì´ë‹¤.

**BatchSIze()ë¥¼ ì‚¬ìš©í•˜ë©´ ì—¬ëŸ¬ê°œì˜ ì¿¼ë¦¬ë¥¼ ë¬¶ì–´ì„œ ì‹¤í–‰**í•  ìˆ˜ ìˆë‹¤. 

ìœ„ ê²½ìš°ì—ëŠ” BatchSizeë¥¼ 2ë¡œ ì„¤ì •í•˜ì—¬ ì›ë˜ ë°œìƒí–ˆì–´ì•¼ í–ˆë˜ 5ê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ 2ê°œì”© ë¬¶ì—¬ 2+2+1, ì¦‰ 3ê°œì˜ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì—ˆë‹¤.

![Image](https://github.com/user-attachments/assets/ca8e69c3-169f-4298-bf40-235dd08c4c56)

ì—¬ì „íˆ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ê¸´ í•˜ë‚˜, ì›ë˜ ë°œìƒí–ˆì–´ì•¼ í•  nê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ë¥¼ **n/{Batch size}**ë§Œí¼ ì¤„ì´ëŠ” ê²ƒìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒì„ ì´ë£¨ì–´ë‚¼ìˆ˜ ìˆë‹¤.

ë¬¼ë¡  Batch Sizeë¥¼ êµ‰ì¥íˆ í¬ê²Œ ì¡ìœ¼ë©´ ì¶”ê°€ ì¿¼ë¦¬ì˜ ìˆ˜ì•¼ ì¤„ì–´ë“¤ê² ì§€ë§Œ ê·¸ë§Œí¼ ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ë§ì•„ì ¸ ë©”ëª¨ë¦¬ì— ë¶€ë‹´ì´ ê°€ë‹ˆ Batch sizeëŠ” ë°ì´í„°ì˜ ìˆ˜ì— ë”°ë¼ ì ë‹¹íˆ ì¡°ì ˆí•˜ë„ë¡ í•˜ì.

<br>

# ê°œì„  ê²°ê³¼

```sql
Hibernate: 
    select
        a1_0.id,
        ...
        a1_0.uuid 
    from
        album a1_0 
    where
        (
            a1_0.is_deleted = 0
        ) 
    order by
        a1_0.created_at desc 
    limit
        ?, ?
Hibernate: 
    select
        t1_0.album_id,
        ...
        t1_0.uuid 
    from
        track t1_0 
    where
        t1_0.album_id=?
Hibernate: 
    select
        a1_0.id,
        ...
        a1_0.uuid 
    from
        artist a1_0 
    where
        a1_0.id=? 
        and (
            a1_0.is_deleted = 0
        )
Hibernate: 
    select
        f1_0.following_id,
        ...
        f1_0.updated_at 
    from
        follow f1_0 
    where
        f1_0.following_id=?
Hibernate: 
    select
        f1_0.follower_id,
        ...
        f1_0.updated_at 
    from
        follow f1_0 
    where
        f1_0.follower_id=?
Hibernate: 
    select
        t1_0.album_id,
        ...
        t1_0.uuid 
    from
        track t1_0 
    where
        t1_0.album_id=?
Hibernate: 
    select
        a1_0.id,
        ...
        a1_0.uuid 
    from
        artist a1_0 
    where
        a1_0.id=? 
        and (
            a1_0.is_deleted = 0
        )
Hibernate: 
    select
        f1_0.following_id,
        ...
        f1_0.updated_at 
    from
        follow f1_0 
    where
        f1_0.following_id=?
Hibernate: 
    select
        f1_0.follower_id,
        ...
        f1_0.updated_at 
    from
        follow f1_0 
    where
        f1_0.follower_id=?
```

<u>ê°œì„  ì „ ì•¨ë²” ì¡°íšŒì‹œ</u> ë°œìƒí•œ ì¿¼ë¦¬ëŠ” ìœ„ì™€ ê°™ë‹¤. ì´ ë•Œ ì•¨ë²”ì— ë‘ê°œì˜ íŠ¸ë™ì´ ìˆê³ , ë‘ íŠ¸ë™ì˜ ì•„í‹°ìŠ¤íŠ¸ê°€ ë‹¤ë¥´ë‹¤ê³  ê°€ì •í•œë‹¤.

 album ì¡°íšŒ + 2*(track ì¡°íšŒ + artist ì¡°íšŒ + follower ì¡°íšŒ + following ì¡°íšŒ) = <red>9ê°œ ì¿¼ë¦¬</red>

```java
Hibernate: 
    select
        a1_0.id,
        ...
        a1_0.uuid,
        a2_0.id,
        ...
        a2_0.uuid
    from
        album a1_0 
    join
        artist a2_0 
            on a2_0.id=a1_0.artist_id 
            and (a2_0.is_deleted = 0) 
    where
        (
            a1_0.is_deleted = 0
        ) 
    order by
        a1_0.created_at desc 
    limit
        ?
Hibernate: 
    select
        t1_0.album_id,
        ...
        t1_0.uuid 
    from
        track t1_0 
    where
        t1_0.album_id in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
Hibernate: 
    select
        f1_0.following_id,
        ...
        f1_0.updated_at 
    from
        follow f1_0 
    where
        f1_0.following_id in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
Hibernate: 
    select
        f1_0.follower_id,
        ...
        f1_0.updated_at 
    from
        follow f1_0 
    where
        f1_0.follower_id in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)

```

<u>ê°œì„  í›„</u> ë™ì¼ ìƒí™©ì—ì„œ ë°œìƒí•˜ëŠ” ì¿¼ë¦¬ëŠ” ìœ„ì•„ ê°™ë‹¤. ê°œì„  ë‚´ìš©ì€ ì•„ë˜ì™€ ê°™ë‹¤.

{: .box-yello}
artist â†’  follow (one to many) = **batch size** ì ìš©  
album â†’ artist (many to one) = **fetch join** ì ìš©  
album â†’ track (one to many) = **batch size** ì ìš©

ìœ„ì™€ ë™ì¼í•œ ìƒí™©ì—ì„œ album&artist ì¡°íšŒ + track ì¡°íšŒ + follower ì¡°íšŒ + followingì¡°íšŒ = <red>4ê°œ ì¿¼ë¦¬</red>ê°€ ë°œìƒí–ˆë‹¤. 

ê°œì„  ì „ê³¼ ë¹„êµí•˜ì—¬ **5ê°œì˜ ì¶”ê°€ì¿¼ë¦¬ê°€ ì œê±°**ë˜ì—ˆë‹¤. ì¡°íšŒí•˜ëŠ” ë°ì´í„°ì˜ ìˆ˜ê°€ ì»¤ì§ˆìˆ˜ë¡ ê°œì„  íš¨ê³¼ëŠ” ì»¤ì§ˆ ê²ƒì´ë‹¤.

<br>

# ì„±ëŠ¥ ì¸¡ì •(ê°œì„  í›„)

```sql
â–º txid    = x1kqro991h1oi6
â–º objName = /825e5c2a2716/tomcat1
â–º thread  = http-nio-8080-exec-667
â–º endtime = 20250418 23:14:12.905
â–º elapsed = 52 ms
â–º service = /albums<GET>
â–º ipaddr=172.18.0.4, userid=0
â–º cpu=0 ms, kbytes=0
â–º sqlCount=21, sqlTime=41 ms
â–º userAgent=Apache-HttpClient/4.5.14 (Java/21.0.6)
â–º group=/ **
â–º profileCount=50
â–º profileSize=2440
------------------------------------------------------------------------------------------
    p#      #    	  TIME         T-GAP   CPU          CONTENTS
------------------------------------------------------------------------------------------
         [******] 23:14:12.853        0      0  start transaction 
    -    [000000] 23:14:12.853        0      0  [driving thread] http-nio-8080-exec-667
    -    [000001] 23:14:12.854        1      0  param: 0
    -    [000002] 23:14:12.854        0      0  param: 100
    -    [000003] 23:14:12.854        0      0  OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection) [0ms] -- OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection)
    -    [000004] 23:14:12.854        0      0  setAutoCommit(false) [0ms] -- setAutoCommit(false)
    -    [000005] 23:14:12.855        1      0  PRE> select a1_0.id,a1_0.art_image,a1_0.artist_id,a2_0.id,a2_0.artist_image,a2_0.created_at,a2_0.description,a2_0.email,a2_0.is_deleted,a2_0.link1,a2_0.link2,a2_0.name,a2_0.provider,a2_0.role,a2_0.updated_at,a2_0.uuid,a1_0.created_at,a1_0.description,a1_0.is_deleted,a1_0.release_date,a1_0.title,a1_0.updated_at,a1_0.uuid from album a1_0 join artist a2_0 on a2_0.id=a1_0.artist_id and (a2_0.is_deleted = @{1}) where (a1_0.is_deleted = @{2}) order by a1_0.created_at desc limit ?
                                                [0,0,101] 32 ms
    -    [000006] 23:14:12.888       33      0  RESULT-SET-FETCH #101 1 ms
    -    [000007] 23:14:12.888        0      0  PRE> select t1_0.album_id,t1_0.id,t1_0.created_at,t1_0.duration,t1_0.is_deleted,t1_0.lyric,t1_0.title,t1_0.track_url,t1_0.updated_at,t1_0.uuid from track t1_0 where t1_0.album_id in (?,?,?,?,?,?,?,?,?,?)
                                                [8,7,4,3,2,1,1001,1002,1003,1004] 1 ms
    -    [000008] 23:14:12.889        1      0  RESULT-SET-FETCH #17 0 ms
    -    [000009] 23:14:12.889        0      0  PRE> select f1_0.following_id,f1_0.id,f1_0.created_at,f1_0.follower_id,f1_0.updated_at from follow f1_0 where f1_0.following_id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
                                                [1,2,3,11901,12130,13421,3505,18305,2481,2783,12655,5801,20731,8265,3400,3516,10606,10344,11703,2250] 0 ms
    -    [000010] 23:14:12.889        0      0  RESULT-SET-FETCH #23 0 ms
    -    [000011] 23:14:12.891        2      0  PRE> select f1_0.follower_id,f1_0.id,f1_0.created_at,f1_0.following_id,f1_0.updated_at from follow f1_0 where f1_0.follower_id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
                                                [1,2,3,11901,12130,13421,3505,18305,2481,2783,12655,5801,20731,8265,3400,3516,10606,10344,11703,2250] 0 ms
    -    [000012] 23:14:12.891        0      0  RESULT-SET-FETCH #28 0 ms
    
    ...
```

<u>ë‹¨ì¼ ì‚¬ìš©ìê°€ 100ê°œì˜ ì•¨ë²”</u>ì„ ì¡°íšŒí•˜ëŠ” ê²½ìš°ë¥¼ í…ŒìŠ¤íŠ¸ í•˜ì˜€ë‹¤.

ê°œì„  ì „ê³¼ ë¹„êµí–ˆì„ ë•Œ ë°œìƒí•˜ëŠ” ì¿¼ë¦¬ê°€ 393ê°œì—ì„œ **21ê°œ**ë¡œ ì¤„ì–´ë“¤ê³ , sqlTimeë„ 230msì—ì„œ **41ms**ë¡œ ì¤„ì–´ë“¤ì—ˆë‹¤. 

<br>

```sql
â–º txid    = z5ukk2r8dmmakg
â–º objName = /825e5c2a2716/tomcat1
â–º thread  = http-nio-8080-exec-745
â–º endtime = 20250503 17:08:32.934
â–º elapsed = 206 ms
â–º service = /albums<GET>
â–º ipaddr=172.18.0.4, userid=0
â–º cpu=0 ms, kbytes=0
â–º sqlCount=21, sqlTime=183 ms
â–º userAgent=Apache-HttpClient/4.5.14 (Java/21.0.6)
â–º group=/ **
â–º profileCount=50
â–º profileSize=2496
------------------------------------------------------------------------------------------
    p#      #    	  TIME         T-GAP   CPU          CONTENTS
------------------------------------------------------------------------------------------
         [******] 17:08:32.728        0      0  start transaction 
    -    [000000] 17:08:32.728        0      0  [driving thread] http-nio-8080-exec-745
    -    [000001] 17:08:32.730        2      0  param: 0
    -    [000002] 17:08:32.730        0      0  param: 100
    -    [000003] 17:08:32.730        0      0  OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection) [0ms] -- OPEN-DBC jdbc:mysql://soundflyer-db:3306/soundflyer (com.zaxxer.hikari.HikariDataSource#getConnection)
    -    [000004] 17:08:32.732        2      0  setAutoCommit(false) [0ms] -- setAutoCommit(false)
    -    [000005] 17:08:32.733        1      0  PRE> select a1_0.id,a1_0.art_image,a1_0.artist_id,a2_0.id,a2_0.artist_image,a2_0.created_at,a2_0.description,a2_0.email,a2_0.is_deleted,a2_0.link1,a2_0.link2,a2_0.name,a2_0.provider,a2_0.role,a2_0.updated_at,a2_0.uuid,a1_0.created_at,a1_0.description,a1_0.is_deleted,a1_0.release_date,a1_0.title,a1_0.updated_at,a1_0.uuid from album a1_0 join artist a2_0 on a2_0.id=a1_0.artist_id and (a2_0.is_deleted = @{1}) where (a1_0.is_deleted = @{2}) order by a1_0.created_at desc limit ?
                                                [0,0,101] 147 ms
    -    [000006] 17:08:32.884      151      0  RESULT-SET-FETCH #101 4 ms
    -    [000007] 17:08:32.887        3      0  PRE> select t1_0.album_id,t1_0.id,t1_0.created_at,t1_0.duration,t1_0.is_deleted,t1_0.lyric,t1_0.title,t1_0.track_url,t1_0.updated_at,t1_0.uuid from track t1_0 where t1_0.album_id in (?,?,?,?,?,?,?,?,?,?)
                                                [8,7,4,3,2,1,1001,1002,1003,1004] 0 ms
    -    [000008] 17:08:32.887        0      0  RESULT-SET-FETCH #17 0 ms
    -    [000009] 17:08:32.889        2      0  PRE> select f1_0.following_id,f1_0.id,f1_0.created_at,f1_0.follower_id,f1_0.updated_at from follow f1_0 where f1_0.following_id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
                                                [1,2,3,11901,12130,13421,3505,18305,2481,2783,12655,5801,20731,8265,3400,3516,10606,10344,11703,2250] 1 ms
    -    [000010] 17:08:32.890        1      0  RESULT-SET-FETCH #23 0 ms
    -    [000011] 17:08:32.890        0      0  PRE> select f1_0.follower_id,f1_0.id,f1_0.created_at,f1_0.following_id,f1_0.updated_at from follow f1_0 where f1_0.follower_id in (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
                                                [1,2,3,11901,12130,13421,3505,18305,2481,2783,12655,5801,20731,8265,3400,3516,10606,10344,11703,2250] 2 ms
    -    [000012] 17:08:32.892        2      0  RESULT-SET-FETCH #28 0 ms
    
    ....
```

10ëª…ì˜ ì‚¬ìš©ìê°€ ë™ì‹œ ì ‘ì†í•˜ëŠ” ê²½ìš°ë„ ë¹„êµí•´ë³´ì.

ê°œì„  í›„ sqlTimeì€ ì œì¼ ì˜¤ë˜ ê±¸ë¦° íŠ¸ëœì­ì…˜ì´ **183ms**, ì œì¼ ì ê²Œ ê±¸ë¦° íŠ¸ëœì­ì…˜ì´ **33ms**ë¡œ ê°œì„ ì „ ì„±ëŠ¥ì´ì—ˆë˜ 1,565msì— ë¹„í•´ **88%**ì˜ í–¥ìƒì„ ë³´ì˜€ë‹¤. 


<br><br><br>

ë‹¤ë§Œ ì´ê±´ ë™ì‹œ ì ‘ì†ì ìˆ˜ê°€ 10ëª…ë°–ì— ì•ˆë˜ëŠ” ê²½ìš°ì´ë‹¤â€¦

<br>

# ì¶”ê°€ ê°œì„ ì 

ëª©í‘œì˜€ë˜ â€˜ì¿¼ë¦¬ ìˆ˜ ì¤„ì´ê¸°â€™ëŠ” ë‹¬ì„±í–ˆìœ¼ë‚˜ ì‹ ê²½ì“°ì´ëŠ” ì ì´ ìˆë‹¤.

```sql
PRE> select a1_0.id,a1_0.art_image,a1_0.artist_id,a1_0.created_at,a1_0.description,a1_0.is_deleted,a1_0.release_date,a1_0.title,a1_0.updated_at,a1_0.uuid from album a1_0 where (a1_0.is_deleted = @{1}) order by a1_0.created_at desc limit ?,?
[0,0,100] 159 ms
```

ê°œì„  ì „ ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— ìš”ì²­ì„ ë³´ëƒˆì„ ë•Œ ë°œìƒí•œ sqlTimeì´ 1,565msì˜€ì„ ë•Œ ì´ ì¤‘ ì•¨ë²” ì¡°íšŒ ì¿¼ë¦¬ì— ì†Œìš”ëœ ì‹œê°„ì€ 159msì´ë‹¤.

```sql
PRE> select a1_0.id,a1_0.art_image,a1_0.artist_id,a2_0.id,a2_0.artist_image,a2_0.created_at,a2_0.description,a2_0.email,a2_0.is_deleted,a2_0.link1,a2_0.link2,a2_0.name,a2_0.provider,a2_0.role,a2_0.updated_at,a2_0.uuid,a1_0.created_at,a1_0.description,a1_0.is_deleted,a1_0.release_date,a1_0.title,a1_0.updated_at,a1_0.uuid from album a1_0 join artist a2_0 on a2_0.id=a1_0.artist_id and (a2_0.is_deleted = @{1}) where (a1_0.is_deleted = @{2}) order by a1_0.created_at desc limit ?
[0,0,101] 147 ms
```

ê°œì„  í›„ì— ë°œìƒí•œ sqlTimeì€ 183ms, ì´ ì¤‘ ì•¨ë²” ì¡°íšŒ ì¿¼ë¦¬ê°€ ì‚¬ìš©í•œ ì‹œê°„ì´ 147msë¡œ ê°œì„  ì „ê³¼ ë‹¤ë¥´ê²Œ **sqlTimeì˜ ëŒ€ë¶€ë¶„ì„ ì°¨ì§€**í•œë‹¤.

<br>

ì´ìƒí•œ ì´ì•¼ê¸°ëŠ” ì•„ë‹ˆë‹¤. ê°œì„  ì „ ì¿¼ë¦¬ëŠ” ì¿¼ë¦¬ìˆ˜ê°€ ë§ì€ ëŒ€ì‹  ê° ì¿¼ë¦¬ê°€ ë³µì¡í•˜ì§€ ì•Šì•˜ë‹¤.

ê·¸ëŸ¬ë‚˜ ê°œì„  í›„ ì¿¼ë¦¬ëŠ” ì¿¼ë¦¬ ìˆ˜ê°€ ì¤„ì–´ë“  ëŒ€ì‹ , ì•¨ë²” ì¡°íšŒ ì¿¼ë¦¬ê°€ Join+Where+Order by ì ˆë¡œ ì¸í•´ **ë³µì¡í•´ì¡Œë‹¤**. ë”°ë¼ì„œ sqlTimeì˜ ëŒ€ë¶€ë¶„ì„ ì°¨ì§€í•˜ê²Œ ëœ ê²ƒì´ë‹¤.

ê·¸ëŸ¬ë‚˜ ë¬¸ì œëŠ” ì—¬ê¸°ë¶€í„°ë‹¤. 

<br>

![Image](https://github.com/user-attachments/assets/ad49baac-351f-41b9-87d5-6dd299286bfb)
<cap>ê°œì„  ì „</cap><br>
![Image](https://github.com/user-attachments/assets/42eea1fa-cba8-43cb-b6cf-3f6984e6d716)
<cap>ê°œì„  í›„</cap><br>

ë™ì‹œ ì ‘ì† ì‚¬ìš©ì ìˆ˜ë¥¼ ëŠ˜ë¦¬ë©´ ê²°ê³¼ì ìœ¼ë¡œ í‰ê·  ì‹œê°„ì€ ëŠ˜ì–´ë‚˜ê³  TPSëŠ” ì¤„ì–´ë“ ë‹¤. 

<br>

![Image](https://github.com/user-attachments/assets/b5f671f0-97fc-4a80-a9b2-d423e60e7c24)
<cap>ê°œì„  ì „</cap><br>

![Image](https://github.com/user-attachments/assets/1472a3d5-fd01-40a8-9fad-e4f16897e5e8)
<cap>ê°œì„  í›„</cap><br>

í™•ì¸í•´ë³´ë©´ SQL Timeì´ ê±°ì˜ 2ë°° ê°€ê¹Œì´ ëŠ˜ì–´ë‚œ ê²ƒì„ í™•ì¸í• ìˆ˜ ìˆë‹¤. 

<br>

ë‚´ê°€ í•´ì„í•œ ë°”ë¡œëŠ”,

**íŠ¸ëœì­ì…˜ì´ ì ì—ˆì„ ë•Œ**: ì–´ì°¨í”¼ Connection Poolì´ ë¶€ì¡±í•˜ì§€ ì•ŠìŒ, sqlTimeì´ ì¢€ ê¸¸ë”ë¼ë„ Connection Poolì„ ëŒ€ê¸°í•˜ì§„ ì•ŠìŒ, CPU ê³¼ë¶€í™”ë„ ë¹„êµì  ì ìŒ

**íŠ¸ëœì­ì…˜ì´ ë§ì„ ë•Œ**: ë§ì€ ì–‘ì˜ íŠ¸ëœì­ì…˜ + ë³µì¡í•œ ì¿¼ë¦¬ ì¡°í•©ìœ¼ë¡œ DB ê³¼ë¶€í™” ì‹¬í•´ì§ â†’ sqlTime ì¦ê°€ â†’ cpu ê³¼ë¶€í™”ë¡œ ìš”ì²­ì§€ì—° or Connection Poolì´ ë¶€ì¡±í•œ ì™€ì¤‘ì— sqlTimeì´ ê¸¸ì–´ì„œ Connection Poolì„ ì˜¤ë˜ ë¶™ì¡ê³  ìˆìŒ â†’ Connection Pool ëŒ€ê¸°ì‹œê°„ ëŠ˜ì–´ë‚¨ â†’ ìš”ì²­ì‹œê°„ê³¼ TSPê°€ ë–¨ì–´ì§â€¦ 

ì •ë„ë¡œ ì´í•´í–ˆë‹¤.

<br>

![Image](https://github.com/user-attachments/assets/164a5f4d-78d6-4134-9f8c-3f6489dd72f5)

ê°œì„  í›„ ëŠ˜ì–´ë‚œ SQL timeì˜ ëŒ€ë¶€ë¶„ì„ ì¡ì•„ë¨¹ëŠ” ì¿¼ë¦¬ëŠ” artistì™€ albumì„ ì¡°ì¸í•œ í›„ selectí•˜ëŠ” ì¿¼ë¦¬ì´ë‹¤.

![Image](https://github.com/user-attachments/assets/0ffb7bc9-24a5-4fc6-8e3a-a4e960671df5)

Explainì„ í†µí•´ í•´ë‹¹ ì¿¼ë¦¬ë¥¼ í™•ì¸í•œ ê²°ê³¼ Tableì„ full scaní•˜ê³  ìˆê³ , ì •ë ¬ì„ ë©”ëª¨ë¦¬ë¡œ ìˆ˜í–‰í•˜ê³  ìˆë‹¤ëŠ” ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

í•´ë‹¹ ì„±ëŠ¥ ê°œì„ ì€ ì¸ë±ìŠ¤ ê²Œì‹œê¸€ì—ì„œ ì°¾ì•„ë³´ë„ë¡ í•˜ê² ë‹¤â€¦ -> https://lcqff.github.io/index/

--- 

[í•œ ê°œì˜ ë¬´ê±°ìš´ ì¿¼ë¦¬ê°€ ì—¬ëŸ¬ ê°œì˜ ê°€ë²¼ìš´ ì¿¼ë¦¬ë³´ë‹¤ í›¨ì”¬ ë” ë¹ ë¥¸ ì´ìœ ](https://medium.com/ryanjang-devnotes/%ED%95%9C-%EA%B0%9C%EC%9D%98-%EB%AC%B4%EA%B1%B0%EC%9A%B4-%EC%BF%BC%EB%A6%AC%EA%B0%80-%EC%97%AC%EB%9F%AC-%EA%B0%9C%EC%9D%98-%EA%B0%80%EB%B2%BC%EC%9A%B4-%EC%BF%BC%EB%A6%AC%EB%B3%B4%EB%8B%A4-%ED%9B%A8%EC%94%AC-%EB%8D%94-%EB%B9%A0%EB%A5%B8-%EC%9D%B4%EC%9C%A0-15a6552b5c06)