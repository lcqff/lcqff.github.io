<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>νΉμ • APIμ IP λ€μ—­ μ ν•(AOP, μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…, XFF) | Pam Tree</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>νΉμ • APIμ IP λ€μ—­ μ ν•(AOP, μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…, XFF) | Pam Tree</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="νΉμ • APIμ IP λ€μ—­ μ ν•(AOP, μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…, XFF)" />
<meta name="author" content="pam" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="νμ λ°±μ—”λ“ μ΄κ²ƒμ €κ²ƒ λ†€μ΄ν„°" />
<meta property="og:description" content="νμ λ°±μ—”λ“ μ΄κ²ƒμ €κ²ƒ λ†€μ΄ν„°" />
<link rel="canonical" href="http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" />
<meta property="og:url" content="http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" />
<meta property="og:site_name" content="Pam Tree" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-15T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="νΉμ • APIμ IP λ€μ—­ μ ν•(AOP, μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…, XFF)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"pam"},"dateModified":"2024-06-15T00:00:00+09:00","datePublished":"2024-06-15T00:00:00+09:00","description":"νμ λ°±μ—”λ“ μ΄κ²ƒμ €κ²ƒ λ†€μ΄ν„°","headline":"νΉμ • APIμ IP λ€μ—­ μ ν•(AOP, μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…, XFF)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.png"},"name":"pam"},"url":"http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logo.png" alt="Pam Tree">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="/index.html"> My Resume</a>
                </li>

                <!-- <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-wordpress/"><i class="fab fa-wordpress-simple"></i> WP Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-ghost/"><i class="fab fa-snapchat-ghost"></i> Ghost Version</a>
                </li> -->

                <li class="nav-item">
                <a target="_blank" class="nav-link" href=""><i class="fab fa-github"></i> My Github</a>
                </li>

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">Pam Tree</h1>
    <p class="lead">
        νμ λ°±μ—”λ“ μ΄κ²ƒμ €κ²ƒ λ†€μ΄ν„°
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=νΉμ • APIμ IP λ€μ—­ μ ν•(AOP, μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…, XFF)&url=http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="/assets/images/manulGaming.jpg" alt="Pam">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="https://www.wowthemes.net">Pam</a><a target="_blank" href="" class="btn follow">Follow</a>
                        <span class="author-description">Author of Mediumish, a Bootstrap Medium styled template available for WordPress, HTML, Ghost and Jekyll. You are currently previewing Jekyll template demo.</span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">νΉμ • APIμ IP λ€μ—­ μ ν•(AOP, μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…, XFF)</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/48dd5ed0-2a07-42a1-97eb-607611c37976" alt="μ΄μ" /></p>

<h2 id="0-κ°μ”">0. κ°μ”</h2>

<p>μ €λ² <a href="https://lcqff.github.io/%EC%84%B8%EC%B0%A8%EC%83%88%EC%B0%A8/2024/06/10/rabbitmq1.html">RabbitMQ κ²μ‹κΈ€</a>μ λΉ„μ¦μ½ κΈ°λ¥κ³Ό κ΄€λ ¨λ μ΄μμ΄λ‹¤.</p>

<p>μ†λ‹μ΄ λΉ„μ¦μ½μ„ ν†µν•΄ λ§¤μ¥μ— μ „ν™”λ¥Ό ν•λ©΄ λΉ„μ¦μ½μ€ μ„λ²„μ— CDR μ •λ³΄λ¥Ό μ „λ‹¬ν•΄μ£Όλ©° CDR APIλ¥Ό μ‹¤ν–‰μ‹ν‚¨λ‹¤.</p>

<p>μ„Έμ°¨μƒμ°¨μ—μ„λ” μ΄ CDR APIλ¥Ό ν†µν•΄ λ§¤μ¥μ ν…λΈ”λ«μ— κ³ κ°μ μ •λ³΄κ°€ ν¬ν•¨λ νμ—…μ°½μ΄ μλ™μΌλ΅ μƒμ„±λλ„λ΅ μ²λ¦¬ν•κ³  μλ‹¤.</p>

<p>κ·Έλ¬λ‚ λΉ„μ¦μ½μ—μ„  ν•΄λ‹Ή CDR APIμ— λ€ν• λ³„λ„μ μΈμ¦ μ μ°¨λ¥Ό μ κ³µν•΄μ£Όμ§€ μ•μ•„ μ„λ²„μ—μ„ μ§μ ‘ λΉ„μ¦μ½ κ΄€λ ¨ APIμ— λ€ν• μ ‘κ·Όμ„ μ ν•ν•κΈ°λ΅ ν–λ‹¤.</p>

<p>μ”κµ¬μ‚¬ν•­μ€ μ•„λμ™€ κ°™λ‹¤.</p>

<ul>
  <li><strong>λΉ„μ¦μ½ IP λ€μ—­μ— ν¬ν•¨λλ” IPλ¥Ό κ°€μ§„ ν΄λΌμ΄μ–ΈνΈλ§</strong> BixCallDcrController ν•μ„μ λ¨λ“  μ—”νΈν¬μΈνΈμ— μ ‘κ·Όν•  μ μλ„λ΅ ν•λ‹¤.</li>
  <li>μ„λ²„μ— λ“¤μ–΄μ¤λ” λ¨λ“  μ”μ²­μ΄ μ•„λ‹λΌ νΉμ • APIμ—μ„λ§ μΈμ¦μ μ°¨λ¥Ό κ±°μΉλ„λ΅ ν•λ‹¤.</li>
  <li>λΉ„μ¦μ½ κ΄€λ ¨ APIμ—λ§ μ‚¬μ©λλ”κ²ƒμ΄ μ•„λ‹λΌ λ²”μ©μ μΌλ΅ μ‚¬μ© κ°€λ¥ν•λ„λ΅ <strong>μ–΄λ…Έν…μ΄μ… ν•νƒ</strong>λ΅ κ°λ°ν•λ‹¤.</li>
</ul>

<h2 id="1-κ³ λ ¤ν•-λ°©λ²•λ“¤">1. κ³ λ ¤ν• λ°©λ²•λ“¤</h2>

<p>μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•λ” κ±΄ μ΄λ―Έ κ²°μ •λ μ‚¬ν•­μ΄κ³ , μ–΄λ–¤ λ°©μ‹μ„ μ‚¬μ©ν•΄ μΈμ¦ μ μ°¨λ¥Ό κ±°μΉ μ§€μ— λ€ν•΄ κ³ λ―Όν•΄λ΄μ•Ό ν–λ‹¤.</p>

<p>κ³ λ ¤ν• λ°©μ‹μΌλ΅λ” μ•„λ μ„Έκ°€μ§€κ°€ μλ‹¤.</p>

<ul>
  <li>ν•„ν„°λ§ μ‚¬μ©</li>
  <li>μΈν„°μ…‰ν„° μ‚¬μ©</li>
  <li>AOP μ‚¬μ©</li>
</ul>

<p>IP ν•„ν„°λ§μ— λ€ν•΄ κµ¬κΈ€λ§μ„ ν•΄λ³΄μ•μ„λ• κ°€μ¥ λ§μ΄ λ³΄μΈ λ°©μ‹μ΄ ν•„ν„°λ§μ΄μ—λκ±° κ°™λ‹¤.</p>

<h3 id="ν•„ν„°λ§">ν•„ν„°λ§</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nd">@WebFilter</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">"/targetUri/*"</span><span class="o">)</span> <span class="c1">//λΉ„μ¦μ½ api κ²½λ΅</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IPFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>	
	<span class="o">...</span>
	
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> 
	<span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> 
		<span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
			<span class="c1">//ν—μ©λμ§€ μ•λ” IPμΈμ§€ κ²€μ¦</span>
		<span class="o">}</span>

	<span class="o">...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>κ·Έλ¬λ‚ ν•„ν„°λ§μ€ <strong>μ „μ—­μ μΈ μ”μ²­</strong>μ— λ€ν•΄ μ‚¬μ©λλ” μΈμ¦μΌλ΅, μ”κµ¬μ‚¬ν•­μ²λΌ νΉμ • μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•κ³  μλ” μ—”λ“ν¬μΈνΈμ—λ§ κ²€μ¦μ„ ν•λ„λ΅ ν•κΈ° λ¶νΈν•λ‹¤. λ³΄κΈ°μ—λ„ μμμ§€ μ•λ‹¤.</p>

<p>url ν¨ν„΄μ„ ν†µν•΄ ν•„ν„°λ§μ„ κ±°λ” κ²ƒμ΄ μ•„λ‹λΌ <code class="language-plaintext highlighter-rouge">handlerMethod</code>κ°€ νΉμ • μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…μ„ κ°€μ§€κ³  μλ”μ§€ ν™•μΈν•λ” λ°©μ‹μΌλ΅ μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•  μ μκ² μΌλ‚ μ΄λ° λ°©μ‹μ„ μ‚¬μ©ν•λ©΄ μ„λ²„μ— λ“¤μ–΄μ¤λ” λ¨λ“  μ”μ²­μ΄ μ΄λ¬ν• κ²€μ¦μ„ κ±°μΉκ² λλ‹¤.</p>

<blockquote>
  <p>λ¬Έμ μ </p>
  <ul>
    <li>μ–΄λ…Έν…μ΄μ…κ³Ό ν•¨κ» μ‚¬μ©ν•κΈ° κΉλ‹¤λ΅­λ‹¤.</li>
    <li>μ”κµ¬μ‚¬ν•­μ΄ μΌλ¶€ κΈ°λ¥μ— λ€ν• μΈμ¦μ μ°¨ μ¶”κ°€μΈ κ²ƒμ— λΉ„ν•΄ ν•„ν„°λ§μ€ Spring λ²”μ„ μ΄μƒμΌλ΅ μ „μ—­μ μ΄λ‹¤.</li>
  </ul>
</blockquote>

<h3 id="μΈν„°μ…‰ν„°">μΈν„°μ…‰ν„°</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">IPFilter</span> <span class="n">ipFilter</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addInterceptors</span><span class="o">(</span><span class="nc">InterceptorRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addInterceptor</span><span class="o">(</span><span class="n">ipFilter</span><span class="o">)</span>
	        <span class="c1">//.addPathPatterns("/targetUri/*"); </span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IPFilter</span> <span class="kd">implements</span> <span class="nc">HandlerInterceptor</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">preHandle</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">handler</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">clientIP</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteAddr</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">requestURI</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">controllerClassName</span> <span class="o">=</span> <span class="n">requestURI</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"/"</span><span class="o">)[</span><span class="mi">1</span><span class="o">];</span>
		
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">controllerClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.example.controllers."</span> <span class="o">+</span> <span class="n">controllerClassName</span><span class="o">);</span>
		<span class="nc">IpBandLimiter</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">controllerClass</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">IpBandLimiter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="c1">// ν΄λμ¤μ μ–΄λ…Έν…μ΄μ… ν™•μΈ</span>

		<span class="c1">// HandlerMethod handlerMethod = (HandlerMethod) handler;</span>
		<span class="c1">// IpBandLimiter annotation = handlerMethod.getMethodAnnotation(IpBandLimiter.class); </span>
		<span class="c1">// λ©”μ„λ“μ μ–΄λ…Έν…μ΄μ… ν™•μΈ</span>
		
		<span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">String</span><span class="o">[]</span> <span class="n">allowedIPs</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">allowedIps</span><span class="o">();</span>
			<span class="c1">// IP κ²€μ¦</span>
		<span class="o">}</span>
	<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>ν•„ν„°λ§ λ‹¤μμΌλ΅λ” μΈν„°μ…‰ν„°λ¥Ό μƒκ°ν–λ‹¤. λ‹¤λ¥Έ ν”„λ΅μ νΈμ—μ„λ” νΉμ • uri ν•μ„μ μ—”λ“ν¬μΈνΈμ— μ ‘μ†ν•λ” κ²½μ° μ‚¬μ©μμ μ¶μ„ μ •λ³΄λ¥Ό μ—…λ°μ΄νΈ ν•κΈ° μ„ν•΄ μΈν„°μ…‰ν„°λ¥Ό μ‚¬μ©ν–μ—λ‹¤.</p>

<blockquote>
  <p>λ¬Έμ μ </p>
  <ul>
    <li>λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•λ©΄ ν΄λμ¤λ‚ λ©”μ„λ“μ— νΉμ • μ–΄λ…Έν…μ΄μ…μ΄ λ¶™μ–΄μλ”μ§€ ν™•μΈν•κΈ°λ” μ–΄λ µμ§€ μ•λ‹¤.</li>
    <li>νΈμ¶ν• λ©”μ„λ“μ— νΉμ • μ–΄λ…Έν…μ΄μ…μ΄ ν¬ν•¨λΌμλ”μ§€ ν™•μΈν•λ” κ²ƒλ„ μ–΄λ µμ§€ μ•λ‹¤.</li>
    <li>κ·Έλ¬λ‚ μ–΄λ–¤ μ—”λ“ν¬μΈνΈκ°€ μ–΄λ ν΄λμ¤μ— ν¬ν•¨λΌμλ”μ§€ ν™•μΈν•κΈ°λ” μ–΄λ µλ‹¤.</li>
  </ul>
</blockquote>

<p>λ¬Όλ΅  ν•΄λ‹Ή μΈν„°μ…‰ν„°κ°€ ν•„μ”ν• λ¨λ“  λ©”μ„λ“μ— μΌμΌμ΄ μ–΄λ…Έν…μ΄μ…μ„ λ¶™μΈλ‹¤λ©΄ μ„ λ¬Έμ λ¥Ό ν•΄κ²°ν•  μλ” μμΌλ‚ λ‚λ” <strong>ν΄λμ¤μ— λ¶™μ€ μ–΄λ…Έν…μ΄μ…μ΄ ν΄λμ¤ ν•μ„μ λ¨λ“  λ©”μ„λ“μ— μ μ©λκΈΈ μ›ν–λ‹¤</strong>.</p>

<h3 id="ν•„ν„°-vs-μΈν„°μ…‰ν„°">ν•„ν„° vs μΈν„°μ…‰ν„°</h3>

<p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/cc4e4452-e263-476e-be40-b07ed9d0eac7" alt="ν•„ν„°μΈν„°μ…‰ν„°" />
ν•„ν„°</p>

<ul>
  <li>Spring μ»¨ν…μ¤νΈ μ™Έλ¶€μ— μλ” web μ»¨ν…μ¤νΈμ—μ„ λ™μ‘</li>
  <li>Springλ³΄λ‹¤ ν° λ²”μ„μ μ”μ²­(κ³µν†µμ μΈ λ³΄μ•, λ΅κΉ…, μ”μ²­ μΈμ½”λ”© μ„¤μ • λ“±)μ— λ€ν•΄ μ²λ¦¬</li>
</ul>

<p>μΈν„°μ…‰ν„°</p>

<ul>
  <li>Spring μ»¨ν…μ¤νΈμ—μ„ λ™μ‘</li>
  <li>Springκ³Ό κ΄€λ ¨λ μ”μ²­(μ»¨νΈλ΅¤λ¬ νΈμ¶ μ „ν›„μ λ΅μ§ μ²λ¦¬ λ“±)μ— λ€ν•΄ μ²λ¦¬</li>
</ul>

<h3 id="aop">AOP</h3>

<p>μµμΆ…μ μΌλ΅λ” <strong>AOP</strong>λ¥Ό μ‚¬μ©ν•λ” κ²ƒμΌλ΅ κ²°μ •ν–λ‹¤. λ¬΄μ—‡λ³΄λ‹¤ μ£Όμ–΄μ§„ μ”κµ¬μ‚¬ν•­μ— λ”°λΌ κ°λ°ν•κΈ°μ— μ μ ν–κΈ° λ•λ¬Έμ΄λ‹¤.</p>

<p>μ”κµ¬μ‚¬ν•­μ€ BizCallController ν•μ„μ λ¨λ“  μ—”λ“ν¬μΈνΈλ¥Ό νƒ€κ²μΌλ΅ ν•κΈ°μ— λ‚λ” κ° λ©”μ„λ“λ§λ‹¤ μ–΄λ…Έν…μ΄μ…μ„ λ¶™μ΄κΈ° λ³΄λ‹¤λ” <blue>μ»¨νΈλ΅¤λ¬μ— λ¶™μ€ μ–΄λ…Έν…μ΄μ…μ΄ ν•μ„ λ©”μ„λ“μ— λ¨λ‘ μ μ©λκΈΈ λ°”λ¬λ‹¤.</blue></p>

<p>μΈν„°μ…‰ν„°λ¥Ό μ‚¬μ©ν•λ©΄ λ©”μ„λ“ μμ²΄μ— λ¶™μ–΄μλ” μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…μ μ΅΄μ¬ μ—¬λ¶€λ” ν™•μΈν•  μ μμΌλ‚ ν•΄λ‹Ή μ—”λ“ν¬μΈνΈκ°€ μ–΄λ–¤ ν΄λμ¤μ μ—”λ“ν¬μΈνΈμΈμ§€ μ• μ μ—†μ–΄ ν΄λμ¤μ—λ§ μ–΄λ…Έν…μ΄μ…μ„ λ¶™μ΄λ” μ‹μΌλ΅ μ‚¬μ©μ€ λ¶κ°€λ¥ν–λ‹¤.</p>

<p>κ·Έλ¬λ‚ AOPμ μ–΄λ“λ°”μ΄μ¤λ¥Ό μ‚¬μ©ν•λ©΄ μ„ λ¬Έμ λ¥Ό κΉ”λ”ν•κ² ν•΄κ²°ν•  μ μμ—λ‹¤.</p>

<div class="callout">
  <div>π“</div>
  <div>
    <strong>AOP(Aspect Oriented Programming, κ΄€μ  μ§€ν–¥ ν”„λ΅κ·Έλλ°)</strong><br />
    κ΄€μ‹¬μ‚¬λ΅λ¶€ν„° ν΅λ‹¨(κ³µν†µ) κ΄€μ‹¬μ‚¬λ¥Ό λ¶„λ¦¬ν•μ—¬ κ΄€μ‹¬μ‚¬λ¥Ό λ¨λ“ν™”ν•λ” μ†ν”„νΈμ›¨μ–΄ κ°λ° ν¨λ¬λ‹¤μ„
  </div>
</div>

<p>AOPλ” μ•„λμ™€ κ°™μ€ κ°λ…μ„ μ‚¬μ©ν•λ‹¤.</p>

<ul>
  <li><strong>κ΄€μ‹¬μ‚¬(Concern)</strong>: ν”„λ΅κ·Έλ¨μ κΈ°λ¥μ  λλ” λΉ„κΈ°λ¥μ (λ΅κΉ…, λ³΄μ•, νΈλμ­μ… κ΄€λ¦¬ λ“±) μ”κµ¬μ‚¬ν•­</li>
  <li><strong>ν΅λ‹¨ κ΄€μ‹¬μ‚¬(Cross-Cutting Concern)</strong>: μ—¬λ¬ λ¨λ“μ—μ„ κ³µν†µμΌλ΅ μ‚¬μ©λλ” κ΄€μ‹¬μ‚¬(λ΅κΉ…, μΈμ¦ λ“±)</li>
  <li>
    <p><strong>μ• μ¤ν™νΈ(Aspect)</strong>: ν΅λ‹¨ κ΄€μ‹¬μ‚¬λ¥Ό λ¨λ“ν™”ν• κ²ƒ. ν¬μΈνΈμ»·(Pointcut)κ³Ό μ–΄λ“λ°”μ΄μ¤(Advice)λ΅ κµ¬μ„±λ¨</p>

    <ul>
      <li><strong>μ΅°μΈ ν¬μΈνΈ(Join Point)</strong>: ν”„λ΅κ·Έλ¨ μ‹¤ν–‰ μ¤‘μ νΉμ • μ‹μ  (λ©”μ„λ“ νΈμ¶, μμ™Έ λ°μƒ λ“±)</li>
      <li><strong>ν¬μΈνΈμ»·(Pointcut)</strong>: νΉμ • κ·μΉ™μ΄λ‚ ν‘ν„μ‹μ„ μ‚¬μ©ν•μ—¬ μ΅°μΈ ν¬μΈνΈλ¥Ό κ²°μ •
        <ul>
          <li><code class="language-plaintext highlighter-rouge">@Pointcut("execution(...)")</code></li>
        </ul>
      </li>
      <li><a href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/advice.html"><strong>μ–΄λ“λ°”μ΄μ¤(Advice)</strong></a>: ν¬μΈνΈμ»·μ— μν•΄ μ„ νƒλ μ΅°μΈ ν¬μΈνΈμ—μ„ μ‹¤ν–‰λλ” μ½”λ“
        <ul>
          <li><code class="language-plaintext highlighter-rouge">Before</code>, <code class="language-plaintext highlighter-rouge">After</code>, <code class="language-plaintext highlighter-rouge">Around</code> λ“±</li>
        </ul>
      </li>
      <li><a href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/pointcuts.html#aop-pointcuts-designators"><strong>PointCut Designator (PCD)</strong></a>: ν΅λ‹¨ κ΄€μ‹¬μ‚¬κ°€ μ μ©λ  μ§€μ μ„ μ§€μ •ν•κΈ° μ„ν• ν‘ν„μ‹
        <ul>
          <li><code class="language-plaintext highlighter-rouge">within</code>, <code class="language-plaintext highlighter-rouge">target</code>, <code class="language-plaintext highlighter-rouge">annotation,</code> <code class="language-plaintext highlighter-rouge">@within</code>, <code class="language-plaintext highlighter-rouge">@target</code>, <code class="language-plaintext highlighter-rouge">@annotation</code> λ“±</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="2-κ°λ°">2. κ°λ°</h2>

<h3 id="μ»¤μ¤ν…€-μ–΄λ…Έν…μ΄μ…-μΈν„°νμ΄μ¤">μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ… μΈν„°νμ΄μ¤</h3>

<p>μ‚¬μ©μκ°€ μ§μ ‘ μ •μν• Annotationμ„ <strong><code class="language-plaintext highlighter-rouge">Custom Annotation</code></strong>μ΄λΌ ν•λ‹¤.</p>

<p>λ°λ€λ΅ @Overrie, @Deprecated, @SuppressWarnings λ“± SDKμ— λ‚΄μ¥λμ–΄ μλ” κΈ°λ³Έ Annotationμ€ <strong><code class="language-plaintext highlighter-rouge">Built-in Annotation</code></strong>μ΄λΌ λ¶€λ¥Έλ‹¤.</p>

<p><br /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">IpBandLimiter</span> <span class="o">{</span>
	<span class="nc">String</span><span class="o">[]</span> <span class="nf">allowedIps</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ElementType.TYPE</code>: ν΄λμ¤, μΈν„°νμ΄μ¤, μ—΄κ±°ν•(enum), μ• λ…Έν…μ΄μ… νƒ€μ…μ— μ μ©ν•  μ μλ‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">ElementType.METHOD</code>: λ©”μ†λ“μ— μ μ©ν•  μ μλ‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">RetentionPolicy.RUNTIME</code>: μ–΄λ…Έν…μ΄μ…μ μλ…μ΄ λ°νƒ€μ„κΉμ§€ μ μ§€λλ‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">allowedIps</code> μ†μ„±μ„ ν†µν•΄ String νƒ€μ…μ IPλ¥Ό λ¬Έμμ—΄ λ°°μ—΄λ΅ μ…λ ¥λ°›λ”λ‹¤.</li>
</ul>

<h3 id="aop-1">AOP</h3>

<p><em>β€μ ‘κ·Ό κ°€λ¥ν• IP μΈμ¦β€™</em>μ΄λΌλ” ν΅λ‹¨ κ΄€μ‹¬μ‚¬λ¥Ό λ¨λ“ν™”ν•μ—¬ ν•λ‚μ Aspectλ΅ λ§λ“λ ¤κ³  ν•λ‹¤.</p>

<p>μ΄λ• μ–΄λ“λ°”μ΄μ¤λ” <code class="language-plaintext highlighter-rouge">Before</code>, PCDλ” <code class="language-plaintext highlighter-rouge">annotation</code>μΌλ΅ ν•μ—¬ <strong>νΉμ • μ–΄λ…Έν…μ΄μ…μ΄ μ‹¤ν–‰λκΈ° μ „μ— μ—μ¤ν™νΈκ°€ μ‹¤ν–‰λ  μ μλ„λ΅</strong> κµ¬μƒν–λ‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IpLimiter</span> <span class="o">{</span>

	<span class="nd">@Before</span><span class="o">(</span><span class="s">"@annotation(ipBandLimiter)"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ipBandLimiter</span><span class="o">(</span><span class="nc">IpBandLimiter</span> <span class="n">ipBandLimiter</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RuntimeException</span> <span class="o">{</span>
		<span class="nc">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ServletRequestAttributes</span><span class="o">)</span><span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">()).</span><span class="na">getRequest</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">clientIp</span> <span class="o">=</span> <span class="n">requset</span><span class="o">.</span><span class="na">getRemoteAddr</span><span class="o">();</span> <span class="c1">//ν΄λΌμ΄μ–ΈνΈ IP μ¶”μ¶</span>
		<span class="nc">String</span><span class="o">[]</span> <span class="n">allowedIPs</span> <span class="o">=</span> <span class="n">ipBandLimiter</span><span class="o">.</span><span class="na">allowedIps</span><span class="o">();</span> <span class="c1">//μ–΄λ…Έν…μ΄μ…μ— μ •μλ μ ‘κ·Ό κ°€λ¥ IP λ©λ΅</span>
		
		<span class="k">if</span> <span class="o">(!</span><span class="n">isAllowedIp</span><span class="o">(</span><span class="n">clientIp</span><span class="o">,</span> <span class="n">allowedIPs</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Not allowed IP (client ip = "</span> <span class="o">+</span> <span class="n">clientIp</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="o">(</span><span class="no">NOT_ALLOWED_IP_ACCESS</span><span class="o">);</span> <span class="c1">//ν—μ©λμ§€ μ•μ€ IPλΌλ©΄ μμ™Έλ¥Ό λ°μƒμ‹ν‚¨λ‹¤.</span>
		<span class="o">}</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Allowed IP (client ip = "</span> <span class="o">+</span> <span class="n">clientIp</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isAllowedIp</span><span class="o">(</span><span class="nc">String</span> <span class="n">clientIP</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">allowedIPs</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">allowedIPs</span><span class="o">).</span><span class="na">anyMatch</span><span class="o">(</span><span class="nl">clientIP:</span><span class="o">:</span><span class="n">startsWith</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>IpLimiter Aspect</cap>
<p><br /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/v2/external/bizcall"</span><span class="o">)</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@IpBandLimiter</span><span class="o">(</span><span class="n">allowedIps</span> <span class="o">=</span> <span class="o">{</span> <span class="o">...</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BizCallCdrController</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>μ‹¤μ  IpBandLimiter μ–΄λ…Έν…μ΄μ… μ μ©</cap>
<p><br /></p>

<h4 id="λ¬Έμ -λ°μƒ">λ¬Έμ  λ°μƒ</h4>

<p>κ·Έλ¬λ‚ IpBandLimiter μ–΄λ…Έν…μ΄μ…μ΄ λ¶™μ€ ν΄λμ¤μ λ©”μ„λ“λ¥Ό μ‹¤ν–‰μ‹μΌλ„ IpLimiterκ°€ μ‹¤ν–‰λμ§€ μ•μ•λ‹¤β€¦ ν›„ν›„ <br /></p>

<p>AspectJ λ¬Έμ„λ¥Ό μ½μ–΄λ³΄λ‹ <a href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/pointcuts.html#aop-pointcuts-designators">μ•„λμ™€ κ°™μ€ μ„¤λ…</a>μ„ λ°κ²¬ν•  μ μμ—λ‹¤.</p>

<p><br /></p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">@annotation</code>: Limits matching to <strong>join points</strong> where the subject of the join point (<strong>the method</strong> being run in Spring AOP) has the given annotation.</p>
</blockquote>

<p><br /></p>

<p>λ³΄μ•„ν•λ‹ <code class="language-plaintext highlighter-rouge">@annotation</code>μ€ <strong>λ©”μ„λ“ μμ¤€μ μ–΄λ…Έν…μ΄μ…μ—μ„λ§ μ μ©</strong>λλ” κ²ƒ κ°™μ•λ‹¤.</p>

<p>μ„ μ½”λ“μ—μ„ λ‚λ” <code class="language-plaintext highlighter-rouge">@ipBandLimiter</code>λ¥Ό λ©”μ„λ“κ°€ μ•„λ‹ ν΄λμ¤μ— μ μ©ν–μΌλ‹ <red> ν΄λμ¤ μμ¤€μ μ–΄λ…Έν…μ΄μ…μ„ μ½μ§€ λ»ν•κ³  λ©”μ„λ“μ— μ–΄λ…Έν…μ΄μ…μ΄ μ΅΄μ¬ν•μ§€ μ•λ” κ²ƒμΌλ΅ νλ‹¨ν• κ²ƒ</red>μ΄λ‹¤.</p>

<p>μ‹¤μ λ΅ μ–΄λ…Έν…μ΄μ…μ„ λ©”μ„λ“ μμ¤€μΌλ΅ μ®κ²Όλ”λ‹ μ μ‘λ™λμ—λ‹¤β€¦</p>

<p><br /></p>

<p>κ·Έλ¬λ‚ λ‚λ” <strong>ν΄λμ¤μ— μ„ μ–Έλ μ–΄λ…Έν…μ΄μ…μ΄ ν•μ„ λ©”μ„λ“μ—λ„ μ μ©λκΈΈ μ›ν•λ‹¤!</strong> AspectJ λ¬Έμ„μ—λ” μ•„λμ™€ κ°™μ€ PCD λν• μ„¤λ…ν•κ³  μλ‹¤.</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">@within</code>: Limits matching to join points within types that have the given annotation (the execution of methods declared in <strong>types with the given annotation</strong> when using Spring AOP).</p>
</blockquote>

<p><br /></p>

<p><code class="language-plaintext highlighter-rouge">@within</code>μ€ μ–΄λ…Έν…μ΄μ…μ΄ μ£Όμ–΄μ§„ μ–΄λ–¤ νƒ€μ…(ν΄λμ¤) ν•μ„μ λ©”μ„λ“μ— λ€ν•΄ μ΅°μΈ ν¬μΈνΈλ¥Ό μ ν•ν•λ‹¤. μ΄λ¥Ό μ‚¬μ©ν•λ©΄ ν΄λμ¤ ν•μ„μ λ©”μ„λ“μ—λ„ ν•΄λ‹Ή ν΄λμ¤μ— μ μ©λ μ—μ¤ν™νΈκ°€ μ‹¤ν–‰λ  κ²ƒμ΄λΌ μƒκ°ν–λ‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>
	<span class="nd">@Before</span><span class="o">(</span><span class="s">"@within(ipBandLimiter)"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ipBandLimiter</span><span class="o">(</span><span class="nc">IpBandLimiter</span> <span class="n">ipBandLimiter</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">...</span>
	<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>PCD μμ • 1</cap>
<p><br /></p>

<p>μ½”λ“λ¥Ό μ„μ™€ κ°™μ΄ μμ •ν–λ”λ‹ BixCallDcrController ν•μ„μ λ©”μ„λ“λ¥Ό μ‹¤ν–‰ν•΄λ„ ipBandLimiter()κ°€ μ‹¤ν–‰λμ—λ‹¤.</p>

<p>κ·Έλ¬λ‚ μ„ μ½”λ“λ” μ΄μ  <em>λ©”μ„λ“ μμ¤€μ μ–΄λ…Έν…μ΄μ…μ„ μ½μ§€ λ»ν•  κ²ƒ</em>μ΄λ‹¤(ν΄λμ¤μ—λ” μ–΄λ…Έν…μ΄μ…μ΄ μ„ μ–Έλμ§€ μ•μ•μ§€λ§, λ©”μ„λ“μ—λ” μ„ μ–Έλ κ²½μ° μ‹¤ν–‰λμ§€ μ•μ„ κ²ƒ)</p>

<p>λ”°λΌμ„ <red>λ©”μ„λ“μ™€ ν΄λμ¤ μμ¤€ μ–΄λ””μ— μ–΄λ…Έν…μ΄μ…μ΄ μ μ©λμ–΄λ„ μ—μ¤ν™νΈκ°€ μ‹¤ν–‰λ  μ μλ„λ΅</red> μ½”λ“λ¥Ό μ•„λμ™€ κ°™μ΄ μμ •ν–λ‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>	<span class="nd">@Before</span><span class="o">(</span><span class="s">"@within(ipBandLimiter) || @annotation(ipBandLimiter)"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ipBandLimiter</span><span class="o">(</span><span class="nc">IpBandLimiter</span> <span class="n">ipBandLimiter</span><span class="o">)</span> <span class="o">{...}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>PCD μμ • 2</cap>
<p><br /></p>

<h3 id="ν΄λΌμ΄μ–ΈνΈ-ip-μ¶”μ¶">ν΄λΌμ΄μ–ΈνΈ Ip μ¶”μ¶</h3>

<p>μ΄μ  μ–΄λ…Έν…μ΄μ…μ„ ν†µν• IP μ ν• μμ²΄λ” κ°€λ¥ν•΄μ΅μΌλ‚ λ¬Έμ κ°€ μλ‹¤. μ•„λμ μ„Έμ°¨μƒμ°¨ μΈν”„λΌ μΌλ¶€λ¥Ό ν™•μΈν•΄λ³΄μ.</p>

<p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/a6452f5f-e2f2-40ac-a4f9-3d7697b6d9c4" alt="μΈν”„λΌ" />
ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ€ <strong>ALB</strong>λ¥Ό νƒ€κ³  μ„Έμ°¨μƒμ°¨ μ„λ²„λ΅ λ“¤μ–΄μ¤κ² λλ‹¤.</p>

<p>μ΄λ ‡κ² λλ©΄ ν΄λΌμ΄μ–ΈνΈ IPλ¥Ό μ¶”μ¶ν•λ”λ° λ¬Έμ κ°€ μƒκΈ΄λ‹¤β€¦</p>

<h4 id="x-forwarded-for">X-Forwarded-For</h4>

<div class="callout">
  <div>π“</div>
  <div>
    <strong>X-Forwarded-For(XFF)</strong><br />
    HTTP ν”„λ΅μ‹λ‚ λ΅λ“ λ°Έλ°μ„λ¥Ό ν†µν•΄ μ›Ή μ„λ²„μ— μ ‘μ†ν•λ” ν΄λΌμ΄μ–ΈνΈμ μ› IP μ£Όμ†λ¥Ό μ‹λ³„ν•λ” μ‚¬μ‹¤μƒμ ν‘μ¤€ ν—¤λ”
  </div>
</div>

<p>μΌλ°μ μΌλ΅ ν΄λΌμ΄μ–ΈνΈμ IPκ°’μ€ <code class="language-plaintext highlighter-rouge">request.getRemoteAddr()</code>λ¥Ό ν†µν•΄ κ°€μ Έμ¬ μ μκ² μ§€λ§ μ¤‘κ°„μ— ν”„λ΅μ‹λ‚ λ΅λ“ λ°Έλ°μ„λ¥Ό κ±°μΉλ” κ²½μ°λ” λ‹¤λ¥΄λ‹¤.</p>

<p>ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ μ¤‘κ°„μ—μ„ νΈλν”½μ΄ ν”„λ΅μ‹λ‚ λ΅λ“ λ°Έλ°μ„λ¥Ό κ±°μΉλ” κ²½μ° μ„λ²„ μ ‘κ·Ό λ΅κ·Έμ—λ” ν΄λΌμ΄μ–ΈνΈμ IPκ°€ μ•„λ‹λΌ μ§μ „μ— κ±°μ³μ¨ νΈλν”½μ΄λ‚ λ΅λ“ λ°Έλ°μ„μ μ£Όμ†κ°€ λ‚¨κΈ° λ•λ¬Έμ΄λ‹¤.</p>

<p>λ”°λΌμ„ ν΄λΌμ΄μ–ΈνΈμ μ›λ IPλ¥Ό ν™•μΈν•κΈ° μ„ν•΄μ„λ” <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/X-Forwarded-For">X-Forwarded-For ν—¤λ”</a>λ¥Ό ν™•μΈν•΄μ•Όν•λ‹¤.</p>

<p><br /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="no">X</span><span class="o">-</span><span class="nc">Forwarded</span><span class="o">-</span><span class="nl">For:</span> <span class="o">&lt;</span><span class="n">client</span><span class="o">&gt;,</span> <span class="o">&lt;</span><span class="n">proxy1</span><span class="o">&gt;,</span> <span class="o">&lt;</span><span class="n">proxy2</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ν΄λΌμ΄μ–ΈνΈμ μ”μ²­μ΄ λ΅λ“ λ²¨λ°μ„ Aλ¥Ό μ§€λ‚ ν›„ <strong>X-Forwarded-Forμ κ°€μ¥ μ²«λ²μ§Έ κ°’μ€ Client Ipκ°€ λλ‹¤.</strong></p>

<p>μ΄ν›„ λ‹¤λ¥Έ ν”„λ΅μ‹λ‚ λ΅λ“ λ°Έλ°μ„ Bλ¥Ό μ§€λ‚κ² λλ‹¤λ©΄ λ΅λ“ λ²¨λ°μ„ Bμ ipκ°’μ΄ XFF ν—¤λ” λ’¤μ— μ¶”κ°€λ  κ²ƒμ΄λ‹¤.</p>

<h4 id="μ½”λ“">μ½”λ“</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>	<span class="nd">@Before</span><span class="o">(</span><span class="s">"@within(ipBandLimiter) || @annotation(ipBandLimiter)"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ipBandLimiter</span><span class="o">(</span><span class="nc">IpBandLimiter</span> <span class="n">ipBandLimiter</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RuntimeException</span> <span class="o">{</span>
		<span class="nc">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ServletRequestAttributes</span><span class="o">)</span><span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">()).</span><span class="na">getRequest</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">clientIp</span> <span class="o">=</span> <span class="n">extractClientIp</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
		<span class="o">...</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">extractClientIp</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">xffIps</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"X-Forwarded-For"</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">xffIps</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">xffIps</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">)[</span><span class="mi">0</span><span class="o">];</span>
		<span class="o">}</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="o">(</span><span class="no">NOT_ALLOWED_IP_ACCESS</span><span class="o">);</span>
	<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>XFF ν—¤λ”μ κ°€μ¥ μ²«λ²μ§Έ κ°’(clientIp) κ°€μ Έμ¤λ„λ΅ μ½”λ“λ¥Ό μ‘μ„±ν–λ‹¤. λ§μΌ XFFν—¤λ”κ°€ μ΅΄μ¬ν•μ§€ μ•λ”λ‹¤λ©΄ λ΅λ“ λ²¨λ°μ„λ¥Ό κ±°μ³μ¨ μ”μ²­μ΄ μ•„λ‹λ―€λ΅, μ •μƒμ μΈ μ”μ²­μΌλ΅ νλ‹¨ν•μ§€ μ•μ•„ μμ™Έλ¥Ό λ°μƒμ‹ν‚¨λ‹¤.</p>

<h3 id="ν…μ¤νΈ-μ½”λ“">ν…μ¤νΈ μ½”λ“</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="nd">@SpringBootTest</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IpLimiterTest</span> <span class="o">{</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">BizCallCdrController</span> <span class="n">bizCallCDrController</span><span class="o">;</span>
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">StoreRepository</span> <span class="n">storeRepository</span><span class="o">;</span>
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">StoreTestHelper</span> <span class="n">storeTestHelper</span><span class="o">;</span>

	<span class="nd">@Test</span>
	<span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"ν—μ©λμ§€ μ•μ€ ipλ” νƒ€κ²μ— μ ‘κ·Όν•  μ μ—†λ‹¤."</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="n">ν—μ©λμ§€_μ•μ€_ipλ”_νƒ€κ²μ—_μ ‘κ·Όν• _μ_μ—†λ‹¤</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="c1">//given</span>
		<span class="nc">MockHttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockHttpServletRequest</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">notAllowedIp</span> <span class="o">=</span> <span class="s">"197.2.72.178"</span><span class="o">;</span>
		<span class="n">request</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"X-Forwarded-For"</span><span class="o">,</span> <span class="n">notAllowedIp</span><span class="o">);</span>
		<span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">setRequestAttributes</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServletRequestAttributes</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
		<span class="nc">Store</span> <span class="n">store</span> <span class="o">=</span> <span class="n">storeTestHelper</span><span class="o">.</span><span class="na">makeStaticRunningStore</span><span class="o">();</span>
		<span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">store</span><span class="o">.</span><span class="na">getOwner</span><span class="o">());</span>
		<span class="n">storeRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">store</span><span class="o">);</span>

		<span class="c1">// when &amp; then</span>
		<span class="n">assertThrows</span><span class="o">(</span><span class="nc">ApplicationException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
			<span class="o">()</span> <span class="o">-&gt;</span> <span class="n">bizCallCDrController</span><span class="o">.</span><span class="na">cdrCallInboundInit</span><span class="o">(</span><span class="s">"01"</span><span class="o">,</span> <span class="s">"20200202020202"</span><span class="o">,</span> <span class="s">"000-0000-0000"</span><span class="o">,</span> <span class="n">store</span><span class="o">.</span><span class="na">getTel</span><span class="o">(),</span>
				<span class="s">"111-1111-1111"</span><span class="o">,</span> <span class="s">"memo"</span><span class="o">,</span> <span class="s">"memo2"</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"ν—μ©λ ipλ” νƒ€κ²μ— μ ‘κ·Όν•  μ μλ‹¤."</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="n">ν—μ©λ_ipλ”_νƒ€κ²μ—_μ ‘κ·Όν• _μ_μλ‹¤</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="c1">//given</span>
		<span class="nc">MockHttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockHttpServletRequest</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">allowedIp</span> <span class="o">=</span> <span class="s">"210.109.108.133"</span><span class="o">;</span>
		<span class="n">request</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"X-Forwarded-For"</span><span class="o">,</span> <span class="n">allowedIp</span><span class="o">);</span>
		<span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">setRequestAttributes</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServletRequestAttributes</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
		<span class="nc">Store</span> <span class="n">store</span> <span class="o">=</span> <span class="n">storeTestHelper</span><span class="o">.</span><span class="na">makeStaticRunningStore</span><span class="o">();</span>
		<span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">store</span><span class="o">.</span><span class="na">getOwner</span><span class="o">());</span>
		<span class="n">storeRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">store</span><span class="o">);</span>

		<span class="c1">//when &amp; then</span>
		<span class="n">assertDoesNotThrow</span><span class="o">(</span>
			<span class="o">()</span> <span class="o">-&gt;</span> <span class="n">bizCallCDrController</span><span class="o">.</span><span class="na">cdrCallInboundInit</span><span class="o">(</span><span class="s">"01"</span><span class="o">,</span> <span class="s">"20200202020202"</span><span class="o">,</span> <span class="s">"000-0000-0000"</span><span class="o">,</span> <span class="n">store</span><span class="o">.</span><span class="na">getTel</span><span class="o">(),</span>
				<span class="s">"111-1111-1111"</span><span class="o">,</span> <span class="s">"memo"</span><span class="o">,</span> <span class="s">"memo2"</span><span class="o">));</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>κ°„λ‹¨ν• ν…μ¤νΈ μ½”λ“λ¥Ό μ‘μ„±ν–λ‹¤.</p>

<h2 id="3-μ¶”κ°€-κ³ λ ¤-μ‚¬ν•­">3. μ¶”κ°€ κ³ λ ¤ μ‚¬ν•­</h2>

<h3 id="xff-ν—¤λ”-μ΅°μ‘">XFF ν—¤λ” μ΅°μ‘</h3>

<p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/4ddc01d7-d904-4fae-a0e4-f0ae89c10dec" alt="λ¦¬λ·°" /></p>

<p>ν”„λ΅ νΈ+λ°±μ—”λ“ μ‘μ—…μ„ ν•μ‹λ” μ‘μ—…μλ¶„μ—κ² μ„μ™€ κ°™μ€ λ¦¬λ·°κ°€ λ‹¬λ Έλ‹¤.</p>

<p>μ΄λ΄μκ°€.. μ½”λ“λ¥Ό μ‘μ„±ν• λ•λ” μƒκ°ν•΄λ³Έμ  μ—†λ λ¬Έμ μ€λ‹¤. μ‹¤λ¬΄ κ°λ°μλ“¤μ€ λ‹¤μ–‘ν• κ°€λ¥μ„±μ„ λ– μ¬λ¦΄μ μκµ¬λ‚ μ‹¶μ—λ‹¤.</p>

<p>λ¦¬λ·°κ°€ λ‹¬λ¦° ν›„ ν΄λΌμ΄μ–ΈνΈμ XFF ν—¤λ” μ΅°μ‘ κ°€λ¥μ„±μ— λ€ν•΄ μ•μ•„λ΄¤λ‹¤.</p>

<h4 id="append">Append</h4>

<p>AWS λ¬Έμ„μ—μ„ ALB μ„¤μ •μ— κ΄€ν• λ¬Έμ„λ¥Ό μ°Ύμ„ μ μμ—λ‹¤.</p>

<p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/3b16436d-6b05-4c64-86c4-5ddf10466743" alt="image" /></p>
<cap>https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/application-load-balancers.html</cap>
<p><br /></p>

<p>λ΅λ“ λ²¨λ°μ„μ <code class="language-plaintext highlighter-rouge">xff_header_processing.mode</code>λ” κΈ°λ³Έμ μΌλ΅ <code class="language-plaintext highlighter-rouge">Append</code>λ΅ μ„¤μ •λμ–΄ μλ‹¤.</p>

<p>λ§μΌ ν΄λΌμ΄μ–ΈνΈκ°€ μ”μ²­μ„ μ΅°μ‘ν•μ—¬ μ”μ²­μ— μ΅°μ‘λ IPλ¥Ό κ°€μ§€λ” XFFν—¤λ”λ¥Ό μ¶”κ°€ν•΄ μ „μ†΅ν•λ‹¤λ©΄ λ΅λ“ λ²¨λ°μ„λ” <red>μ΅°μ‘λ IPλ¥Ό μ μ§€ν• μ±„ XFF ν—¤λ” λ§μ§€λ§‰μ— client Ipλ¥Ό λ§λ¶™μ΄κ² λ  κ²ƒ</red>μ΄λ‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">Preserve</code>λ” μ”μ²­μ— λ‹΄κΈ΄ XFFν—¤λ”μ— κ°’μ„ μ¶”κ°€ν•μ§€ μ•κ³  κ·Έλ€λ΅ μ μ§€ν•λ” μ„¤μ •μ΄κ³  <code class="language-plaintext highlighter-rouge">Remove</code>λ” μ•„μ μ”μ²­μ—μ„ XFFν—¤λ”λ¥Ό  μ κ±°ν•΄λ²„λ¦¬λ” μ„¤μ •μ΄λ‹¤. XFFν—¤λ”μ κ°’μ„ μ•„μ κµμ²΄ν•λ” μ„¤μ •μ€ μ΅΄μ¬ν•μ§€ μ•λ” λ“― ν•λ‹¤.</p>

<p>μ΄λ ‡κ² λλ©΄ λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤. μ‚¬μ©μκ°€ XFFν—¤λ”μ— κ°’μ„ μ¶”κ°€ν•΄μ„ μ „μ†΅ν•λ©΄ μ„λ²„λ” <strong>μ§„μ§ Client Ipκ°€  XFF ν—¤λ”μ μ–΄λ μ„μΉμ— μ΅΄μ¬ν•λ”μ§€ μ• μ μ—†λ‹¤</strong>λ” μ μ΄λ‹¤.</p>

<h4 id="set_real_ip_from"><strong>set_real_ip_from</strong></h4>

<p>μ„ λ¬Έμ λ” <a href="https://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from">nginx μ„¤μ •</a>μ„ ν†µν•΄ ν•΄κ²°ν•  μ μλ‹¤.</p>

<blockquote>
  <p>set_real_ip_from</p>
  <ul>
    <li>Defines trusted addresses that are known to send correct replacement addresses</li>
    <li>μ¬λ°”λ¥Έ μ£Όμ†λ¥Ό λ³΄λ‚΄λ” κ²ƒμΌλ΅ μ•λ ¤μ§„ μ‹ λΆ° κ°€λ¥ν• μ£Όμ†λ¥Ό μ •μν•λ‹¤. <br /></li>
  </ul>
</blockquote>

<blockquote>
  <p>real_ip_recursive</p>
  <ul>
    <li>If recursive search is enabled, the original client address that matches one of the trusted addresses is replaced by the last non-trusted address sent in the request header field.</li>
    <li>λ§μ•½ μ„¤μ •μ΄ μΌμ Έμλ‹¤λ©΄, μ‹ λΆ°κ°€λ¥ν• μ£Όμ†μ™€ μΌμΉν•λ” μ›λ³Έ ν΄λΌμ΄μ–ΈνΈ μ£Όμ†λ” μ”μ²­ ν—¤λ”μ— μ „μ†΅λ κ°€μ¥ λ§μ§€λ§‰μ λΉ„μ‹ λΆ° μ£Όμ†λ΅ κµμ²΄λλ‹¤.</li>
  </ul>
</blockquote>

<p>μ†”μ§ν λ¬Έμ„λ§ λ΄μ„λ” μ΄ν•΄κ°€ μ–΄λ ¤μ› λ‹¤. <a href="https://letsmakemyselfprogrammer.tistory.com/99">ν•΄λ‹Ή λΈ”λ΅κ·Έ κΈ€</a>μ΄ λ§μ€ λ„μ›€μ΄ λμ—λ‹¤.</p>

<p><br /></p>

<p>λ¬Έμ μƒν™©μ„ κ°€μ •ν•μ—¬ μ„ μ„¤μ •μ— λ€ν•΄ μ„¤λ…μ„ ν•΄λ³΄λ ¤ ν•λ‹¤. ν΄λΌμ΄μ–ΈνΈκ°€ μ„Έμ°¨μƒμ°¨ μ„λ²„μ— μ•„λμ™€ κ°™μ€ <em>μ΅°μ‘λ μ”μ²­μ„ λ³΄λ‚΄λ” μƒν™©</em>μ„ κ°€μ •ν•λ‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="na">X-Forwarded-For</span><span class="pi">:</span> <span class="s">&lt;λΉ„μ¦μ½ IP&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>κ·Έλ ‡λ‹¤λ©΄ λ΅λ“ λ²¨λ°μ„λ¥Ό κ±°μ³ nginxμ— λ„λ‹¬ν• μ”μ²­μ€ Append μ„¤μ •μ— μν•΄ μ•„λμ™€ κ°™μ΄ λ°”λ€” κ²ƒμ΄λ‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="na">X-Forwarded-For</span><span class="pi">:</span> <span class="s">&lt;λΉ„μ¦μ½ IP&gt; &lt;μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IP&gt; &lt;μ‚¬μ©ν• λ΅λ“ λ²¨λ°μ„ IP&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>nginx μ„¤μ •μ΄ λμ–΄μμ§€ μ•λ” κ²½μ° μ„λ²„λ” XFF ν—¤λ”μ κ°€μ¥ μ²«λ²μ§Έ κ°’μΈ <strong>&lt;λΉ„μ¦μ½ IP&gt;λ¥Ό ν΄λΌμ΄μ–ΈνΈ IPλ΅ μΈμ‹</strong>ν•κ³ , ν•΄λ‹Ή μ”μ²­μ΄ λΉ„μ¦μ½μ—μ„ μ¨ κ²ƒμ΄λΌ νλ‹¨ν•λ©° μ„λ²„μ— μ ‘κ·Όμ‹ν‚¬ κ²ƒμ΄λ‹¤.</p>

<p><br /></p>

<p>μ„μ™€ λ™μΌν• μƒν™©μ—μ„, μ΄λ²μ—λ” μ•„λμ™€ κ°™μ΄ nginxκ°€ μ„¤μ •λμ–΄μλ‹¤ κ°€μ •ν•μ.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="s">set_real_ip_from &lt;μ‚¬μ©ν•λ” λ΅λ“ λ²¨λ°μ„ IP&gt;</span>
<span class="s">set_real_ip_from &lt;μ‚¬μ©ν•λ” ν”„λ΅μ‹ IP&gt;</span>
<span class="s">real_ip_recursive on;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>nginx μ„¤μ •</cap>
<p><br /></p>

<p>λ΅λ“ λ²¨λ°μ„λ¥Ό κ±°μ³ nginxμ— λ„λ‹¬ν• ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ€ μ΄μ „ μƒν™©κ³Ό λ™μΌν•λ‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="na">X-Forwarded-For</span><span class="pi">:</span> <span class="s">&lt;λΉ„μ¦μ½ IP&gt; &lt;μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IP&gt; &lt;μ‚¬μ©ν• λ΅λ“ λ²¨λ°μ„ IP&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>nginxμ— λ”°λ΅ μ„¤μ •μ΄ λμ–΄μμ§€ μ•μ„ λ•λ” κ°€μ¥ μ•μ— μλ” &lt;λΉ„μ¦μ½ IP&gt;λ¥Ό ν΄λΌμ΄μ–ΈνΈ IPλ΅ μΈμ‹ν–μ§€λ§ μ΄λ²μ—λ” λ‹¤λ¥΄λ‹¤.</p>

<p>&lt;μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IP&gt;λ” <code class="language-plaintext highlighter-rouge">set_real_ip_from</code>μ— μ •μλ μ‹ λΆ° κ°€λ¥ν• μ£Όμ†κ°€ μ•„λ‹λ‹¤.</p>

<p>λ”°λΌμ„ <code class="language-plaintext highlighter-rouge">real_ip_recursive</code> μ— μν•΄ μ‹ λΆ° κ°€λ¥ν• μ£Όμ†λ΅ μ •μλ <strong>&lt;μ‚¬μ©ν• λ΅λ“ λ²¨λ°μ„ IP&gt; μ•μ— μλ”  &lt;μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IP&gt;λ¥Ό μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IPλ΅ μΈμ‹</strong>ν•λ‹¤.</p>

<p><br /></p>

<p>κ·Έλ¬λ‚ μ„ μ„¤μ •μ„ μ•„μ§ μ μ©μ‹ν‚¤μ§„ μ•μ•λ‹¤ ^^;</p>

<p>λΉ„μ¦μ½ IP μ„μ΅° μμ²΄κ°€ μΉλ…μ μΈ λ³΄μ• λ¬Έμ λ¥Ό λ°μƒμ‹ν‚¤κΈ° λ³΄λ‹¤λ” μ‚¬μ¥λ‹μ΄ μΆ€ μ§μ¦λ‚λ” μ •λ„κ°€ μ „λ¶€μ΄κΈ° λ•λ¬Έμ— μ—¬κΈ°μ— μ‹κ°„μ„ μ“°κΈ° λ³΄λ‹¤λ” λ” κΈ‰ν• μ„λΉ„μ¤ κ°λ°μ„ λ¨Όμ € ν•κΈ°λ΅ ν–λ‹¤.</p>

<h3 id="slient-fail">Slient fail?</h3>

<p>μ¶”κ°€μ μΌλ΅ κ³ λ ¤ν•΄λ³Ό μ‚¬ν•­μ΄ ν•λ‚ λ” μλ‹¤.</p>

<p>μ§€κΈμ€ ν—μ©λμ§€ μ•μ€ IPμ—μ„ μ ‘κ·Όν•  μ‹ <code class="language-plaintext highlighter-rouge">NOT_ALLOWED_IP_ACCESS</code> μμ™Έλ¥Ό λ°ν™ν•λ”λ°, μ΄λ ‡κ² ν•΄μ»¤μ—κ² μ§μ ‘μ μΌλ΅ μμ™Έ λ°μƒ μ—¬λ¶€λ¥Ό λ³΄μ—¬μ£Όλ” κ±΄ μΆ‹μ§€ μ•λ‹¤κ³  ν•λ‹¤.</p>

<p>λ”°λΌμ„ ν•΄μ»¤μ μ”μ²­μ„ κ±°λ¶€ν•  μ‹μ—λ” μ‹¤μ λ΅λ” μ”μ²­μ„ κ±°λ¶€ν•λ ν΄λΌμ΄μ–ΈνΈ μƒμ—μ„λ” μ”μ²­μ΄ ν—μ©λ κ²ƒμ²λΌ λ„κ²¨μ£Όμ–΄μ•Ό ν•λ‹¤λ”λ° μ΄κ²ƒμ— λ€ν• μ •ν™•ν• λ…μΉ­μ„ λ¨λ¥΄κ² λ‹¤ (κ²€μƒ‰ν•΄λ³΄μ•μ„λ• κ°€μ¥ μ μ‚¬ν•΄λ³΄μ΄λ”λ° slient failμ΄μ—λ‹¤.)</p>

<p><br /></p>

<hr />

<blockquote>
  <p>λ°°μ΄ μ : AOPλ” μ•„μ§ μ•μ•„μ•Ό ν•  λ¶€λ¶„μ΄ λ§μ€ κ²ƒ κ°™λ‹¤. ν† λΉ„μ μ¤ν”„λ§μ—μ„ AOPμ— λ€ν• λ¶€λ¶„μ„ μƒλ‹Ήν λ‘κ»κ² λ‹¤λ£¨λλ°(β€¦) κ·Έκ±Έ μ½μ–΄λ³΄λ©° κ³µλ¶€ν•κ³  ν•λ² μ •λ¦¬ν•λ” κ²ƒλ„ κ΄μ°®μ„ κ²ƒ κ°™λ‹¤.</p>
</blockquote>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2024-06-15">15 Jun 2024</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#μ„Έμ°¨μƒμ°¨">μ„Έμ°¨μƒμ°¨</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/tags#Backend">#Backend</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#Spring">#Spring</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#μ„Έμ°¨μƒμ°¨">#μ„Έμ°¨μƒμ°¨</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="//ect1/"> &laquo; λΈ”λ΅κ·Έ μ •μ²΄ μ¤‘</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="//rabbitmq2/">μ„Έμ°¨μƒμ°¨ λΉ„μ¦μ½ μ„λΉ„μ¤ κ°λ° (2) -RabbitMQ TTL, DLX, Retry μ μ© &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <script src="https://utteranc.es/client.js"
        repo="lcqff/blog_comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


    
</div>

<!-- Categories Jumbotron
================================================== -->
<!-- 
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">β†’</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#Jekyll">Jekyll (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#tutorial">tutorial (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#flutter">flutter (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Javascript">Javascript (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#React">React (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#KakaoTecCampus">KakaoTecCampus (17)</a>
                
                    <a class="mt-1 mb-1" href="/categories#λΈ”λ΅κ·Έ_μ—…λ°μ΄νΈ">λΈ”λ΅κ·Έ_μ—…λ°μ΄νΈ (7)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Algorithm">Algorithm (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#CS">CS (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Spring">Spring (5)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Works">Works (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#JPA">JPA (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Java">Java (5)</a>
                
                    <a class="mt-1 mb-1" href="/categories#μ¤λ¥κΈ°λ΅μ¥">μ¤λ¥κΈ°λ΅μ¥ (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#BDD">BDD (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Keeper">Keeper (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#DooRe">DooRe (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Infra">Infra (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#μ„Έμ°¨μƒμ°¨">μ„Έμ°¨μƒμ°¨ (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#μΌμƒ">μΌμƒ (2)</a>
                
            
            
		</div>
	</div>
</div> -->

<div class="jumbotron fortags">
	<div class="d-flex h-100 justify-content-center">
		<div class="col-12 py-3">
            <div class="category-container">
                <div class="category-item">
                    <div class="parent_cat" style="font-weight: bold;">
                        <a href="/index.html">
                             μ „μ²΄ κΈ€
                             <span>63</span>
                        </a>
                    </div>
                </div>
                
                <!-- μΉ΄ν…κ³ λ¦¬ λ©λ΅μ„ κ°€λ΅λ΅ λ°°μΉ -->
                <div class="category-item">
                    <div class="parent_cat">CS</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#CS">
                                    CS
                                    <span>2</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Algorithm">
                                    Algorithm
                                    <span>2</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="category-item">
                    <div class="parent_cat">BackEnd</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#Keeper">
                                    Keeper
                                    <span>2</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#DooRe">
                                    DooRe
                                    <span>4</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#μ„Έμ°¨μƒμ°¨">
                                    μ„Έμ°¨μƒμ°¨
                                    <span>3</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Infra">
                                    Infra
                                    <span>1</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Spring">
                                    Spring
                                    <span>5</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Java">
                                    Java
                                    <span>5</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#JPA">
                                    JPA
                                    <span>3</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#μ¤λ¥κΈ°λ΅μ¥">
                                    μ¤λ¥κΈ°λ΅μ¥
                                    <span>1</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="category-item">
                    <div class="parent_cat">BDD</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#BDD">
                                    BDD
                                    <span>1</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="category-item">
                    <div class="parent_cat">FrontEnd</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#Javascript">
                                    Javascript
                                    <span>1</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#React">
                                    React
                                    <span>1</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#KakaoTecCampus">
                                    KakaoTecCampus
                                    <span>17</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#flutter">
                                    flutter
                                    <span>3</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Works">
                                    Works
                                    <span>1</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="category-item">
                    <div class="parent_cat">κΈ°νƒ€</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#λΈ”λ΅κ·Έ_μ—…λ°μ΄νΈ">
                                    λΈ”λ΅κ·Έ_μ—…λ°μ΄νΈ
                                    <span>7</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#μΌμƒ">
                                    μΌμƒ
                                    <span>2</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>


<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright Β© 2024 Pam Tree 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 

<!-- 
<script id="dsq-count-scr" src="//.disqus.com/count.js"></script>
 -->

</body>
</html>
