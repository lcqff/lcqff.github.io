<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>특정 API의 IP 대역 제한(AOP, 커스텀 어노테이션, XFF) | Pam Tree</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>특정 API의 IP 대역 제한(AOP, 커스텀 어노테이션, XFF) | Pam Tree</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="특정 API의 IP 대역 제한(AOP, 커스텀 어노테이션, XFF)" />
<meta name="author" content="pam" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="팜의 백엔드 이것저것 놀이터" />
<meta property="og:description" content="팜의 백엔드 이것저것 놀이터" />
<link rel="canonical" href="http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" />
<meta property="og:url" content="http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" />
<meta property="og:site_name" content="Pam Tree" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-15T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="특정 API의 IP 대역 제한(AOP, 커스텀 어노테이션, XFF)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"pam"},"dateModified":"2024-06-15T00:00:00+09:00","datePublished":"2024-06-15T00:00:00+09:00","description":"팜의 백엔드 이것저것 놀이터","headline":"특정 API의 IP 대역 제한(AOP, 커스텀 어노테이션, XFF)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.png"},"name":"pam"},"url":"http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logo.png" alt="Pam Tree">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="/index.html"> My Resume</a>
                </li>

                <!-- <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-wordpress/"><i class="fab fa-wordpress-simple"></i> WP Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-ghost/"><i class="fab fa-snapchat-ghost"></i> Ghost Version</a>
                </li> -->

                <li class="nav-item">
                <a target="_blank" class="nav-link" href=""><i class="fab fa-github"></i> My Github</a>
                </li>

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">Pam Tree</h1>
    <p class="lead">
        팜의 백엔드 이것저것 놀이터
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=특정 API의 IP 대역 제한(AOP, 커스텀 어노테이션, XFF)&url=http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/Ip%EB%8C%80%EC%97%AD%EC%A0%9C%ED%95%9C/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="/assets/images/manulGaming.jpg" alt="Pam">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="https://www.wowthemes.net">Pam</a><a target="_blank" href="" class="btn follow">Follow</a>
                        <span class="author-description">Author of Mediumish, a Bootstrap Medium styled template available for WordPress, HTML, Ghost and Jekyll. You are currently previewing Jekyll template demo.</span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">특정 API의 IP 대역 제한(AOP, 커스텀 어노테이션, XFF)</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/48dd5ed0-2a07-42a1-97eb-607611c37976" alt="이슈" /></p>

<h2 id="0-개요">0. 개요</h2>

<p>저번 <a href="https://lcqff.github.io/%EC%84%B8%EC%B0%A8%EC%83%88%EC%B0%A8/2024/06/10/rabbitmq1.html">RabbitMQ 게시글</a>의 비즈콜 기능과 관련된 이슈이다.</p>

<p>손님이 비즈콜을 통해 매장에 전화를 하면 비즈콜은 서버에 CDR 정보를 전달해주며 CDR API를 실행시킨다.</p>

<p>세차새차에서는 이 CDR API를 통해 매장의 테블랫에 고객의 정보가 포함된 팝업창이 자동으로 생성되도록 처리하고 있다.</p>

<p>그러나 비즈콜에선 해당 CDR API에 대한 별도의 인증 절차를 제공해주지 않아 서버에서 직접 비즈콜 관련 API에 대한 접근을 제한하기로 했다.</p>

<p>요구사항은 아래와 같다.</p>

<ul>
  <li><strong>비즈콜 IP 대역에 포함되는 IP를 가진 클라이언트만</strong> BixCallDcrController 하위의 모든 엔트포인트에 접근할 수 있도록 한다.</li>
  <li>서버에 들어오는 모든 요청이 아니라 특정 API에서만 인증절차를 거치도록 한다.</li>
  <li>비즈콜 관련 API에만 사용되는것이 아니라 범용적으로 사용 가능하도록 <strong>어노테이션 형태</strong>로 개발한다.</li>
</ul>

<h2 id="1-고려한-방법들">1. 고려한 방법들</h2>

<p>커스텀 어노테이션을 사용하는 건 이미 결정된 사항이고, 어떤 방식을 사용해 인증 절차를 거칠지에 대해 고민해봐야 했다.</p>

<p>고려한 방식으로는 아래 세가지가 있다.</p>

<ul>
  <li>필터링 사용</li>
  <li>인터셉터 사용</li>
  <li>AOP 사용</li>
</ul>

<p>IP 필터링에 대해 구글링을 해보았을때 가장 많이 보인 방식이 필터링이었던거 같다.</p>

<h3 id="필터링">필터링</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nd">@WebFilter</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">"/targetUri/*"</span><span class="o">)</span> <span class="c1">//비즈콜 api 경로</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IPFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>	
	<span class="o">...</span>
	
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> 
	<span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> 
		<span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
			<span class="c1">//허용되지 않는 IP인지 검증</span>
		<span class="o">}</span>

	<span class="o">...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>그러나 필터링은 <strong>전역적인 요청</strong>에 대해 사용되는 인증으로, 요구사항처럼 특정 어노테이션을 사용하고 있는 엔드포인트에만 검증을 하도록 하기 불편하다. 보기에도 예쁘지 않다.</p>

<p>url 패턴을 통해 필터링을 거는 것이 아니라 <code class="language-plaintext highlighter-rouge">handlerMethod</code>가 특정 커스텀 어노테이션을 가지고 있는지 확인하는 방식으로 어노테이션을 사용할 순 있겠으나 이런 방식을 사용하면 서버에 들어오는 모든 요청이 이러한 검증을 거치게 된다.</p>

<blockquote>
  <p>문제점</p>
  <ul>
    <li>어노테이션과 함께 사용하기 까다롭다.</li>
    <li>요구사항이 일부 기능에 대한 인증절차 추가인 것에 비해 필터링은 Spring 범위 이상으로 전역적이다.</li>
  </ul>
</blockquote>

<h3 id="인터셉터">인터셉터</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">IPFilter</span> <span class="n">ipFilter</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addInterceptors</span><span class="o">(</span><span class="nc">InterceptorRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addInterceptor</span><span class="o">(</span><span class="n">ipFilter</span><span class="o">)</span>
	        <span class="c1">//.addPathPatterns("/targetUri/*"); </span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IPFilter</span> <span class="kd">implements</span> <span class="nc">HandlerInterceptor</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">preHandle</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">handler</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">clientIP</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteAddr</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">requestURI</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">controllerClassName</span> <span class="o">=</span> <span class="n">requestURI</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"/"</span><span class="o">)[</span><span class="mi">1</span><span class="o">];</span>
		
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">controllerClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.example.controllers."</span> <span class="o">+</span> <span class="n">controllerClassName</span><span class="o">);</span>
		<span class="nc">IpBandLimiter</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">controllerClass</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">IpBandLimiter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="c1">// 클래스의 어노테이션 확인</span>

		<span class="c1">// HandlerMethod handlerMethod = (HandlerMethod) handler;</span>
		<span class="c1">// IpBandLimiter annotation = handlerMethod.getMethodAnnotation(IpBandLimiter.class); </span>
		<span class="c1">// 메서드의 어노테이션 확인</span>
		
		<span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">String</span><span class="o">[]</span> <span class="n">allowedIPs</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">allowedIps</span><span class="o">();</span>
			<span class="c1">// IP 검증</span>
		<span class="o">}</span>
	<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>필터링 다음으로는 인터셉터를 생각했다. 다른 프로젝트에서는 특정 uri 하위의 엔드포인트에 접속하는 경우 사용자의 출석 정보를 업데이트 하기 위해 인터셉터를 사용했었다.</p>

<blockquote>
  <p>문제점</p>
  <ul>
    <li>리플렉션을 사용하면 클래스나 메서드에 특정 어노테이션이 붙어있는지 확인하기는 어렵지 않다.</li>
    <li>호출한 메서드에 특정 어노테이션이 포함돼있는지 확인하는 것도 어렵지 않다.</li>
    <li>그러나 어떤 엔드포인트가 어느 클래스에 포함돼있는지 확인하기는 어렵다.</li>
  </ul>
</blockquote>

<p>물론 해당 인터셉터가 필요한 모든 메서드에 일일이 어노테이션을 붙인다면 위 문제를 해결할 수는 있으나 나는 <strong>클래스에 붙은 어노테이션이 클래스 하위의 모든 메서드에 적용되길 원했다</strong>.</p>

<h3 id="필터-vs-인터셉터">필터 vs 인터셉터</h3>

<p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/cc4e4452-e263-476e-be40-b07ed9d0eac7" alt="필터인터셉터" />
필터</p>

<ul>
  <li>Spring 컨텍스트 외부에 있는 web 컨텍스트에서 동작</li>
  <li>Spring보다 큰 범위의 요청(공통적인 보안, 로깅, 요청 인코딩 설정 등)에 대해 처리</li>
</ul>

<p>인터셉터</p>

<ul>
  <li>Spring 컨텍스트에서 동작</li>
  <li>Spring과 관련된 요청(컨트롤러 호출 전후의 로직 처리 등)에 대해 처리</li>
</ul>

<h3 id="aop">AOP</h3>

<p>최종적으로는 <strong>AOP</strong>를 사용하는 것으로 결정했다. 무엇보다 주어진 요구사항에 따라 개발하기에 적절했기 때문이다.</p>

<p>요구사항은 BizCallController 하위의 모든 엔드포인트를 타겟으로 하기에 나는 각 메서드마다 어노테이션을 붙이기 보다는 <blue>컨트롤러에 붙은 어노테이션이 하위 메서드에 모두 적용되길 바랬다.</blue></p>

<p>인터셉터를 사용하면 메서드 자체에 붙어있는 커스텀 어노테이션의 존재 여부는 확인할 수 있으나 해당 엔드포인트가 어떤 클래스의 엔드포인트인지 알 수 없어 클래스에만 어노테이션을 붙이는 식으로 사용은 불가능했다.</p>

<p>그러나 AOP의 어드바이스를 사용하면 위 문제를 깔끔하게 해결할 수 있었다.</p>

<div class="callout">
  <div>📝</div>
  <div>
    <strong>AOP(Aspect Oriented Programming, 관점 지향 프로그래밍)</strong><br />
    관심사로부터 횡단(공통) 관심사를 분리하여 관심사를 모듈화하는 소프트웨어 개발 패러다임
  </div>
</div>

<p>AOP는 아래와 같은 개념을 사용한다.</p>

<ul>
  <li><strong>관심사(Concern)</strong>: 프로그램의 기능적 또는 비기능적(로깅, 보안, 트랜잭션 관리 등) 요구사항</li>
  <li><strong>횡단 관심사(Cross-Cutting Concern)</strong>: 여러 모듈에서 공통으로 사용되는 관심사(로깅, 인증 등)</li>
  <li>
    <p><strong>애스펙트(Aspect)</strong>: 횡단 관심사를 모듈화한 것. 포인트컷(Pointcut)과 어드바이스(Advice)로 구성됨</p>

    <ul>
      <li><strong>조인 포인트(Join Point)</strong>: 프로그램 실행 중의 특정 시점 (메서드 호출, 예외 발생 등)</li>
      <li><strong>포인트컷(Pointcut)</strong>: 특정 규칙이나 표현식을 사용하여 조인 포인트를 결정
        <ul>
          <li><code class="language-plaintext highlighter-rouge">@Pointcut("execution(...)")</code></li>
        </ul>
      </li>
      <li><a href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/advice.html"><strong>어드바이스(Advice)</strong></a>: 포인트컷에 의해 선택된 조인 포인트에서 실행되는 코드
        <ul>
          <li><code class="language-plaintext highlighter-rouge">Before</code>, <code class="language-plaintext highlighter-rouge">After</code>, <code class="language-plaintext highlighter-rouge">Around</code> 등</li>
        </ul>
      </li>
      <li><a href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/pointcuts.html#aop-pointcuts-designators"><strong>PointCut Designator (PCD)</strong></a>: 횡단 관심사가 적용될 지점을 지정하기 위한 표현식
        <ul>
          <li><code class="language-plaintext highlighter-rouge">within</code>, <code class="language-plaintext highlighter-rouge">target</code>, <code class="language-plaintext highlighter-rouge">annotation,</code> <code class="language-plaintext highlighter-rouge">@within</code>, <code class="language-plaintext highlighter-rouge">@target</code>, <code class="language-plaintext highlighter-rouge">@annotation</code> 등</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="2-개발">2. 개발</h2>

<h3 id="커스텀-어노테이션-인터페이스">커스텀 어노테이션 인터페이스</h3>

<p>사용자가 직접 정의한 Annotation을 <strong><code class="language-plaintext highlighter-rouge">Custom Annotation</code></strong>이라 한다.</p>

<p>반대로 @Overrie, @Deprecated, @SuppressWarnings 등 SDK에 내장되어 있는 기본 Annotation은 <strong><code class="language-plaintext highlighter-rouge">Built-in Annotation</code></strong>이라 부른다.</p>

<p><br /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">IpBandLimiter</span> <span class="o">{</span>
	<span class="nc">String</span><span class="o">[]</span> <span class="nf">allowedIps</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ElementType.TYPE</code>: 클래스, 인터페이스, 열거형(enum), 애노테이션 타입에 적용할 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">ElementType.METHOD</code>: 메소드에 적용할 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">RetentionPolicy.RUNTIME</code>: 어노테이션의 수명이 런타임까지 유지된다.</li>
  <li><code class="language-plaintext highlighter-rouge">allowedIps</code> 속성을 통해 String 타입의 IP를 문자열 배열로 입력받는다.</li>
</ul>

<h3 id="aop-1">AOP</h3>

<p><em>‘접근 가능한 IP 인증’</em>이라는 횡단 관심사를 모듈화하여 하나의 Aspect로 만드려고 한다.</p>

<p>이때 어드바이스는 <code class="language-plaintext highlighter-rouge">Before</code>, PCD는 <code class="language-plaintext highlighter-rouge">annotation</code>으로 하여 <strong>특정 어노테이션이 실행되기 전에 에스펙트가 실행될 수 있도록</strong> 구상했다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IpLimiter</span> <span class="o">{</span>

	<span class="nd">@Before</span><span class="o">(</span><span class="s">"@annotation(ipBandLimiter)"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ipBandLimiter</span><span class="o">(</span><span class="nc">IpBandLimiter</span> <span class="n">ipBandLimiter</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RuntimeException</span> <span class="o">{</span>
		<span class="nc">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ServletRequestAttributes</span><span class="o">)</span><span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">()).</span><span class="na">getRequest</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">clientIp</span> <span class="o">=</span> <span class="n">requset</span><span class="o">.</span><span class="na">getRemoteAddr</span><span class="o">();</span> <span class="c1">//클라이언트 IP 추출</span>
		<span class="nc">String</span><span class="o">[]</span> <span class="n">allowedIPs</span> <span class="o">=</span> <span class="n">ipBandLimiter</span><span class="o">.</span><span class="na">allowedIps</span><span class="o">();</span> <span class="c1">//어노테이션에 정의된 접근 가능 IP 목록</span>
		
		<span class="k">if</span> <span class="o">(!</span><span class="n">isAllowedIp</span><span class="o">(</span><span class="n">clientIp</span><span class="o">,</span> <span class="n">allowedIPs</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Not allowed IP (client ip = "</span> <span class="o">+</span> <span class="n">clientIp</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="o">(</span><span class="no">NOT_ALLOWED_IP_ACCESS</span><span class="o">);</span> <span class="c1">//허용되지 않은 IP라면 예외를 발생시킨다.</span>
		<span class="o">}</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Allowed IP (client ip = "</span> <span class="o">+</span> <span class="n">clientIp</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isAllowedIp</span><span class="o">(</span><span class="nc">String</span> <span class="n">clientIP</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">allowedIPs</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">allowedIPs</span><span class="o">).</span><span class="na">anyMatch</span><span class="o">(</span><span class="nl">clientIP:</span><span class="o">:</span><span class="n">startsWith</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>IpLimiter Aspect</cap>
<p><br /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/v2/external/bizcall"</span><span class="o">)</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@IpBandLimiter</span><span class="o">(</span><span class="n">allowedIps</span> <span class="o">=</span> <span class="o">{</span> <span class="o">...</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BizCallCdrController</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>실제 IpBandLimiter 어노테이션 적용</cap>
<p><br /></p>

<h4 id="문제-발생">문제 발생</h4>

<p>그러나 IpBandLimiter 어노테이션이 붙은 클래스의 메서드를 실행시켜도 IpLimiter가 실행되지 않았다… 후후 <br /></p>

<p>AspectJ 문서를 읽어보니 <a href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/pointcuts.html#aop-pointcuts-designators">아래와 같은 설명</a>을 발견할 수 있었다.</p>

<p><br /></p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">@annotation</code>: Limits matching to <strong>join points</strong> where the subject of the join point (<strong>the method</strong> being run in Spring AOP) has the given annotation.</p>
</blockquote>

<p><br /></p>

<p>보아하니 <code class="language-plaintext highlighter-rouge">@annotation</code>은 <strong>메서드 수준의 어노테이션에서만 적용</strong>되는 것 같았다.</p>

<p>위 코드에서 나는 <code class="language-plaintext highlighter-rouge">@ipBandLimiter</code>를 메서드가 아닌 클래스에 적용했으니 <red> 클래스 수준의 어노테이션을 읽지 못하고 메서드에 어노테이션이 존재하지 않는 것으로 판단한 것</red>이다.</p>

<p>실제로 어노테이션을 메서드 수준으로 옮겼더니 잘 작동되었다…</p>

<p><br /></p>

<p>그러나 나는 <strong>클래스에 선언된 어노테이션이 하위 메서드에도 적용되길 원한다!</strong> AspectJ 문서에는 아래와 같은 PCD 또한 설명하고 있다.</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">@within</code>: Limits matching to join points within types that have the given annotation (the execution of methods declared in <strong>types with the given annotation</strong> when using Spring AOP).</p>
</blockquote>

<p><br /></p>

<p><code class="language-plaintext highlighter-rouge">@within</code>은 어노테이션이 주어진 어떤 타입(클래스) 하위의 메서드에 대해 조인 포인트를 제한한다. 이를 사용하면 클래스 하위의 메서드에도 해당 클래스에 적용된 에스펙트가 실행될 것이라 생각했다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>
	<span class="nd">@Before</span><span class="o">(</span><span class="s">"@within(ipBandLimiter)"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ipBandLimiter</span><span class="o">(</span><span class="nc">IpBandLimiter</span> <span class="n">ipBandLimiter</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">...</span>
	<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>PCD 수정 1</cap>
<p><br /></p>

<p>코드를 위와 같이 수정했더니 BixCallDcrController 하위의 메서드를 실행해도 ipBandLimiter()가 실행되었다.</p>

<p>그러나 위 코드는 이제 <em>메서드 수준의 어노테이션을 읽지 못할 것</em>이다(클래스에는 어노테이션이 선언되지 않았지만, 메서드에는 선언된 경우 실행되지 않을 것)</p>

<p>따라서 <red>메서드와 클래스 수준 어디에 어노테이션이 적용되어도 에스펙트가 실행될 수 있도록</red> 코드를 아래와 같이 수정했다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>	<span class="nd">@Before</span><span class="o">(</span><span class="s">"@within(ipBandLimiter) || @annotation(ipBandLimiter)"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ipBandLimiter</span><span class="o">(</span><span class="nc">IpBandLimiter</span> <span class="n">ipBandLimiter</span><span class="o">)</span> <span class="o">{...}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>PCD 수정 2</cap>
<p><br /></p>

<h3 id="클라이언트-ip-추출">클라이언트 Ip 추출</h3>

<p>이제 어노테이션을 통한 IP 제한 자체는 가능해졌으나 문제가 있다. 아래의 세차새차 인프라 일부를 확인해보자.</p>

<p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/a6452f5f-e2f2-40ac-a4f9-3d7697b6d9c4" alt="인프라" />
클라이언트 요청은 <strong>ALB</strong>를 타고 세차새차 서버로 들어오게 된다.</p>

<p>이렇게 되면 클라이언트 IP를 추출하는데 문제가 생긴다…</p>

<h4 id="x-forwarded-for">X-Forwarded-For</h4>

<div class="callout">
  <div>📝</div>
  <div>
    <strong>X-Forwarded-For(XFF)</strong><br />
    HTTP 프록시나 로드 밸런서를 통해 웹 서버에 접속하는 클라이언트의 원 IP 주소를 식별하는 사실상의 표준 헤더
  </div>
</div>

<p>일반적으로 클라이언트의 IP값은 <code class="language-plaintext highlighter-rouge">request.getRemoteAddr()</code>를 통해 가져올 수 있겠지만 중간에 프록시나 로드 밸런서를 거치는 경우는 다르다.</p>

<p>클라이언트와 서버 중간에서 트래픽이 프록시나 로드 밸런서를 거치는 경우 서버 접근 로그에는 클라이언트의 IP가 아니라 직전에 거쳐온 트래픽이나 로드 밸런서의 주소가 남기 때문이다.</p>

<p>따라서 클라이언트의 원래 IP를 확인하기 위해서는 <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/X-Forwarded-For">X-Forwarded-For 헤더</a>를 확인해야한다.</p>

<p><br /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="no">X</span><span class="o">-</span><span class="nc">Forwarded</span><span class="o">-</span><span class="nl">For:</span> <span class="o">&lt;</span><span class="n">client</span><span class="o">&gt;,</span> <span class="o">&lt;</span><span class="n">proxy1</span><span class="o">&gt;,</span> <span class="o">&lt;</span><span class="n">proxy2</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>클라이언트의 요청이 로드 벨런서 A를 지난 후 <strong>X-Forwarded-For의 가장 첫번째 값은 Client Ip가 된다.</strong></p>

<p>이후 다른 프록시나 로드 밸런서 B를 지나게 된다면 로드 벨런서 B의 ip값이 XFF 헤더 뒤에 추가될 것이다.</p>

<h4 id="코드">코드</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>	<span class="nd">@Before</span><span class="o">(</span><span class="s">"@within(ipBandLimiter) || @annotation(ipBandLimiter)"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ipBandLimiter</span><span class="o">(</span><span class="nc">IpBandLimiter</span> <span class="n">ipBandLimiter</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RuntimeException</span> <span class="o">{</span>
		<span class="nc">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ServletRequestAttributes</span><span class="o">)</span><span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">()).</span><span class="na">getRequest</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">clientIp</span> <span class="o">=</span> <span class="n">extractClientIp</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
		<span class="o">...</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">extractClientIp</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">xffIps</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"X-Forwarded-For"</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">xffIps</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">xffIps</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">)[</span><span class="mi">0</span><span class="o">];</span>
		<span class="o">}</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="o">(</span><span class="no">NOT_ALLOWED_IP_ACCESS</span><span class="o">);</span>
	<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>XFF 헤더의 가장 첫번째 값(clientIp) 가져오도록 코드를 작성했다. 만일 XFF헤더가 존재하지 않는다면 로드 벨런서를 거쳐온 요청이 아니므로, 정상적인 요청으로 판단하지 않아 예외를 발생시킨다.</p>

<h3 id="테스트-코드">테스트 코드</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="nd">@SpringBootTest</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IpLimiterTest</span> <span class="o">{</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">BizCallCdrController</span> <span class="n">bizCallCDrController</span><span class="o">;</span>
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">StoreRepository</span> <span class="n">storeRepository</span><span class="o">;</span>
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">StoreTestHelper</span> <span class="n">storeTestHelper</span><span class="o">;</span>

	<span class="nd">@Test</span>
	<span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"허용되지 않은 ip는 타겟에 접근할 수 없다."</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="n">허용되지_않은_ip는_타겟에_접근할_수_없다</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="c1">//given</span>
		<span class="nc">MockHttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockHttpServletRequest</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">notAllowedIp</span> <span class="o">=</span> <span class="s">"197.2.72.178"</span><span class="o">;</span>
		<span class="n">request</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"X-Forwarded-For"</span><span class="o">,</span> <span class="n">notAllowedIp</span><span class="o">);</span>
		<span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">setRequestAttributes</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServletRequestAttributes</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
		<span class="nc">Store</span> <span class="n">store</span> <span class="o">=</span> <span class="n">storeTestHelper</span><span class="o">.</span><span class="na">makeStaticRunningStore</span><span class="o">();</span>
		<span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">store</span><span class="o">.</span><span class="na">getOwner</span><span class="o">());</span>
		<span class="n">storeRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">store</span><span class="o">);</span>

		<span class="c1">// when &amp; then</span>
		<span class="n">assertThrows</span><span class="o">(</span><span class="nc">ApplicationException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
			<span class="o">()</span> <span class="o">-&gt;</span> <span class="n">bizCallCDrController</span><span class="o">.</span><span class="na">cdrCallInboundInit</span><span class="o">(</span><span class="s">"01"</span><span class="o">,</span> <span class="s">"20200202020202"</span><span class="o">,</span> <span class="s">"000-0000-0000"</span><span class="o">,</span> <span class="n">store</span><span class="o">.</span><span class="na">getTel</span><span class="o">(),</span>
				<span class="s">"111-1111-1111"</span><span class="o">,</span> <span class="s">"memo"</span><span class="o">,</span> <span class="s">"memo2"</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"허용된 ip는 타겟에 접근할 수 있다."</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="n">허용된_ip는_타겟에_접근할_수_있다</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="c1">//given</span>
		<span class="nc">MockHttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockHttpServletRequest</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">allowedIp</span> <span class="o">=</span> <span class="s">"210.109.108.133"</span><span class="o">;</span>
		<span class="n">request</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"X-Forwarded-For"</span><span class="o">,</span> <span class="n">allowedIp</span><span class="o">);</span>
		<span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">setRequestAttributes</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServletRequestAttributes</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
		<span class="nc">Store</span> <span class="n">store</span> <span class="o">=</span> <span class="n">storeTestHelper</span><span class="o">.</span><span class="na">makeStaticRunningStore</span><span class="o">();</span>
		<span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">store</span><span class="o">.</span><span class="na">getOwner</span><span class="o">());</span>
		<span class="n">storeRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">store</span><span class="o">);</span>

		<span class="c1">//when &amp; then</span>
		<span class="n">assertDoesNotThrow</span><span class="o">(</span>
			<span class="o">()</span> <span class="o">-&gt;</span> <span class="n">bizCallCDrController</span><span class="o">.</span><span class="na">cdrCallInboundInit</span><span class="o">(</span><span class="s">"01"</span><span class="o">,</span> <span class="s">"20200202020202"</span><span class="o">,</span> <span class="s">"000-0000-0000"</span><span class="o">,</span> <span class="n">store</span><span class="o">.</span><span class="na">getTel</span><span class="o">(),</span>
				<span class="s">"111-1111-1111"</span><span class="o">,</span> <span class="s">"memo"</span><span class="o">,</span> <span class="s">"memo2"</span><span class="o">));</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>간단한 테스트 코드를 작성했다.</p>

<h2 id="3-추가-고려-사항">3. 추가 고려 사항</h2>

<h3 id="xff-헤더-조작">XFF 헤더 조작</h3>

<p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/4ddc01d7-d904-4fae-a0e4-f0ae89c10dec" alt="리뷰" /></p>

<p>프론트+백엔드 작업을 하시는 작업자분에게 위와 같은 리뷰가 달렸다.</p>

<p>이럴수가.. 코드를 작성할때는 생각해본적 없던 문제였다. 실무 개발자들은 다양한 가능성을 떠올릴수 있구나 싶었다.</p>

<p>리뷰가 달린 후 클라이언트의 XFF 헤더 조작 가능성에 대해 알아봤다.</p>

<h4 id="append">Append</h4>

<p>AWS 문서에서 ALB 설정에 관한 문서를 찾을 수 있었다.</p>

<p><img src="https://github.com/lcqff/lcqff.github.io/assets/71930280/3b16436d-6b05-4c64-86c4-5ddf10466743" alt="image" /></p>
<cap>https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/application-load-balancers.html</cap>
<p><br /></p>

<p>로드 벨런서의 <code class="language-plaintext highlighter-rouge">xff_header_processing.mode</code>는 기본적으로 <code class="language-plaintext highlighter-rouge">Append</code>로 설정되어 있다.</p>

<p>만일 클라이언트가 요청을 조작하여 요청에 조작된 IP를 가지는 XFF헤더를 추가해 전송한다면 로드 벨런서는 <red>조작된 IP를 유지한 채 XFF 헤더 마지막에 client Ip를 덧붙이게 될 것</red>이다.</p>

<p><code class="language-plaintext highlighter-rouge">Preserve</code>는 요청에 담긴 XFF헤더에 값을 추가하지 않고 그대로 유지하는 설정이고 <code class="language-plaintext highlighter-rouge">Remove</code>는 아예 요청에서 XFF헤더를  제거해버리는 설정이다. XFF헤더의 값을 아예 교체하는 설정은 존재하지 않는 듯 하다.</p>

<p>이렇게 되면 문제가 발생할 수 있다. 사용자가 XFF헤더에 값을 추가해서 전송하면 서버는 <strong>진짜 Client Ip가  XFF 헤더의 어느 위치에 존재하는지 알 수 없다</strong>는 점이다.</p>

<h4 id="set_real_ip_from"><strong>set_real_ip_from</strong></h4>

<p>위 문제는 <a href="https://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from">nginx 설정</a>을 통해 해결할 수 있다.</p>

<blockquote>
  <p>set_real_ip_from</p>
  <ul>
    <li>Defines trusted addresses that are known to send correct replacement addresses</li>
    <li>올바른 주소를 보내는 것으로 알려진 신뢰 가능한 주소를 정의한다. <br /></li>
  </ul>
</blockquote>

<blockquote>
  <p>real_ip_recursive</p>
  <ul>
    <li>If recursive search is enabled, the original client address that matches one of the trusted addresses is replaced by the last non-trusted address sent in the request header field.</li>
    <li>만약 설정이 켜져있다면, 신뢰가능한 주소와 일치하는 원본 클라이언트 주소는 요청 헤더에 전송된 가장 마지막의 비신뢰 주소로 교체된다.</li>
  </ul>
</blockquote>

<p>솔직히 문서만 봐서는 이해가 어려웠다. <a href="https://letsmakemyselfprogrammer.tistory.com/99">해당 블로그 글</a>이 많은 도움이 되었다.</p>

<p><br /></p>

<p>문제상황을 가정하여 위 설정에 대해 설명을 해보려 한다. 클라이언트가 세차새차 서버에 아래와 같은 <em>조작된 요청을 보내는 상황</em>을 가정한다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="na">X-Forwarded-For</span><span class="pi">:</span> <span class="s">&lt;비즈콜 IP&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>그렇다면 로드 벨런서를 거쳐 nginx에 도달한 요청은 Append 설정에 의해 아래와 같이 바뀔 것이다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="na">X-Forwarded-For</span><span class="pi">:</span> <span class="s">&lt;비즈콜 IP&gt; &lt;실제 클라이언트 IP&gt; &lt;사용한 로드 벨런서 IP&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>nginx 설정이 되어있지 않는 경우 서버는 XFF 헤더의 가장 첫번째 값인 <strong>&lt;비즈콜 IP&gt;를 클라이언트 IP로 인식</strong>하고, 해당 요청이 비즈콜에서 온 것이라 판단하며 서버에 접근시킬 것이다.</p>

<p><br /></p>

<p>위와 동일한 상황에서, 이번에는 아래와 같이 nginx가 설정되어있다 가정하자.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="s">set_real_ip_from &lt;사용하는 로드 벨런서 IP&gt;</span>
<span class="s">set_real_ip_from &lt;사용하는 프록시 IP&gt;</span>
<span class="s">real_ip_recursive on;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<cap>nginx 설정</cap>
<p><br /></p>

<p>로드 벨런서를 거쳐 nginx에 도달한 클라이언트 요청은 이전 상황과 동일하다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="na">X-Forwarded-For</span><span class="pi">:</span> <span class="s">&lt;비즈콜 IP&gt; &lt;실제 클라이언트 IP&gt; &lt;사용한 로드 벨런서 IP&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>nginx에 따로 설정이 되어있지 않을 때는 가장 앞에 있는 &lt;비즈콜 IP&gt;를 클라이언트 IP로 인식했지만 이번에는 다르다.</p>

<p>&lt;실제 클라이언트 IP&gt;는 <code class="language-plaintext highlighter-rouge">set_real_ip_from</code>에 정의된 신뢰 가능한 주소가 아니다.</p>

<p>따라서 <code class="language-plaintext highlighter-rouge">real_ip_recursive</code> 에 의해 신뢰 가능한 주소로 정의된 <strong>&lt;사용한 로드 벨런서 IP&gt; 앞에 있는  &lt;실제 클라이언트 IP&gt;를 실제 클라이언트 IP로 인식</strong>한다.</p>

<p><br /></p>

<p>그러나 위 설정을 아직 적용시키진 않았다 ^^;</p>

<p>비즈콜 IP 위조 자체가 치명적인 보안 문제를 발생시키기 보다는 사장님이 좀 짜증나는 정도가 전부이기 때문에 여기에 시간을 쓰기 보다는 더 급한 서비스 개발을 먼저 하기로 했다.</p>

<h3 id="slient-fail">Slient fail?</h3>

<p>추가적으로 고려해볼 사항이 하나 더 있다.</p>

<p>지금은 허용되지 않은 IP에서 접근할 시 <code class="language-plaintext highlighter-rouge">NOT_ALLOWED_IP_ACCESS</code> 예외를 반환하는데, 이렇게 해커에게 직접적으로 예외 발생 여부를 보여주는 건 좋지 않다고 한다.</p>

<p>따라서 해커의 요청을 거부할 시에는 실제로는 요청을 거부하되 클라이언트 상에서는 요청이 허용된 것처럼 넘겨주어야 한다는데 이것에 대한 정확한 명칭을 모르겠다 (검색해보았을때 가장 유사해보이는데 slient fail이었다.)</p>

<p><br /></p>

<hr />

<blockquote>
  <p>배운 점: AOP는 아직 알아야 할 부분이 많은 것 같다. 토비의 스프링에서 AOP에 대한 부분을 상당히 두껍게 다루던데(…) 그걸 읽어보며 공부하고 한번 정리하는 것도 괜찮을 것 같다.</p>
</blockquote>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2024-06-15">15 Jun 2024</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#세차새차">세차새차</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/tags#Backend">#Backend</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#Spring">#Spring</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#세차새차">#세차새차</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="//ect1/"> &laquo; 블로그 정체 중</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="//rabbitmq2/">세차새차 비즈콜 서비스 개발 (2) -RabbitMQ TTL, DLX, Retry 적용 &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <script src="https://utteranc.es/client.js"
        repo="lcqff/blog_comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


    
</div>

<!-- Categories Jumbotron
================================================== -->
<!-- 
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#Jekyll">Jekyll (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#tutorial">tutorial (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#flutter">flutter (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Javascript">Javascript (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#React">React (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#KakaoTecCampus">KakaoTecCampus (17)</a>
                
                    <a class="mt-1 mb-1" href="/categories#블로그_업데이트">블로그_업데이트 (7)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Algorithm">Algorithm (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#CS">CS (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Spring">Spring (5)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Works">Works (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#JPA">JPA (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Java">Java (5)</a>
                
                    <a class="mt-1 mb-1" href="/categories#오류기록장">오류기록장 (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#BDD">BDD (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Keeper">Keeper (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#DooRe">DooRe (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Infra">Infra (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#세차새차">세차새차 (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#일상">일상 (2)</a>
                
            
            
		</div>
	</div>
</div> -->

<div class="jumbotron fortags">
	<div class="d-flex h-100 justify-content-center">
		<div class="col-12 py-3">
            <div class="category-container">
                <div class="category-item">
                    <div class="parent_cat" style="font-weight: bold;">
                        <a href="/index.html">
                             전체 글
                             <span>63</span>
                        </a>
                    </div>
                </div>
                
                <!-- 카테고리 목록을 가로로 배치 -->
                <div class="category-item">
                    <div class="parent_cat">CS</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#CS">
                                    CS
                                    <span>2</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Algorithm">
                                    Algorithm
                                    <span>2</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="category-item">
                    <div class="parent_cat">BackEnd</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#Keeper">
                                    Keeper
                                    <span>2</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#DooRe">
                                    DooRe
                                    <span>4</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#세차새차">
                                    세차새차
                                    <span>3</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Infra">
                                    Infra
                                    <span>1</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Spring">
                                    Spring
                                    <span>5</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Java">
                                    Java
                                    <span>5</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#JPA">
                                    JPA
                                    <span>3</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#오류기록장">
                                    오류기록장
                                    <span>1</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="category-item">
                    <div class="parent_cat">BDD</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#BDD">
                                    BDD
                                    <span>1</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="category-item">
                    <div class="parent_cat">FrontEnd</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#Javascript">
                                    Javascript
                                    <span>1</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#React">
                                    React
                                    <span>1</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#KakaoTecCampus">
                                    KakaoTecCampus
                                    <span>17</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#flutter">
                                    flutter
                                    <span>3</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#Works">
                                    Works
                                    <span>1</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="category-item">
                    <div class="parent_cat">기타</div>
                    <div class="common-list">
                        <div>
                            
                            <div>
                                <a href="/categories#블로그_업데이트">
                                    블로그_업데이트
                                    <span>7</span>
                                </a>
                            </div>
                            
                            <div>
                                <a href="/categories#일상">
                                    일상
                                    <span>2</span>
                                </a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>


<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2024 Pam Tree 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 

<!-- 
<script id="dsq-count-scr" src="//.disqus.com/count.js"></script>
 -->

</body>
</html>
